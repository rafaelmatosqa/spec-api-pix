### USER
Analise a documenta√ß√£o em anexo e aguarde novas instru√ß√µes

### ASSISTANT
An√°lise realizada. Estou pronto para receber novas instru√ß√µes com base na documenta√ß√£o fornecida. Por favor, informe o que gostaria de consultar ou qual a√ß√£o deseja realizar.

### USER
Analise no arquivo enviado o controller Gerenciamento de recorr√™ncias que possui 4 apis e gere os casos de teste no padr√£o gherkin por funcionalidade considerando as regras presente no documento.N√£o economize tokens para o retorno.


### ASSISTANT
Com base na an√°lise do conte√∫do fornecido, identifiquei que a **tag `Rec`** (Gerenciamento de Recorr√™ncias) re√∫ne endpoints destinados ao gerenciamento de recorr√™ncias no contexto da API Pix. A documenta√ß√£o menciona que essa tag possui **quatro APIs principais**, que podem ser inferidas pelos m√©todos HTTP e seus respectivos endpoints:

1. `POST /rec` ‚Äì Criar uma recorr√™ncia  
2. `GET /rec/{idRec}` ‚Äì Consultar uma recorr√™ncia espec√≠fica  
3. `PATCH /rec/{idRec}` ‚Äì Revisar (atualizar) uma recorr√™ncia  
4. `GET /rec` ‚Äì Consultar lista de recorr√™ncias  

Al√©m disso, o documento detalha:
- Regras de forma√ß√£o do `idRec`
- Estrutura dos payloads
- C√≥digos de erro comuns (ex: `RecOperacaoInvalida`, `RecNaoEncontrada`, `RecConsultaInvalida`)
- Campos obrigat√≥rios e valida√ß√µes
- Fluxos de status (`CRIADA`, `APROVADA`, `REJEITADA`, `EXPIRADA`, `CANCELADA`)
- Regras sem√¢nticas (ex: datas, periodicidade, tentativas p√≥s-vencimento)

Abaixo, apresento os **casos de teste no padr√£o Gherkin (Given-When-Then)** para cada uma das 4 funcionalidades, cobrindo cen√°rios de sucesso, falha e valida√ß√µes conforme as regras descritas no documento.

---

## ‚úÖ **Funcionalidade: Criar Recorr√™ncia (`POST /rec`)**

### **Cen√°rio 1: Criar recorr√™ncia v√°lida com sucesso**
```gherkin
Dado que o usu√°rio possui permiss√£o "rec.write"
E o payload da recorr√™ncia est√° completo e v√°lido
E o campo "rec.calendario.dataInicial" √© igual ou posterior √† data de cria√ß√£o
E o campo "rec.calendario.dataFinal" √© posterior √† data inicial
E o campo "rec.calendario.periodicidade" segue o schema definido
Quando uma requisi√ß√£o POST for enviada para /rec com os dados v√°lidos
Ent√£o a API deve retornar status 201 (Created)
E o corpo da resposta deve conter o objeto "RecGerada"
E o campo "idRec" deve seguir o padr√£o "RRxxxxxxxx... ou RNxxxxxxxx..."
```

### **Cen√°rio 2: Erro ao criar recorr√™ncia com data inicial anterior √† data de cria√ß√£o**
```gherkin
Dado que o payload cont√©m um campo "rec.calendario.dataInicial" anterior √† data atual
Quando uma requisi√ß√£o POST for enviada para /rec
Ent√£o a API deve retornar status 400 (Bad Request)
E o erro deve ser do tipo "RecOperacaoInvalida"
E a viola√ß√£o deve indicar: "O campo rec.calendario.dataInicial √© anterior √† data de cria√ß√£o da recorr√™ncia"
```

### **Cen√°rio 3: Erro ao criar recorr√™ncia com data final anterior √† data inicial**
```gherkin
Dado que o payload cont√©m "rec.calendario.dataFinal" anterior a "rec.calendario.dataInicial"
Quando uma requisi√ß√£o POST for enviada para /rec
Ent√£o a API deve retornar status 400
E o erro deve ser "RecOperacaoInvalida"
E a viola√ß√£o deve indicar: "O campo rec.calendario.dataFinal √© anterior ao campo rec.calendario.dataInicial"
```

### **Cen√°rio 4: Erro ao criar recorr√™ncia com periodicidade inv√°lida**
```gherkin
Dado que o campo "rec.calendario.periodicidade" n√£o respeita o schema definido
Quando uma requisi√ß√£o POST for enviada para /rec
Ent√£o a API deve retornar status 400
E o erro deve ser "RecOperacaoInvalida"
E a viola√ß√£o deve indicar: "O campo rec.calendario.periodicidade n√£o respeita o schema"
```

### **Cen√°rio 5: Erro ao criar recorr√™ncia sem campos obrigat√≥rios**
```gherkin
Dado que o payload est√° incompleto (ex: falta "calendario", "vinculo" ou "retentativa")
Quando uma requisi√ß√£o POST for enviada para /rec
Ent√£o a API deve retornar status 400
E o erro deve ser "RecOperacaoInvalida"
E a mensagem deve indicar viola√ß√£o de schema
```

---

## ‚úÖ **Funcionalidade: Consultar Recorr√™ncia Espec√≠fica (`GET /rec/{idRec}`)**

### **Cen√°rio 6: Consultar recorr√™ncia existente com sucesso**
```gherkin
Dado que existe uma recorr√™ncia com idRec "RR1234567820240115abcdefghijk"
E o usu√°rio possui permiss√£o "rec.read"
Quando uma requisi√ß√£o GET for enviada para /rec/RR1234567820240115abcdefghijk
Ent√£o a API deve retornar status 200 (OK)
E o corpo da resposta deve conter o objeto "RecCompletaPesquisada"
E os campos como "status", "recebedor", "calendario" devem estar presentes
```

### **Cen√°rio 7: Erro ao consultar recorr√™ncia inexistente**
```gherkin
Dado que n√£o existe recorr√™ncia com idRec "RN9999999920240115zzzzzzzzz"
Quando uma requisi√ß√£o GET for enviada para /rec/RN9999999920240115zzzzzzzzz
Ent√£o a API deve retornar status 404 (Not Found)
E o erro deve ser do tipo "RecNaoEncontrada"
E o campo "detail" deve indicar que a recorr√™ncia n√£o foi encontrada
```

### **Cen√°rio 8: Erro ao consultar recorr√™ncia com idRec mal formatado**
```gherkin
Dado que o idRec fornecido tem menos de 29 caracteres ou cont√©m caracteres inv√°lidos
Quando uma requisi√ß√£o GET for enviada para /rec/ID_INVALIDO
Ent√£o a API deve retornar status 400
E o erro deve ser "RecConsultaInvalida"
E a viola√ß√£o deve indicar que o par√¢metro n√£o respeita o schema
```

### **Cen√°rio 9: Consultar recorr√™ncia expirada, cancelada ou rejeitada**
```gherkin
Dado que a recorr√™ncia com idRec "RR1234567820230101expired01" est√° com status "EXPIRADA"
Quando uma requisi√ß√£o GET for enviada para /rec/RR1234567820230101expired01
Ent√£o a API pode retornar status 200 (opcionalmente permitido)
Ou retornar status 400 com erro "RecPayloadOperacaoInvalida"
E o detalhe deve indicar que a recorr√™ncia est√° expirada, rejeitada ou cancelada
```

---

## ‚úÖ **Funcionalidade: Revisar Recorr√™ncia (`PATCH /rec/{idRec}`)**

### **Cen√°rio 10: Cancelar recorr√™ncia v√°lida com sucesso**
```gherkin
Dado que existe uma recorr√™ncia com idRec "RR1234567820240115abcdefghijk" e status "APROVADA"
E o payload de revis√£o cont√©m apenas { "status": "CANCELADA" }
E o usu√°rio possui permiss√£o "rec.write"
Quando uma requisi√ß√£o PATCH for enviada para /rec/RR1234567820240115abcdefghijk
Ent√£o a API deve retornar status 200 (OK)
E o corpo da resposta deve conter a recorr√™ncia atualizada com status "CANCELADA"
E o hist√≥rico de atualiza√ß√µes deve incluir o novo status com timestamp
```

### **Cen√°rio 11: Erro ao tentar cancelar recorr√™ncia j√° cancelada**
```gherkin
Dado que a recorr√™ncia j√° est√° com status "CANCELADA"
Quando uma requisi√ß√£o PATCH for enviada com { "status": "CANCELADA" }
Ent√£o a API deve retornar status 400
E o erro deve ser "RecOperacaoInvalida"
E a viola√ß√£o deve indicar que a opera√ß√£o n√£o √© permitida para o estado atual
```

### **Cen√°rio 12: Erro ao tentar alterar campo imut√°vel (ex: txid) em recorr√™ncia rejeitada**
```gherkin
Dado que a recorr√™ncia est√° com status "REJEITADA"
E o payload tenta alterar o campo "dadosJornada.txid"
Quando uma requisi√ß√£o PATCH for enviada
Ent√£o a API deve retornar status 400
E o erro deve ser "RecOperacaoInvalida"
E a viola√ß√£o deve indicar: "O campo rec.dadosJornada.txid n√£o pode ser alterado quando a recorr√™ncia est√° REJEITADA ou CANCELADA"
```

### **Cen√°rio 13: Erro ao enviar payload inv√°lido na revis√£o**
```gherkin
Dado que o payload de PATCH cont√©m campos fora do schema (ex: campo desconhecido ou tipo errado)
Quando uma requisi√ß√£o PATCH for enviada para /rec/{idRec}
Ent√£o a API deve retornar status 400
E o erro deve ser "RecOperacaoInvalida"
E a mensagem deve listar as viola√ß√µes de schema
```

---

## ‚úÖ **Funcionalidade: Consultar Lista de Recorr√™ncias (`GET /rec`)**

### **Cen√°rio 14: Consultar lista de recorr√™ncias com filtros v√°lidos**
```gherkin
Dado que o usu√°rio possui permiss√£o "rec.read"
E os par√¢metros da consulta incluem:
  | par√¢metro           | valor                     |
  | inicio              | 2024-04-01T00:00:00Z     |
  | fim                 | 2024-04-30T23:59:59Z     |
  | paginacao.paginaAtual | 0                       |
  | paginacao.itensPorPagina | 100                  |
Quando uma requisi√ß√£o GET for enviada para /rec com esses par√¢metros
Ent√£o a API deve retornar status 200
E o corpo deve conter "RecsConsultadas"
E o campo "recs" deve ser um array com at√© 100 recorr√™ncias
E o campo "paginacao.quantidadeTotalDeItens" deve refletir o total
```

### **Cen√°rio 15: Erro ao usar ambos CPF e CNPJ como filtros simultaneamente**
```gherkin
Dado que os par√¢metros da consulta incluem tanto "cpf" quanto "cnpj"
Quando uma requisi√ß√£o GET for enviada para /rec
Ent√£o a API deve retornar status 400
E o erro deve ser "RecConsultaInvalida"
E a viola√ß√£o deve indicar: "ambos os par√¢metros cpf e cnpj est√£o preenchidos"
```

### **Cen√°rio 16: Erro ao informar data fim anterior √† data in√≠cio**
```gherkin
Dado que o par√¢metro "fim" √© "2023-01-01T00:00:00Z"
E o par√¢metro "inicio" √© "2024-01-01T00:00:00Z"
Quando uma requisi√ß√£o GET for enviada para /rec
Ent√£o a API deve retornar status 400
E o erro deve ser "RecConsultaInvalida"
E a viola√ß√£o deve indicar: "o timestamp fim √© anterior ao timestamp inicio"
```

### **Cen√°rio 17: Erro ao usar n√∫mero de p√°gina negativo**
```gherkin
Dado que o par√¢metro "paginacao.paginaAtual" √© -1
Quando uma requisi√ß√£o GET for enviada para /rec
Ent√£o a API deve retornar status 400
E o erro deve ser "RecConsultaInvalida"
E a viola√ß√£o deve indicar: "o par√¢metro paginacao.paginaAtual √© negativo"
```

### **Cen√°rio 18: Consultar recorr√™ncias por status espec√≠fico**
```gherkin
Dado que o filtro "status" √© definido como "APROVADA"
E existem recorr√™ncias com esse status no intervalo
Quando uma requisi√ß√£o GET for enviada para /rec?status=APROVADA
Ent√£o a API deve retornar status 200
E todas as recorr√™ncias no array "recs" devem ter status "APROVADA"
```

### **Cen√°rio 19: Consultar recorr√™ncias por conv√™nio**
```gherkin
Dado que o filtro "recebedor.convenio" √© "CONV123"
E existem recorr√™ncias associadas a esse conv√™nio
Quando uma requisi√ß√£o GET for enviada para /rec?recebedor.convenio=CONV123
Ent√£o a API deve retornar status 200
E todas as recorr√™ncias retornadas devem ter o conv√™nio "CONV123"
```

---

## üîÅ **Observa√ß√µes Gerais e Regras de Neg√≥cio Aplicadas**

### **Regras do `idRec`:**
- Formato: `RAxxxxxxxxyyyyMMddkkkkkkkkkkk` (29 caracteres)
- `R`: fixo
- `A`: `R` (permite retentativas) ou `N` (n√£o permite)
- `xxxxxxxx`: ISPB do recebedor (8 d√≠gitos)
- `yyyyMMdd`: data de cria√ß√£o
- `kkkkkkkkkkk`: sequ√™ncia aleat√≥ria (11 caracteres)
- Case sensitive

### **Status V√°lidos:**
- `CRIADA`, `APROVADA`, `REJEITADA`, `EXPIRADA`, `CANCELADA`

### **C√≥digos de Erro Comuns:**
- `400 RecOperacaoInvalida` ‚Üí Erro de schema ou sem√¢ntica
- `404 RecNaoEncontrada` ‚Üí ID inexistente
- `400 RecConsultaInvalida` ‚Üí Filtros inv√°lidos
- `400 RecPayloadOperacaoInvalida` ‚Üí Recorr√™ncia expirada/cancelada/rejeitada

### **Permiss√µes OAuth2 Necess√°rias:**
- `rec.write` ‚Üí para POST e PATCH
- `rec.read` ‚Üí para GET

---

Se desejar, posso gerar:
- Planilha de testes (CSV/Excel)
- Scripts de automa√ß√£o (ex: Postman, Cypress, RestAssured)
- Dados de exemplo para cada cen√°rio
- Diagrama de estados da recorr√™ncia

Deseja continuar com alguma dessas extens√µes?

### USER
Planilha de testes (CSV/Excel)

### ASSISTANT
Com base na an√°lise detalhada do arquivo fornecido e nos casos de teste no padr√£o Gherkin gerados anteriormente, estou gerando agora uma **planilha de testes completa** no formato estruturado, pronta para exporta√ß√£o como **CSV ou Excel**.

A planilha inclui os seguintes campos:

| ID do Caso | Funcionalidade | T√≠tulo do Caso | Descri√ß√£o | Pr√©-condi√ß√µes | Passos (Given-When-Then) | Dados de Entrada | Sa√≠da Esperada | C√≥digo HTTP Esperado | Tipo de Teste | Prioridade | Tags |

---

### ‚úÖ **Planilha de Testes - Gerenciamento de Recorr√™ncias (API Pix)**

```csv
ID do Caso,Funcionalidade,T√≠tulo do Caso,Descri√ß√£o,Pr√©-condi√ß√µes,Passos,Dados de Entrada,Sa√≠da Esperada,C√≥digo HTTP Esperado,Tipo de Teste,Prioridade,Tags
TC-REC-001,POST /rec,Criar recorr√™ncia v√°lida com sucesso,Criar uma nova recorr√™ncia com todos os campos obrigat√≥rios e v√°lidos,Usu√°rio com permiss√£o "rec.write",Dado que o usu√°rio possui permiss√£o "rec.write" e o payload est√° completo e v√°lido; Quando uma requisi√ß√£o POST for enviada para /rec com os dados v√°lidos; Ent√£o a API deve retornar status 201 e o objeto "RecGerada",{"idRec":"RR1234567820240115abcdefghijk","vinculo":{"devedor":{"cpf":"12345678909","nome":"Fulano"}},"calendario":{"dataInicial":"2024-10-01","dataFinal":"2025-10-01","periodicidade":"MENSAL"},"politicaRetentativa":"PERMITE_3R_7D"},Status 201, RecGerada retornada,201,Positivo,Alta,"criacao, sucesso"
TC-REC-002,POST /rec,Erro ao criar recorr√™ncia com data inicial anterior √† data de cria√ß√£o,Validar que n√£o √© permitido criar recorr√™ncia com data inicial no passado,Payload com dataInicial < data atual,Dado que o campo "rec.calendario.dataInicial" √© anterior √† data atual; Quando uma requisi√ß√£o POST for enviada; Ent√£o deve retornar erro 400,{"calendario":{"dataInicial":"2023-01-01"}},Erro RecOperacaoInvalida com detalhe sobre dataInicial,400,Negativo,Alta,"validacao, data"
TC-REC-003,POST /rec,Erro ao criar recorr√™ncia com data final anterior √† data inicial,Validar consist√™ncia temporal entre dataInicial e dataFinal,Payload com dataFinal < dataInicial,Dado que dataFinal √© anterior √† dataInicial; Quando POST /rec; Ent√£o retornar erro 400,{"calendario":{"dataInicial":"2024-10-01","dataFinal":"2024-09-01"}},Erro RecOperacaoInvalida com detalhe sobre dataFinal,400,Negativo,Alta,"validacao, data"
TC-REC-004,POST /rec,Erro ao criar recorr√™ncia com periodicidade inv√°lida,Validar schema de periodicidade,Payload com periodicidade fora do enum,Dado que periodicidade n√£o est√° em ["MENSAL", "ANUAL"]; Quando POST /rec; Ent√£o retornar erro 400,{"calendario":{"periodicidade":"SEMANAL"}},Erro RecOperacaoInvalida com detalhe sobre schema,400,Negativo,M√©dia,"validacao, schema"
TC-REC-005,POST /rec,Erro ao criar recorr√™ncia sem campos obrigat√≥rios,Validar campos obrigat√≥rios ausentes,Payload incompleto,Dado que falta campo "calendario"; Quando POST /rec; Ent√£o retornar erro 400,{},Erro RecOperacaoInvalida por viola√ß√£o de schema,400,Negativo,Alta,"schema, obrigatorio"
TC-REC-006,GET /rec/{idRec},Consultar recorr√™ncia existente com sucesso,Recuperar detalhes de uma recorr√™ncia v√°lida,Recorr√™ncia com idRec existente,Dado que existe uma recorr√™ncia com idRec "RR123..."; Quando GET /rec/RR123...; Ent√£o retornar 200 e objeto completo,"idRec=RR1234567820240115abcdefghijk",Objeto RecCompletaPesquisada retornado,200,Positivo,Alta,"consulta, sucesso"
TC-REC-007,GET /rec/{idRec},Erro ao consultar recorr√™ncia inexistente,Validar comportamento para ID n√£o encontrado,ID n√£o registrado no sistema,Dado que n√£o existe recorr√™ncia com idRec fornecido; Quando GET /rec/RN999...; Ent√£o retornar 404,"idRec=RN9999999920240115zzzzzzzzz",Erro RecNaoEncontrada,404,Negativo,Alta,"consulta, nao-encontrado"
TC-REC-008,GET /rec/{idRec},Erro ao consultar recorr√™ncia com idRec mal formatado,Validar formato do idRec,ID com menos de 29 caracteres ou caracteres inv√°lidos,Dado que idRec tem formato inv√°lido; Quando GET /rec/ID_INVALIDO; Ent√£o retornar 400,"idRec=ID_INVALIDO",Erro RecConsultaInvalida por schema,400,Negativo,M√©dia,"validacao, formato"
TC-REC-009,GET /rec/{idRec},Consultar recorr√™ncia expirada,rejeitada ou cancelada,Verificar se √© poss√≠vel consultar recorr√™ncia encerrada,Recorr√™ncia com status EXPIRADA,Dado que a recorr√™ncia est√° com status "EXPIRADA"; Quando GET /rec/RRexpired...; Ent√£o retornar 200 ou 400 conforme pol√≠tica,"idRec=RR1234567820230101expired01",Retorno 200 OU erro RecPayloadOperacaoInvalida,200 ou 400,Edge Case,M√©dia,"edge, status"
TC-REC-010,PATCH /rec/{idRec},Cancelar recorr√™ncia v√°lida com sucesso,Alterar status de recorr√™ncia para CANCELADA,Recorr√™ncia com status APROVADA e permiss√£o "rec.write",Dado que a recorr√™ncia est√° APROVADA; Quando PATCH /rec/{idRec} com {"status": "CANCELADA"}; Ent√£o retornar 200 e status atualizado,"idRec=RR123..., payload={""status"": ""CANCELADA""}",Recorr√™ncia com status CANCELADA,200,Positivo,Alta,"cancelamento, sucesso"
TC-REC-011,PATCH /rec/{idRec},Erro ao cancelar recorr√™ncia j√° cancelada,Evitar opera√ß√£o redundante,Recorr√™ncia j√° com status CANCELADA,Dado que a recorr√™ncia j√° est√° CANCELADA; Quando PATCH com {"status": "CANCELADA"}; Ent√£o retornar 400,"idRec=RRcancelada..., payload={""status"": ""CANCELADA""}",Erro RecOperacaoInvalida por estado inv√°lido,400,Negativo,Alta,"validacao, estado"
TC-REC-012,PATCH /rec/{idRec},Erro ao alterar campo imut√°vel em recorr√™ncia rejeitada,Tentar modificar campo proibido ap√≥s rejei√ß√£o,Recorr√™ncia com status REJEITADA,Dado que a recorr√™ncia est√° REJEITADA; Quando PATCH tentar alterar txid; Ent√£o retornar 400,"payload={""dadosJornada"":{""txid"":""novo_txid""}}",Erro RecOperacaoInvalida por campo imut√°vel,400,Negativo,Alta,"imutabilidade, validacao"
TC-REC-013,PATCH /rec/{idRec},Erro ao enviar payload inv√°lido na revis√£o,Validar schema do PATCH,Payload com campo desconhecido ou tipo errado,Dado que o payload cont√©m campo inv√°lido; Quando PATCH /rec/{idRec}; Ent√£o retornar 400,"payload={""status"": ""INVALIDO""}",Erro RecOperacaoInvalida por schema,400,Negativo,M√©dia,"schema, validacao"
TC-REC-014,GET /rec,Consultar lista de recorr√™ncias com filtros v√°lidos,Obter lista paginada com par√¢metros corretos,Filtros respeitam RFC 3339 e regras de neg√≥cio,Dado que os filtros est√£o v√°lidos; Quando GET /rec?inicio=...&fim=...; Ent√£o retornar 200 e lista paginada,"inicio=2024-04-01T00:00:00Z, fim=2024-04-30T23:59:59Z",Lista RecsConsultadas com paginacao,200,Positivo,Alta,"consulta, lista"
TC-REC-015,GET /rec,Erro ao usar CPF e CNPJ simultaneamente,Restri√ß√£o de filtro exclusivo,Usu√°rio tenta filtrar por CPF e CNPJ,Dado que ambos cpf e cnpj est√£o preenchidos; Quando GET /rec; Ent√£o retornar 400,"cpf=123..., cnpj=456...",Erro RecConsultaInvalida por conflito de filtros,400,Negativo,Alta,"filtro, exclusivo"
TC-REC-016,GET /rec,Erro ao informar data fim anterior √† data in√≠cio,Validar consist√™ncia temporal dos filtros,fim < inicio,Dado que fim < inicio; Quando GET /rec; Ent√£o retornar 400,"inicio=2024-01-01, fim=2023-01-01",Erro RecConsultaInvalida por ordem de datas,400,Negativo,Alta,"validacao, data"
TC-REC-017,GET /rec,Erro ao usar n√∫mero de p√°gina negativo,Validar pagina√ß√£o,P√°gina atual < 0,Dado que paginacao.paginaAtual = -1; Quando GET /rec; Ent√£o retornar 400,"paginaAtual=-1",Erro RecConsultaInvalida por p√°gina inv√°lida,400,Negativo,M√©dia,"paginacao, validacao"
TC-REC-018,GET /rec,Consultar recorr√™ncias por status espec√≠fico,Filtrar por status APROVADA,Existem recorr√™ncias com status APROVADA,Dado que filtro status = APROVADA; Quando GET /rec?status=APROVADA; Ent√£o todas as recs devem ter status APROVADA,"status=APROVADA",Lista com todas APROVADAS,200,Positivo,M√©dia,"filtro, status"
TC-REC-019,GET /rec,Consultar recorr√™ncias por conv√™nio,Filtrar por campo recebedor.convenio,Conv√™nio existe no sistema,Dado que filtro por convenio = "CONV123"; Quando GET /rec?recebedor.convenio=CONV123; Ent√£o todas as recs devem ter esse convenio,"recebedor.convenio=CONV123",Lista com convenio correto,200,Positivo,M√©dia,"filtro, convenio"
```

---

### üì• Como usar esta planilha:

- **Formato**: CSV (pode ser aberto no Excel, Google Sheets, LibreOffice, etc.)
- **Codifica√ß√£o**: UTF-8
- **Delimitador**: V√≠rgula (`,`)
- **Campos**:
  - `ID do Caso`: Identificador √∫nico do caso de teste.
  - `Funcionalidade`: Endpoint ou opera√ß√£o testada.
  - `T√≠tulo do Caso`: Descri√ß√£o clara do objetivo.
  - `Descri√ß√£o`: Contexto do teste.
  - `Pr√©-condi√ß√µes`: Estado necess√°rio antes da execu√ß√£o.
  - `Passos`: Sequ√™ncia Given-When-Then.
  - `Dados de Entrada`: Payload ou par√¢metros da requisi√ß√£o.
  - `Sa√≠da Esperada`: Comportamento esperado.
  - `C√≥digo HTTP Esperado`: Status code esperado.
  - `Tipo de Teste`: Positivo, Negativo, Edge Case.
  - `Prioridade`: Alta, M√©dia.
  - `Tags`: Classifica√ß√£o para filtragem (ex: validacao, sucesso, filtro).

---

### üìÅ Exporta√ß√£o

Para salvar como **CSV**:

1. Copie todo o bloco acima (de `ID do Caso` at√© o √∫ltimo caso).
2. Cole em um arquivo de texto.
3. Salve como `testes_recorrencias.csv` com codifica√ß√£o UTF-8.

Para usar no **Excel**:
- Abra o Excel.
- V√° em **Dados ‚Üí Obter Dados Externos ‚Üí Do Texto/CSV**.
- Selecione o arquivo e importe com delimitador v√≠rgula.

---

Se desejar, posso gerar:
- A mesma planilha em formato **XLSX** (via c√≥digo Python ou JSON para convers√£o).
- Scripts de automa√ß√£o (Postman, RestAssured, Pytest).
- Arquivo `.feature` para Cucumber.

Deseja que eu gere um desses formatos adicionais?

### USER
Agora fa√ßa a mesma coisa com o controller Gerenciamento de solicita√ß√µes de recorr√™ncias

### ASSISTANT
Com base na an√°lise detalhada do conte√∫do fornecido, identifiquei que a **tag `SolicRec`** (Gerenciamento de Solicita√ß√µes de Recorr√™ncias) re√∫ne endpoints destinados ao gerenciamento de **solicita√ß√µes de confirma√ß√£o de recorr√™ncia** por parte do PSP recebedor ao usu√°rio pagador. Essas solicita√ß√µes s√£o etapas intermedi√°rias no processo de ativa√ß√£o de uma recorr√™ncia, onde o usu√°rio pagador deve autorizar explicitamente o d√©bito recorrente.

A documenta√ß√£o indica que esta funcionalidade possui **dois endpoints principais**:

1. `POST /solicrec` ‚Äì Criar uma nova solicita√ß√£o de recorr√™ncia  
2. `GET /solicrec/{idSolicRec}` ‚Äì Consultar uma solicita√ß√£o espec√≠fica  
3. `PATCH /solicrec/{idSolicRec}` ‚Äì Revisar (ex: cancelar) uma solicita√ß√£o de recorr√™ncia  

> ‚ö†Ô∏è Observa√ß√£o: Apesar de o documento mencionar apenas `POST`, `GET` e `PATCH`, o `PATCH` √© usado exclusivamente para **cancelamento** da solicita√ß√£o, e apenas se estiver em status permitido.

---

## ‚úÖ **Funcionalidade: Criar Solicita√ß√£o de Recorr√™ncia (`POST /solicrec`)**

### **Cen√°rio 1: Criar solicita√ß√£o de recorr√™ncia v√°lida com sucesso**
```gherkin
Dado que o usu√°rio possui permiss√£o "solicrec.write"
E o payload da solicita√ß√£o est√° completo e v√°lido
E o campo "solicrec.calendario.dataExpiracaoSolicitacao" √© posterior √† data de cria√ß√£o
E o campo "solicrec.destinatario" cont√©m dados banc√°rios v√°lidos e CPF ou CNPJ
E n√£o existe outra solicita√ß√£o ativa com o mesmo "idRec"
Quando uma requisi√ß√£o POST for enviada para /solicrec com os dados v√°lidos
Ent√£o a API deve retornar status 201 (Created)
E o corpo da resposta deve conter o objeto "SolicRecCompleta"
E o campo "status" deve ser "CRIADA"
E o hist√≥rico de atualiza√ß√µes ("atualizacao") deve conter o primeiro registro com status "CRIADA" e timestamp atual
```

### **Cen√°rio 2: Erro ao criar solicita√ß√£o com data de expira√ß√£o anterior √† data de cria√ß√£o**
```gherkin
Dado que o payload cont√©m "solicrec.calendario.dataExpiracaoSolicitacao" anterior √† data atual
Quando uma requisi√ß√£o POST for enviada para /solicrec
Ent√£o a API deve retornar status 400 (Bad Request)
E o erro deve ser do tipo "SolicRecOperacaoInvalida"
E a viola√ß√£o deve indicar: "O campo solicrec.calendario.dataExpiracaoSolicitacao √© anterior √† data de cria√ß√£o da solicita√ß√£o"
```

### **Cen√°rio 3: Erro ao criar solicita√ß√£o com destinat√°rio inv√°lido (schema)**
```gherkin
Dado que o campo "solicrec.destinatario" n√£o respeita o schema (ex: falta ag√™ncia, conta ou CPF/CNPJ)
Quando uma requisi√ß√£o POST for enviada para /solicrec
Ent√£o a API deve retornar status 400
E o erro deve ser "SolicRecOperacaoInvalida"
E a mensagem deve indicar viola√ß√£o no objeto "destinatario"
```

### **Cen√°rio 4: Erro ao criar solicita√ß√£o duplicada (mesmo idRec ativo)**
```gherkin
Dado que j√° existe uma solicita√ß√£o com "idRec" igual e status "CRIADA", "ENVIADA" ou "RECEBIDA"
Quando uma nova requisi√ß√£o POST for enviada com o mesmo "idRec"
Ent√£o a API deve retornar status 400
E o erro deve ser "SolicRecOperacaoInvalida"
E a viola√ß√£o deve indicar: "Existe uma solicita√ß√£o ativa referente ao mesmo solicrec.idRec"
```

### **Cen√°rio 5: Erro ao omitir campos obrigat√≥rios**
```gherkin
Dado que o payload est√° incompleto (ex: falta "calendario", "destinatario" ou "idRec")
Quando uma requisi√ß√£o POST for enviada para /solicrec
Ent√£o a API deve retornar status 400
E o erro deve ser "SolicRecOperacaoInvalida"
E a mensagem deve indicar viola√ß√£o de schema
```

---

## ‚úÖ **Funcionalidade: Consultar Solicita√ß√£o de Recorr√™ncia (`GET /solicrec/{idSolicRec}`)**

### **Cen√°rio 6: Consultar solicita√ß√£o existente com sucesso**
```gherkin
Dado que existe uma solicita√ß√£o com idSolicRec "SC1234567820240115abcdefghijk"
E o usu√°rio possui permiss√£o "solicrec.read"
Quando uma requisi√ß√£o GET for enviada para /solicrec/SC1234567820240115abcdefghijk
Ent√£o a API deve retornar status 200 (OK)
E o corpo da resposta deve conter o objeto "SolicRecCompleta"
E os campos como "status", "destinatario", "calendario" devem estar presentes
E o hist√≥rico "atualizacao" deve conter todos os eventos registrados
```

### **Cen√°rio 7: Erro ao consultar solicita√ß√£o inexistente**
```gherkin
Dado que n√£o existe solicita√ß√£o com idSolicRec "SC9999999920240115zzzzzzzzz"
Quando uma requisi√ß√£o GET for enviada para /solicrec/SC9999999920240115zzzzzzzzz
Ent√£o a API deve retornar status 404 (Not Found)
E o erro deve ser do tipo "SolicRecNaoEncontrada"
E o campo "detail" deve indicar que a solicita√ß√£o n√£o foi encontrada
```

### **Cen√°rio 8: Erro ao consultar solicita√ß√£o com idSolicRec mal formatado**
```gherkin
Dado que o idSolicRec fornecido tem menos de 29 caracteres ou n√£o segue o padr√£o alfanum√©rico
Quando uma requisi√ß√£o GET for enviada para /solicrec/ID_INVALIDO
Ent√£o a API deve retornar status 400
E o erro deve ser "SolicRecConsultaInvalida"
E a viola√ß√£o deve indicar que o par√¢metro n√£o respeita o schema
```

---

## ‚úÖ **Funcionalidade: Revisar Solicita√ß√£o de Recorr√™ncia (`PATCH /solicrec/{idSolicRec}`)**

### **Cen√°rio 9: Cancelar solicita√ß√£o v√°lida com sucesso**
```gherkin
Dado que existe uma solicita√ß√£o com idSolicRec "SC1234567820240115abcdefghijk" e status "CRIADA"
E o usu√°rio possui permiss√£o "solicrec.write"
E o payload cont√©m apenas { "status": "CANCELADA" }
Quando uma requisi√ß√£o PATCH for enviada para /solicrec/SC1234567820240115abcdefghijk
Ent√£o a API deve retornar status 201 (Created)
E o corpo da resposta deve conter a solicita√ß√£o atualizada com status "CANCELADA"
E o hist√≥rico de atualiza√ß√µes deve incluir o novo status com timestamp
```

### **Cen√°rio 10: Erro ao tentar cancelar solicita√ß√£o j√° cancelada**
```gherkin
Dado que a solicita√ß√£o j√° est√° com status "CANCELADA"
Quando uma requisi√ß√£o PATCH for enviada com { "status": "CANCELADA" }
Ent√£o a API deve retornar status 400
E o erro deve ser "SolicRecOperacaoInvalida"
E a viola√ß√£o deve indicar que o cancelamento n√£o √© permitido para o estado atual
```

### **Cen√°rio 11: Erro ao tentar cancelar solicita√ß√£o com status n√£o permitido**
```gherkin
Dado que a solicita√ß√£o est√° com status "ACEITA" ou "REJEITADA"
Quando uma requisi√ß√£o PATCH for enviada com { "status": "CANCELADA" }
Ent√£o a API deve retornar status 400
E o erro deve ser "SolicRecOperacaoInvalida"
E a viola√ß√£o deve indicar: "N√£o √© poss√≠vel cancelar uma solicita√ß√£o com status diferente de CRIADA, ENVIADA ou RECEBIDA"
```

### **Cen√°rio 12: Erro ao enviar payload inv√°lido na revis√£o**
```gherkin
Dado que o payload de PATCH cont√©m campo inv√°lido (ex: "status": "INVALIDO") ou campo adicional
Quando uma requisi√ß√£o PATCH for enviada para /solicrec/{idSolicRec}
Ent√£o a API deve retornar status 400
E o erro deve ser "SolicRecOperacaoInvalida"
E a mensagem deve listar as viola√ß√µes de schema
```

---

## üîÅ **Regras de Neg√≥cio e Observa√ß√µes**

### **Formato do `idSolicRec`:**
- Formato: `SCxxxxxxxxyyyyMMddkkkkkkkkkkk` (29 caracteres)
- `SC`: prefixo fixo
- `xxxxxxxx`: ISPB do recebedor (8 d√≠gitos)
- `yyyyMMdd`: data de cria√ß√£o
- `kkkkkkkkkkk`: sequ√™ncia aleat√≥ria (11 caracteres)
- Case sensitive

### **Status V√°lidos da Solicita√ß√£o:**
- `CRIADA`
- `ENVIADA`
- `RECEBIDA`
- `REJEITADA`
- `ACEITA`
- `EXPIRADA`
- `CANCELADA`

> Apenas solicita√ß√µes com status `CRIADA`, `ENVIADA` ou `RECEBIDA` podem ser canceladas via `PATCH`.

### **C√≥digos de Erro Comuns:**
| Erro | Significado | HTTP | Endpoint |
|------|------------|------|--------|
| `SolicRecOperacaoInvalida` | Payload inv√°lido, data expirada, schema violado | 400 | POST, PATCH |
| `SolicRecNaoEncontrada` | Solicita√ß√£o n√£o encontrada | 404 | GET, PATCH |
| `SolicRecConsultaInvalida` | ID mal formatado | 400 | GET |

### **Permiss√µes OAuth2 Necess√°rias:**
- `solicrec.write` ‚Üí para `POST` e `PATCH`
- `solicrec.read` ‚Üí para `GET`

---

## üìä **Planilha de Testes - Gerenciamento de Solicita√ß√µes de Recorr√™ncias (CSV)**

Abaixo est√° a planilha no formato CSV, pronta para exporta√ß√£o:

```csv
ID do Caso,Funcionalidade,T√≠tulo do Caso,Descri√ß√£o,Pr√©-condi√ß√µes,Passos,Dados de Entrada,Sa√≠da Esperada,C√≥digo HTTP Esperado,Tipo de Teste,Prioridade,Tags
TC-SOLICREC-001,POST /solicrec,Criar solicita√ß√£o v√°lida com sucesso,Criar uma nova solicita√ß√£o de recorr√™ncia com todos os campos obrigat√≥rios e v√°lidos,Usu√°rio com permiss√£o "solicrec.write",Dado que o payload est√° completo e v√°lido; Quando POST /solicrec; Ent√£o retornar 201 e objeto completo,"{""idRec"": ""RN123..."", ""calendario"": {""dataExpiracaoSolicitacao"": ""2024-12-01T10:00:00Z""}, ""destinatario"": {""cpf"": ""123..."", ""agencia"": ""1234"", ""conta"": ""5678"", ""ispbParticipante"": ""12345678""}}",Status 201, SolicRecCompleta retornada,201,Positivo,Alta,"criacao, sucesso"
TC-SOLICREC-002,POST /solicrec,Erro ao criar solicita√ß√£o com data de expira√ß√£o no passado,Validar que dataExpiracaoSolicitacao n√£o pode ser anterior √† data atual,Payload com dataExpiracao < data atual,Dado que dataExpiracaoSolicitacao √© anterior √† data atual; Quando POST /solicrec; Ent√£o retornar 400,"{""calendario"":{""dataExpiracaoSolicitacao"":""2023-01-01T00:00:00Z""}}",Erro SolicRecOperacaoInvalida com detalhe sobre data,400,Negativo,Alta,"validacao, data"
TC-SOLICREC-003,POST /solicrec,Erro ao criar solicita√ß√£o com destinat√°rio inv√°lido,Validar schema do destinat√°rio,Payload com destinat√°rio faltando ag√™ncia ou CPF,Dado que destinatario est√° incompleto; Quando POST /solicrec; Ent√£o retornar 400,"{""destinatario"":{""conta"":""5678""}}",Erro SolicRecOperacaoInvalida por schema,400,Negativo,Alta,"validacao, schema"
TC-SOLICREC-004,POST /solicrec,Erro ao criar solicita√ß√£o duplicada,Evitar m√∫ltiplas solicita√ß√µes ativas para o mesmo idRec,Existe solicita√ß√£o ativa com mesmo idRec,Dado que j√° existe solicita√ß√£o ativa com idRec; Quando POST com mesmo idRec; Ent√£o retornar 400,"{""idRec"":""RN123..."", ...}",Erro SolicRecOperacaoInvalida por duplicidade,400,Negativo,Alta,"duplicidade, unico"
TC-SOLICREC-005,POST /solicrec,Erro ao omitir campos obrigat√≥rios,Validar campos obrigat√≥rios ausentes,Payload incompleto,Dado que falta campo calendario; Quando POST /solicrec; Ent√£o retornar 400,{},Erro SolicRecOperacaoInvalida por schema,400,Negativo,Alta,"schema, obrigatorio"
TC-SOLICREC-006,GET /solicrec/{idSolicRec},Consultar solicita√ß√£o existente com sucesso,Recuperar detalhes de uma solicita√ß√£o v√°lida,Solicita√ß√£o com idSolicRec existente,Dado que a solicita√ß√£o existe; Quando GET /solicrec/SC123...; Ent√£o retornar 200 e objeto completo,"idSolicRec=SC1234567820240115abcdefghijk",Objeto SolicRecCompleta retornado,200,Positivo,Alta,"consulta, sucesso"
TC-SOLICREC-007,GET /solicrec/{idSolicRec},Erro ao consultar solicita√ß√£o inexistente,Validar comportamento para ID n√£o encontrado,ID n√£o registrado no sistema,Dado que n√£o existe solicita√ß√£o com idSolicRec; Quando GET /solicrec/SC999...; Ent√£o retornar 404,"idSolicRec=SC9999999920240115zzzzzzzzz",Erro SolicRecNaoEncontrada,404,Negativo,Alta,"consulta, nao-encontrado"
TC-SOLICREC-008,GET /solicrec/{idSolicRec},Erro ao consultar solicita√ß√£o com idSolicRec mal formatado,Validar formato do idSolicRec,ID com menos de 29 caracteres ou caracteres inv√°lidos,Dado que idSolicRec tem formato inv√°lido; Quando GET /solicrec/ID_INVALIDO; Ent√£o retornar 400,"idSolicRec=ID_INVALIDO",Erro SolicRecConsultaInvalida por schema,400,Negativo,M√©dia,"validacao, formato"
TC-SOLICREC-009,PATCH /solicrec/{idSolicRec},Cancelar solicita√ß√£o v√°lida com sucesso,Alterar status de solicita√ß√£o para CANCELADA,Solicita√ß√£o com status CRIADA e permiss√£o "solicrec.write",Dado que a solicita√ß√£o est√° CRIADA; Quando PATCH /solicrec/{idSolicRec} com {"status": "CANCELADA"}; Ent√£o retornar 201 e status atualizado,"idSolicRec=SC123..., payload={""status"": ""CANCELADA""}",Solicita√ß√£o com status CANCELADA,201,Positivo,Alta,"cancelamento, sucesso"
TC-SOLICREC-010,PATCH /solicrec/{idSolicRec},Erro ao cancelar solicita√ß√£o j√° cancelada,Evitar opera√ß√£o redundante,Solicita√ß√£o j√° com status CANCELADA,Dado que a solicita√ß√£o j√° est√° CANCELADA; Quando PATCH com {"status": "CANCELADA"}; Ent√£o retornar 400,"idSolicRec=SCcancelada..., payload={""status"": ""CANCELADA""}",Erro SolicRecOperacaoInvalida por estado inv√°lido,400,Negativo,Alta,"validacao, estado"
TC-SOLICREC-011,PATCH /solicrec/{idSolicRec},Erro ao cancelar solicita√ß√£o com status n√£o permitido,Tentar cancelar solicita√ß√£o j√° aceita ou rejeitada,Solicita√ß√£o com status ACEITA,Dado que a solicita√ß√£o est√° ACEITA; Quando PATCH com {"status": "CANCELADA"}; Ent√£o retornar 400,"idSolicRec=SCaceita..., payload={""status"": ""CANCELADA""}",Erro SolicRecOperacaoInvalida por status n√£o permitido,400,Negativo,Alta,"fluxo, validacao"
TC-SOLICREC-012,PATCH /solicrec/{idSolicRec},Erro ao enviar payload inv√°lido na revis√£o,Validar schema do PATCH,Payload com campo inv√°lido,Dado que o payload cont√©m status inv√°lido; Quando PATCH /solicrec/{idSolicRec}; Ent√£o retornar 400,"payload={""status"": ""INVALIDO""}",Erro SolicRecOperacaoInvalida por schema,400,Negativo,M√©dia,"schema, validacao"
```

---

## üì• Instru√ß√µes para uso

- **Salve como CSV**: Copie todo o bloco acima e salve com codifica√ß√£o UTF-8 e extens√£o `.csv`.
- **Importe no Excel/Google Sheets**: Use o delimitador de v√≠rgula.
- **Filtros √∫teis**: Use as colunas `Tags`, `Prioridade` e `Tipo de Teste` para organizar execu√ß√µes.

---

Se desejar, posso gerar:
- Arquivo `.feature` para Cucumber
- Scripts de automa√ß√£o (Postman, Pytest, etc.)
- Diagrama de estados da solicita√ß√£o de recorr√™ncia

Deseja que eu gere algum desses artefatos?

### USER
Fa√ßa o mesmo levantamento para o controller Gerenciamento de cobran√ßas associadas a uma recorr√™ncia e tamb√©m nao economize tokens.

### ASSISTANT
Com base na an√°lise detalhada do conte√∫do fornecido, identifiquei que a **tag `CobR`** (Gerenciamento de Cobran√ßas Associadas a uma Recorr√™ncia) re√∫ne endpoints destinados ao **gerenciamento de cobran√ßas recorrentes individuais** que s√£o geradas a partir de uma recorr√™ncia previamente configurada. Essas cobran√ßas representam as tentativas de pagamento peri√≥dicas vinculadas ao ciclo da recorr√™ncia.

Este controller possui **quatro endpoints principais**, conforme descrito no documento:

1. `POST /cobr/{txid}` ‚Äì Criar ou atualizar uma cobran√ßa recorrente espec√≠fica  
2. `GET /cobr/{txid}` ‚Äì Consultar uma cobran√ßa recorrente espec√≠fica  
3. `PATCH /cobr/{txid}` ‚Äì Revisar (alterar status) uma cobran√ßa recorrente  
4. `GET /cobr` ‚Äì Consultar lista de cobran√ßas recorrentes com filtros  

Abaixo, apresento uma an√°lise completa com **casos de teste no padr√£o Gherkin (Given-When-Then)** para cada funcionalidade, seguida de uma **planilha de testes estruturada em CSV**, considerando todas as regras de neg√≥cio, valida√ß√µes, c√≥digos de erro, fluxos de status e restri√ß√µes presentes na documenta√ß√£o.

---

## ‚úÖ **Funcionalidade: Criar ou Atualizar Cobran√ßa Recorrente (`POST /cobr/{txid}`)**

### **Cen√°rio 1: Criar cobran√ßa recorrente v√°lida com sucesso**
```gherkin
Dado que o usu√°rio possui permiss√£o "cobr.write"
E o `txid` fornecido est√° no formato v√°lido (32 caracteres alfanum√©ricos)
E o payload da cobran√ßa recorrente est√° completo e respeita o schema `CobRSolicitada`
E o campo `cobr.calendario.dataDeVencimento` √© igual ou posterior √† data de cria√ß√£o
E o campo `cobr.valor.original` est√° no formato decimal v√°lido (ex: "100.00")
E o campo `cobr.chave` √© um identificador v√°lido de recebedor (CPF/CNPJ, e-mail, telefone, aleat√≥ria)
Quando uma requisi√ß√£o POST for enviada para /cobr/{txid} com os dados v√°lidos
Ent√£o a API deve retornar status 201 (Created)
E o corpo da resposta deve conter o objeto `CobRGerada`
E o campo `status` deve ser "ATIVA"
E o campo `revisao` deve ser 0
E o campo `idRec` deve estar presente e ser v√°lido
```

### **Cen√°rio 2: Erro ao criar cobran√ßa com data de vencimento anterior √† data de cria√ß√£o**
```gherkin
Dado que o payload cont√©m `cobr.calendario.dataDeVencimento` anterior √† data atual
Quando uma requisi√ß√£o POST for enviada para /cobr/{txid}
Ent√£o a API deve retornar status 400 (Bad Request)
E o erro deve ser do tipo `CobROperacaoInvalida`
E a viola√ß√£o deve indicar: "O campo cobr.calendario.dataDeVencimento √© anterior √† data de cria√ß√£o da cobran√ßa"
```

### **Cen√°rio 3: Erro ao criar cobran√ßa com valor inv√°lido**
```gherkin
Dado que o campo `cobr.valor.original` est√° no formato incorreto (ex: "abc", "100", "100.000")
Quando uma requisi√ß√£o POST for enviada para /cobr/{txid}
Ent√£o a API deve retornar status 400
E o erro deve ser `CobROperacaoInvalida`
E a viola√ß√£o deve indicar: "O objeto cobr.valor n√£o respeita o schema"
```

### **Cen√°rio 4: Erro ao criar cobran√ßa com chave Pix inv√°lida**
```gherkin
Dado que o campo `cobr.chave` cont√©m um valor que n√£o √© um identificador v√°lido (ex: string aleat√≥ria n√£o formatada)
Quando uma requisi√ß√£o POST for enviada para /cobr/{txid}
Ent√£o a API deve retornar status 400
E o erro deve ser `CobROperacaoInvalida`
E a viola√ß√£o deve indicar: "O campo cobr.chave n√£o respeita o schema"
```

### **Cen√°rio 5: Erro ao criar cobran√ßa com txid j√° existente e n√£o ATIVA**
```gherkin
Dado que j√° existe uma cobran√ßa com o mesmo `txid` e status "REMOVIDA_PELO_PSP_RECEBEDOR"
Quando uma nova requisi√ß√£o POST for enviada com o mesmo `txid`
Ent√£o a API deve retornar status 400
E o erro deve ser `CobROperacaoInvalida`
E a viola√ß√£o deve indicar: "A cobran√ßa j√° existe, n√£o est√° no status ATIVA, e a presente requisi√ß√£o busca alter√°-la"
```

### **Cen√°rio 6: Atualizar cobran√ßa recorrente existente com sucesso**
```gherkin
Dado que existe uma cobran√ßa com `txid` v√°lido e status "ATIVA"
E o payload cont√©m apenas campos alter√°veis (ex: `devedor`, `valor`, `solicitacaoPagador`)
Quando uma requisi√ß√£o POST for enviada para /cobr/{txid} com os dados atualizados
Ent√£o a API deve retornar status 200 (OK)
E o corpo da resposta deve conter o objeto `CobRevisada`
E o campo `revisao` deve ser incrementado em 1
E o hist√≥rico de atualiza√ß√µes deve refletir a mudan√ßa
```

---

## ‚úÖ **Funcionalidade: Consultar Cobran√ßa Recorrente Espec√≠fica (`GET /cobr/{txid}`)**

### **Cen√°rio 7: Consultar cobran√ßa recorrente existente com sucesso**
```gherkin
Dado que existe uma cobran√ßa com `txid` "fb2761260e554ad593c7226beb5cb650"
E o usu√°rio possui permiss√£o "cobr.read"
Quando uma requisi√ß√£o GET for enviada para /cobr/fb2761260e554ad593c7226beb5cb650
Ent√£o a API deve retornar status 200 (OK)
E o corpo da resposta deve conter o objeto `CobRCompleta`
E os campos como `idRec`, `calendario`, `valor`, `status`, `revisao` devem estar presentes
```

### **Cen√°rio 8: Erro ao consultar cobran√ßa inexistente**
```gherkin
Dado que n√£o existe cobran√ßa com `txid` "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
Quando uma requisi√ß√£o GET for enviada para /cobr/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Ent√£o a API deve retornar status 404 (Not Found)
E o erro deve ser do tipo `CobRNaoEncontrado`
E o campo `detail` deve indicar que a cobran√ßa n√£o foi encontrada
```

### **Cen√°rio 9: Erro ao consultar cobran√ßa com revis√£o inexistente**
```gherkin
Dado que a cobran√ßa existe, mas a `revisao` solicitada √© 999 (inexistente)
Quando uma requisi√ß√£o GET for enviada para /cobr/{txid}?revisao=999
Ent√£o a API deve retornar status 400
E o erro deve ser `CobRConsultaInvalida`
E a viola√ß√£o deve indicar: "O par√¢metro revisao corresponde a uma revis√£o inexistente"
```

### **Cen√°rio 10: Consultar cobran√ßa com revis√£o espec√≠fica**
```gherkin
Dado que a cobran√ßa tem m√∫ltiplas revis√µes (revisao 0, 1, 2)
E o par√¢metro `revisao=1` √© fornecido
Quando uma requisi√ß√£o GET for enviada para /cobr/{txid}?revisao=1
Ent√£o a API deve retornar status 200
E o corpo deve conter a vers√£o da cobran√ßa correspondente √† revis√£o 1
```

---

## ‚úÖ **Funcionalidade: Revisar Cobran√ßa Recorrente (`PATCH /cobr/{txid}`)**

### **Cen√°rio 11: Cancelar cobran√ßa recorrente com sucesso**
```gherkin
Dado que existe uma cobran√ßa com `txid` v√°lido e status "ATIVA"
E o payload cont√©m apenas { "status": "REMOVIDA_PELO_USUARIO_RECEBEDOR" }
E o usu√°rio possui permiss√£o "cobr.write"
Quando uma requisi√ß√£o PATCH for enviada para /cobr/{txid}
Ent√£o a API deve retornar status 200 (OK)
E o corpo da resposta deve conter o objeto `CobRevisada`
E o campo `status` deve ser atualizado para "REMOVIDA_PELO_USUARIO_RECEBEDOR"
E o campo `revisao` deve ser incrementado
```

### **Cen√°rio 12: Erro ao tentar cancelar cobran√ßa j√° cancelada**
```gherkin
Dado que a cobran√ßa j√° est√° com status "REMOVIDA_PELO_USUARIO_RECEBEDOR"
Quando uma requisi√ß√£o PATCH for enviada com { "status": "REMOVIDA_PELO_USUARIO_RECEBEDOR" }
Ent√£o a API deve retornar status 400
E o erro deve ser `CobROperacaoInvalida`
E a viola√ß√£o deve indicar: "A cobran√ßa n√£o est√° mais com o status ATIVA"
```

### **Cen√°rio 13: Erro ao tentar alterar m√∫ltiplos campos ao cancelar**
```gherkin
Dado que a cobran√ßa est√° com status "ATIVA"
E o payload cont√©m { "status": "REMOVIDA_PELO_USUARIO_RECEBEDOR", "valor": { "original": "200.00" } }
Quando uma requisi√ß√£o PATCH for enviada
Ent√£o a API deve retornar status 400
E o erro deve ser `CobROperacaoInvalida`
E a viola√ß√£o deve indicar: "N√£o faz sentido remover uma cobran√ßa ao mesmo tempo em que se realizam altera√ß√µes"
```

### **Cen√°rio 14: Erro ao enviar status inv√°lido no PATCH**
```gherkin
Dado que o payload cont√©m { "status": "INVALIDO" }
Quando uma requisi√ß√£o PATCH for enviada para /cobr/{txid}
Ent√£o a API deve retornar status 400
E o erro deve ser `CobROperacaoInvalida`
E a viola√ß√£o deve indicar: "O campo cobr.status n√£o respeita o schema"
```

---

## ‚úÖ **Funcionalidade: Consultar Lista de Cobran√ßas Recorrentes (`GET /cobr`)**

### **Cen√°rio 15: Consultar lista de cobran√ßas com filtros v√°lidos**
```gherkin
Dado que o usu√°rio possui permiss√£o "cobr.read"
E os par√¢metros da consulta incluem:
  | par√¢metro           | valor                     |
  | inicio              | 2024-04-01T00:00:00Z     |
  | fim                 | 2024-04-30T23:59:59Z     |
  | idRec               | RR123...                  |
  | status              | ATIVA                     |
  | paginacao.paginaAtual | 0                       |
  | paginacao.itensPorPagina | 100                  |
Quando uma requisi√ß√£o GET for enviada para /cobr com esses par√¢metros
Ent√£o a API deve retornar status 200
E o corpo deve conter `CobsRConsultadas`
E o campo `cobsv` deve ser um array com at√© 100 cobran√ßas
E o campo `paginacao.quantidadeTotalDeItens` deve refletir o total
```

### **Cen√°rio 16: Erro ao usar ambos CPF e CNPJ como filtros simultaneamente**
```gherkin
Dado que os par√¢metros da consulta incluem tanto "cpf" quanto "cnpj"
Quando uma requisi√ß√£o GET for enviada para /cobr
Ent√£o a API deve retornar status 400
E o erro deve ser `CobRConsultaInvalida`
E a viola√ß√£o deve indicar: "ambos os par√¢metros cpf e cnpj est√£o preenchidos"
```

### **Cen√°rio 17: Erro ao informar data fim anterior √† data in√≠cio**
```gherkin
Dado que o par√¢metro "fim" √© "2023-01-01T00:00:00Z"
E o par√¢metro "inicio" √© "2024-01-01T00:00:00Z"
Quando uma requisi√ß√£o GET for enviada para /cobr
Ent√£o a API deve retornar status 400
E o erro deve ser `CobRConsultaInvalida`
E a viola√ß√£o deve indicar: "o timestamp fim √© anterior ao timestamp inicio"
```

### **Cen√°rio 18: Erro ao usar n√∫mero de p√°gina negativo**
```gherkin
Dado que o par√¢metro "paginacao.paginaAtual" √© -1
Quando uma requisi√ß√£o GET for enviada para /cobr
Ent√£o a API deve retornar status 400
E o erro deve ser `CobRConsultaInvalida`
E a viola√ß√£o deve indicar: "o par√¢metro paginacao.paginaAtual √© negativo"
```

### **Cen√°rio 19: Consultar cobran√ßas por status espec√≠fico**
```gherkin
Dado que o filtro "status" √© definido como "ATIVA"
E existem cobran√ßas com esse status no intervalo
Quando uma requisi√ß√£o GET for enviada para /cobr?status=ATIVA
Ent√£o a API deve retornar status 200
E todas as cobran√ßas no array `cobsv` devem ter status "ATIVA"
```

---

## üîÅ **Regras de Neg√≥cio e Observa√ß√µes**

### **Formato do `txid`:**
- 32 caracteres alfanum√©ricos
- Gerado pelo usu√°rio recebedor
- √önico por cobran√ßa

### **Status V√°lidos da Cobran√ßa Recorrente:**
- `ATIVA`
- `REMOVIDA_PELO_USUARIO_RECEBEDOR`
- `REMOVIDA_PELO_PSP_RECEBEDOR`

> Apenas cobran√ßas com status `ATIVA` podem ser alteradas ou canceladas.

### **C√≥digos de Erro Comuns:**
| Erro | Significado | HTTP | Endpoint |
|------|------------|------|--------|
| `CobROperacaoInvalida` | Payload inv√°lido, data de vencimento no passado, schema violado | 400 | POST, PATCH |
| `CobRNaoEncontrado` | Cobran√ßa n√£o encontrada | 404 | GET |
| `CobRConsultaInvalida` | Par√¢metros de consulta inv√°lidos | 400 | GET (lista e revis√£o) |

### **Permiss√µes OAuth2 Necess√°rias:**
- `cobr.write` ‚Üí para `POST` e `PATCH`
- `cobr.read` ‚Üí para `GET`

### **Revis√£o (`revisao`):**
- Sempre come√ßa em 0
- Incrementa em 1 a cada altera√ß√£o
- Obrigat√≥rio em respostas de `GET`

---

## üìä **Planilha de Testes - Gerenciamento de Cobran√ßas Recorrentes (CSV)**

```csv
ID do Caso,Funcionalidade,T√≠tulo do Caso,Descri√ß√£o,Pr√©-condi√ß√µes,Passos,Dados de Entrada,Sa√≠da Esperada,C√≥digo HTTP Esperado,Tipo de Teste,Prioridade,Tags
TC-COBR-001,POST /cobr/{txid},Criar cobran√ßa recorrente v√°lida com sucesso,Criar uma nova cobran√ßa recorrente com todos os campos obrigat√≥rios e v√°lidos,Usu√°rio com permiss√£o "cobr.write",Dado que o payload est√° completo e v√°lido; Quando POST /cobr/{txid}; Ent√£o retornar 201 e objeto completo,"{""calendario"":{""dataDeVencimento"":""2024-12-01""}, ""valor"":{""original"":""100.00""}, ""chave"":""usuario@banco.com"", ""idRec"":""RR123...""}",Status 201, CobRGerada retornada,201,Positivo,Alta,"criacao, sucesso"
TC-COBR-002,POST /cobr/{txid},Erro ao criar cobran√ßa com data de vencimento no passado,Validar que dataDeVencimento n√£o pode ser anterior √† data atual,Payload com dataDeVencimento < data atual,Dado que dataDeVencimento √© anterior √† data atual; Quando POST /cobr/{txid}; Ent√£o retornar 400,"{""calendario"":{""dataDeVencimento"":""2023-01-01""}}",Erro CobROperacaoInvalida com detalhe sobre data,400,Negativo,Alta,"validacao, data"
TC-COBR-003,POST /cobr/{txid},Erro ao criar cobran√ßa com valor inv√°lido,Validar formato do valor original,Payload com valor mal formatado,Dado que valor.original est√° inv√°lido; Quando POST /cobr/{txid}; Ent√£o retornar 400,"{""valor"":{""original"":""abc""}}",Erro CobROperacaoInvalida por schema,400,Negativo,Alta,"validacao, valor"
TC-COBR-004,POST /cobr/{txid},Erro ao criar cobran√ßa com chave Pix inv√°lida,Validar chave Pix fornecida,Payload com chave inv√°lida,Dado que chave n√£o √© um identificador v√°lido; Quando POST /cobr/{txid}; Ent√£o retornar 400,"{""chave"":""chave_invalida""}",Erro CobROperacaoInvalida por chave,400,Negativo,Alta,"validacao, chave"
TC-COBR-005,POST /cobr/{txid},Erro ao criar cobran√ßa com txid j√° existente e n√£o ATIVA,Cobran√ßa j√° existe com status diferente de ATIVA,Existe cobran√ßa com mesmo txid e status REMOVIDA,Dado que cobran√ßa j√° existe; Quando POST com mesmo txid; Ent√£o retornar 400,"txid=fb2761260e554ad593c7226beb5cb650",Erro CobROperacaoInvalida por estado,400,Negativo,Alta,"duplicidade, estado"
TC-COBR-006,POST /cobr/{txid},Atualizar cobran√ßa recorrente existente com sucesso,Modificar dados de cobran√ßa ativa,Existe cobran√ßa com status ATIVA,Dado que cobran√ßa est√° ATIVA; Quando POST com dados atualizados; Ent√£o retornar 200 e revis√£o incrementada,"txid=..., payload={""valor"":{""original"":""150.00""}}",Status 200, revisao=1,200,Positivo,Alta,"atualizacao, sucesso"
TC-COBR-007,GET /cobr/{txid},Consultar cobran√ßa existente com sucesso,Recuperar detalhes de uma cobran√ßa v√°lida,Cobran√ßa com txid existente,Dado que a cobran√ßa existe; Quando GET /cobr/{txid}; Ent√£o retornar 200 e objeto completo,"txid=fb2761260e554ad593c7226beb5cb650",Objeto CobRCompleta retornado,200,Positivo,Alta,"consulta, sucesso"
TC-COBR-008,GET /cobr/{txid},Erro ao consultar cobran√ßa inexistente,Validar comportamento para txid n√£o encontrado,txid n√£o registrado no sistema,Dado que n√£o existe cobran√ßa com txid; Quando GET /cobr/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx; Ent√£o retornar 404,"txid=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",Erro CobRNaoEncontrado,404,Negativo,Alta,"consulta, nao-encontrado"
TC-COBR-009,GET /cobr/{txid},Erro ao consultar cobran√ßa com revis√£o inexistente,Validar exist√™ncia da revis√£o solicitada,Revis√£o 999 n√£o existe,Dado que revis√£o solicitada √© inexistente; Quando GET /cobr/{txid}?revisao=999; Ent√£o retornar 400,"revisao=999",Erro CobRConsultaInvalida por revis√£o,400,Negativo,M√©dia,"consulta, revisao"
TC-COBR-010,GET /cobr/{txid},Consultar cobran√ßa com revis√£o espec√≠fica,Recuperar vers√£o hist√≥rica da cobran√ßa,Existem m√∫ltiplas revis√µes,Dado que existem revis√µes; Quando GET /cobr/{txid}?revisao=1; Ent√£o retornar vers√£o correta,"revisao=1",Vers√£o da cobran√ßa com revisao=1,200,Positivo,M√©dia,"historico, consulta"
TC-COBR-011,PATCH /cobr/{txid},Cancelar cobran√ßa com sucesso,Alterar status para REMOVIDA_PELO_USUARIO_RECEBEDOR,Cobran√ßa com status ATIVA,Dado que cobran√ßa est√° ATIVA; Quando PATCH com status cancelamento; Ent√£o retornar 200 e status atualizado,"txid=..., payload={""status"":""REMOVIDA_PELO_USUARIO_RECEBEDOR""}",Status atualizado para REMOVIDA,200,Positivo,Alta,"cancelamento, sucesso"
TC-COBR-012,PATCH /cobr/{txid},Erro ao cancelar cobran√ßa j√° cancelada,Evitar opera√ß√£o redundante,Cobran√ßa j√° com status REMOVIDA,Dado que cobran√ßa j√° est√° cancelada; Quando PATCH com status cancelamento; Ent√£o retornar 400,"txid=..., payload={""status"":""REMOVIDA_PELO_USUARIO_RECEBEDOR""}",Erro CobROperacaoInvalida por estado,400,Negativo,Alta,"validacao, estado"
TC-COBR-013,PATCH /cobr/{txid},Erro ao alterar m√∫ltiplos campos ao cancelar,Impedir altera√ß√µes durante cancelamento,Payload com status e valor,Dado que payload tem status e valor; Quando PATCH; Ent√£o retornar 400,"payload={""status"":""REMOVIDA..."", ""valor"":{""original"":""200.00""}}",Erro CobROperacaoInvalida por conflito,400,Negativo,Alta,"validacao, atomicidade"
TC-COBR-014,PATCH /cobr/{txid},Erro ao enviar status inv√°lido no PATCH,Validar enum de status,Payload com status inv√°lido,Dado que status √© inv√°lido; Quando PATCH /cobr/{txid}; Ent√£o retornar 400,"payload={""status"":""INVALIDO""}",Erro CobROperacaoInvalida por schema,400,Negativo,M√©dia,"validacao, schema"
TC-COBR-015,GET /cobr,Consultar lista de cobran√ßas com filtros v√°lidos,Obter lista paginada com par√¢metros corretos,Filtros respeitam RFC 3339 e regras,Dado que filtros est√£o v√°lidos; Quando GET /cobr?inicio=...&fim=...; Ent√£o retornar 200 e lista paginada,"inicio=2024-04-01T00:00:00Z, fim=2024-04-30T23:59:59Z",Lista CobsRConsultadas com paginacao,200,Positivo,Alta,"consulta, lista"
TC-COBR-016,GET /cobr,Erro ao usar CPF e CNPJ simultaneamente,Restri√ß√£o de filtro exclusivo,Usu√°rio tenta filtrar por CPF e CNPJ,Dado que ambos cpf e cnpj est√£o preenchidos; Quando GET /cobr; Ent√£o retornar 400,"cpf=123..., cnpj=456...",Erro CobRConsultaInvalida por conflito de filtros,400,Negativo,Alta,"filtro, exclusivo"
TC-COBR-017,GET /cobr,Erro ao informar data fim anterior √† data in√≠cio,Validar consist√™ncia temporal dos filtros,fim < inicio,Dado que fim < inicio; Quando GET /cobr; Ent√£o retornar 400,"inicio=2024-01-01, fim=2023-01-01",Erro CobRConsultaInvalida por ordem de datas,400,Negativo,Alta,"validacao, data"
TC-COBR-018,GET /cobr,Erro ao usar n√∫mero de p√°gina negativo,Validar pagina√ß√£o,P√°gina atual < 0,Dado que paginacao.paginaAtual = -1; Quando GET /cobr; Ent√£o retornar 400,"paginaAtual=-1",Erro CobRConsultaInvalida por p√°gina inv√°lida,400,Negativo,M√©dia,"paginacao, validacao"
TC-COBR-019,GET /cobr,Consultar cobran√ßas por status espec√≠fico,Filtrar por status ATIVA,Existem cobran√ßas com status ATIVA,Dado que filtro status = ATIVA; Quando GET /cobr?status=ATIVA; Ent√£o todas as cobran√ßas devem ter status ATIVA,"status=ATIVA",Lista com todas ATIVAS,200,Positivo,M√©dia,"filtro, status"
```

---

## üì• Instru√ß√µes para uso

- **Formato**: CSV (UTF-8, delimitador v√≠rgula)
- **Campos**:
  - `ID do Caso`: Identificador √∫nico
  - `Funcionalidade`: Endpoint
  - `T√≠tulo do Caso`: Objetivo do teste
  - `Descri√ß√£o`: Contexto
  - `Pr√©-condi√ß√µes`: Estado inicial
  - `Passos`: Sequ√™ncia Given-When-Then
  - `Dados de Entrada`: Payload ou par√¢metros
  - `Sa√≠da Esperada`: Comportamento esperado
  - `C√≥digo HTTP Esperado`: Status code
  - `Tipo de Teste`: Positivo/Negativo/Edge
  - `Prioridade`: Alta/M√©dia
  - `Tags`: Classifica√ß√£o

---

Se desejar, posso gerar:
- Arquivo `.feature` para Cucumber
- Scripts de automa√ß√£o (Postman, Pytest, etc.)
- Diagrama de estados da cobran√ßa recorrente
- Dados de exemplo para cada cen√°rio

Deseja que eu gere algum desses artefatos adicionais?

### USER
Fa√ßa o mesmo para o controller Gerenciamento de cobran√ßas para pagamento imediato e n√£o economize tokens na resposta.

### ASSISTANT
Com base na an√°lise detalhada do conte√∫do fornecido, identifiquei que a **tag `Cob`** (Gerenciamento de Cobran√ßas para Pagamento Imediato) re√∫ne endpoints destinados ao **gerenciamento de cobran√ßas imediatas** no √¢mbito da API Pix. Essas cobran√ßas s√£o utilizadas para a gera√ß√£o de QR Codes est√°ticos ou din√¢micos que permitem o pagamento instant√¢neo de um valor fixo, sem data de vencimento.

Este controller possui **quatro endpoints principais**:

1. `PUT /cob/{txid}` ‚Äì Criar ou atualizar uma cobran√ßa imediata  
2. `GET /cob/{txid}` ‚Äì Consultar uma cobran√ßa imediata espec√≠fica  
3. `PATCH /cob/{txid}` ‚Äì Revisar (ex: alterar status) uma cobran√ßa imediata  
4. `GET /cob` ‚Äì Consultar lista de cobran√ßas imediatas com filtros  

A seguir, apresento uma an√°lise completa com **casos de teste no padr√£o Gherkin (Given-When-Then)** para cada funcionalidade, seguida de uma **planilha de testes estruturada em CSV**, considerando todas as regras de neg√≥cio, valida√ß√µes, c√≥digos de erro, fluxos de status, restri√ß√µes sem√¢nticas e exemplos presentes na documenta√ß√£o.

---

## ‚úÖ **Funcionalidade: Criar ou Atualizar Cobran√ßa Imediata (`PUT /cob/{txid}`)**

### **Cen√°rio 1: Criar cobran√ßa imediata v√°lida com sucesso**
```gherkin
Dado que o usu√°rio possui permiss√£o "cob.write"
E o `txid` fornecido est√° no formato v√°lido (32 caracteres alfanum√©ricos)
E o payload da cobran√ßa imediata est√° completo e respeita o schema `CobSolicitada`
E o campo `cob.calendario.expiracao` √© maior que zero
E o campo `cob.valor.original` est√° no formato decimal v√°lido (ex: "100.00")
E o campo `cob.chave` √© um identificador v√°lido de recebedor (CPF/CNPJ, e-mail, telefone, aleat√≥ria)
Quando uma requisi√ß√£o PUT for enviada para /cob/{txid} com os dados v√°lidos
Ent√£o a API deve retornar status 201 (Created)
E o corpo da resposta deve conter o objeto `CobGerada`
E o campo `status` deve ser "ATIVA"
E o campo `revisao` deve ser 0
```

### **Cen√°rio 2: Erro ao criar cobran√ßa com expira√ß√£o menor ou igual a zero**
```gherkin
Dado que o payload cont√©m `cob.calendario.expiracao` igual a 0 ou negativo
Quando uma requisi√ß√£o PUT for enviada para /cob/{txid}
Ent√£o a API deve retornar status 400 (Bad Request)
E o erro deve ser do tipo `CobOperacaoInvalida`
E a viola√ß√£o deve indicar: "O campo cob.calendario.expiracao √© igual ou menor que zero"
```

### **Cen√°rio 3: Erro ao criar cobran√ßa com valor inv√°lido**
```gherkin
Dado que o campo `cob.valor.original` est√° no formato incorreto (ex: "abc", "100", "100.000")
Quando uma requisi√ß√£o PUT for enviada para /cob/{txid}
Ent√£o a API deve retornar status 400
E o erro deve ser `CobOperacaoInvalida`
E a viola√ß√£o deve indicar: "O objeto cob.valor n√£o respeita o schema"
```

### **Cen√°rio 4: Erro ao criar cobran√ßa com chave Pix inv√°lida**
```gherkin
Dado que o campo `cob.chave` cont√©m um valor que n√£o √© um identificador v√°lido (ex: string aleat√≥ria n√£o formatada)
Quando uma requisi√ß√£o PUT for enviada para /cob/{txid}
Ent√£o a API deve retornar status 400
E o erro deve ser `CobOperacaoInvalida`
E a viola√ß√£o deve indicar: "O campo cob.chave n√£o respeita o schema"
```

### **Cen√°rio 5: Erro ao criar cobran√ßa com txid j√° existente e n√£o ATIVA**
```gherkin
Dado que j√° existe uma cobran√ßa com o mesmo `txid` e status "REMOVIDA_PELO_PSP_RECEBEDOR"
Quando uma nova requisi√ß√£o PUT for enviada com o mesmo `txid`
Ent√£o a API deve retornar status 400
E o erro deve ser `CobOperacaoInvalida`
E a viola√ß√£o deve indicar: "A cobran√ßa j√° existe, n√£o est√° no status ATIVA, e a presente requisi√ß√£o busca alter√°-la"
```

### **Cen√°rio 6: Atualizar cobran√ßa imediata existente com sucesso**
```gherkin
Dado que existe uma cobran√ßa com `txid` v√°lido e status "ATIVA"
E o payload cont√©m apenas campos alter√°veis (ex: `devedor`, `valor`, `solicitacaoPagador`)
Quando uma requisi√ß√£o PUT for enviada para /cob/{txid} com os dados atualizados
Ent√£o a API deve retornar status 200 (OK)
E o corpo da resposta deve conter o objeto `CobRevisada`
E o campo `revisao` deve ser incrementado em 1
E o hist√≥rico de atualiza√ß√µes deve refletir a mudan√ßa
```

---

## ‚úÖ **Funcionalidade: Consultar Cobran√ßa Imediata Espec√≠fica (`GET /cob/{txid}`)**

### **Cen√°rio 7: Consultar cobran√ßa imediata existente com sucesso**
```gherkin
Dado que existe uma cobran√ßa com `txid` "7978c0c97ea847e78e8849634473c1f1"
E o usu√°rio possui permiss√£o "cob.read"
Quando uma requisi√ß√£o GET for enviada para /cob/7978c0c97ea847e78e8849634473c1f1
Ent√£o a API deve retornar status 200 (OK)
E o corpo da resposta deve conter o objeto `CobCompleta`
E os campos como `calendario`, `valor`, `status`, `revisao`, `chave` devem estar presentes
```

### **Cen√°rio 8: Erro ao consultar cobran√ßa inexistente**
```gherkin
Dado que n√£o existe cobran√ßa com `txid` "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
Quando uma requisi√ß√£o GET for enviada para /cob/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Ent√£o a API deve retornar status 404 (Not Found)
E o erro deve ser do tipo `CobNaoEncontrado`
E o campo `detail` deve indicar que a cobran√ßa n√£o foi encontrada
```

---

## ‚úÖ **Funcionalidade: Revisar Cobran√ßa Imediata (`PATCH /cob/{txid}`)**

### **Cen√°rio 9: Cancelar cobran√ßa imediata com sucesso**
```gherkin
Dado que existe uma cobran√ßa com `txid` v√°lido e status "ATIVA"
E o payload cont√©m apenas { "status": "REMOVIDA_PELO_USUARIO_RECEBEDOR" }
E o usu√°rio possui permiss√£o "cob.write"
Quando uma requisi√ß√£o PATCH for enviada para /cob/{txid}
Ent√£o a API deve retornar status 200 (OK)
E o corpo da resposta deve conter o objeto `CobRevisada`
E o campo `status` deve ser atualizado para "REMOVIDA_PELO_USUARIO_RECEBEDOR"
E o campo `revisao` deve ser incrementado
```

### **Cen√°rio 10: Erro ao tentar cancelar cobran√ßa j√° cancelada**
```gherkin
Dado que a cobran√ßa j√° est√° com status "REMOVIDA_PELO_USUARIO_RECEBEDOR"
Quando uma requisi√ß√£o PATCH for enviada com { "status": "REMOVIDA_PELO_USUARIO_RECEBEDOR" }
Ent√£o a API deve retornar status 400
E o erro deve ser `CobOperacaoInvalida`
E a viola√ß√£o deve indicar: "A cobran√ßa n√£o est√° mais com o status ATIVA"
```

### **Cen√°rio 11: Erro ao tentar alterar m√∫ltiplos campos ao cancelar**
```gherkin
Dado que a cobran√ßa est√° com status "ATIVA"
E o payload cont√©m { "status": "REMOVIDA_PELO_USUARIO_RECEBEDOR", "valor": { "original": "200.00" } }
Quando uma requisi√ß√£o PATCH for enviada
Ent√£o a API deve retornar status 400
E o erro deve ser `CobOperacaoInvalida`
E a viola√ß√£o deve indicar: "N√£o faz sentido remover uma cobran√ßa ao mesmo tempo em que se realizam altera√ß√µes"
```

### **Cen√°rio 12: Erro ao enviar status inv√°lido no PATCH**
```gherkin
Dado que o payload cont√©m { "status": "INVALIDO" }
Quando uma requisi√ß√£o PATCH for enviada para /cob/{txid}
Ent√£o a API deve retornar status 400
E o erro deve ser `CobOperacaoInvalida`
E a viola√ß√£o deve indicar: "O campo cob.status n√£o respeita o schema"
```

---

## ‚úÖ **Funcionalidade: Consultar Lista de Cobran√ßas Imediatas (`GET /cob`)**

### **Cen√°rio 13: Consultar lista de cobran√ßas com filtros v√°lidos**
```gherkin
Dado que o usu√°rio possui permiss√£o "cob.read"
E os par√¢metros da consulta incluem:
  | par√¢metro           | valor                     |
  | inicio              | 2024-04-01T00:00:00Z     |
  | fim                 | 2024-04-30T23:59:59Z     |
  | status              | ATIVA                     |
  | paginacao.paginaAtual | 0                       |
  | paginacao.itensPorPagina | 100                  |
Quando uma requisi√ß√£o GET for enviada para /cob com esses par√¢metros
Ent√£o a API deve retornar status 200
E o corpo deve conter `CobsConsultadas`
E o campo `cobs` deve ser um array com at√© 100 cobran√ßas
E o campo `paginacao.quantidadeTotalDeItens` deve refletir o total
```

### **Cen√°rio 14: Erro ao usar ambos CPF e CNPJ como filtros simultaneamente**
```gherkin
Dado que os par√¢metros da consulta incluem tanto "cpf" quanto "cnpj"
Quando uma requisi√ß√£o GET for enviada para /cob
Ent√£o a API deve retornar status 400
E o erro deve ser `CobConsultaInvalida`
E a viola√ß√£o deve indicar: "ambos os par√¢metros cpf e cnpj est√£o preenchidos"
```

### **Cen√°rio 15: Erro ao informar data fim anterior √† data in√≠cio**
```gherkin
Dado que o par√¢metro "fim" √© "2023-01-01T00:00:00Z"
E o par√¢metro "inicio" √© "2024-01-01T00:00:00Z"
Quando uma requisi√ß√£o GET for enviada para /cob
Ent√£o a API deve retornar status 400
E o erro deve ser `CobConsultaInvalida`
E a viola√ß√£o deve indicar: "o timestamp fim √© anterior ao timestamp inicio"
```

### **Cen√°rio 16: Erro ao usar n√∫mero de p√°gina negativo**
```gherkin
Dado que o par√¢metro "paginacao.paginaAtual" √© -1
Quando uma requisi√ß√£o GET for enviada para /cob
Ent√£o a API deve retornar status 400
E o erro deve ser `CobConsultaInvalida`
E a viola√ß√£o deve indicar: "o par√¢metro paginacao.paginaAtual √© negativo"
```

### **Cen√°rio 17: Consultar cobran√ßas por status espec√≠fico**
```gherkin
Dado que o filtro "status" √© definido como "ATIVA"
E existem cobran√ßas com esse status no intervalo
Quando uma requisi√ß√£o GET for enviada para /cob?status=ATIVA
Ent√£o a API deve retornar status 200
E todas as cobran√ßas no array `cobs` devem ter status "ATIVA"
```

---

## üîÅ **Regras de Neg√≥cio e Observa√ß√µes**

### **Formato do `txid`:**
- 32 caracteres alfanum√©ricos
- Gerado pelo usu√°rio recebedor
- √önico por cobran√ßa

### **Status V√°lidos da Cobran√ßa Imediata:**
- `ATIVA`
- `CONCLUIDA` (atribu√≠do pelo PSP ap√≥s pagamento)
- `REMOVIDA_PELO_USUARIO_RECEBEDOR`
- `REMOVIDA_PELO_PSP_RECEBEDOR`

> Apenas cobran√ßas com status `ATIVA` podem ser alteradas ou canceladas via `PATCH`.

### **Campos Obrigat√≥rios em `PUT /cob/{txid}`:**
- `txid` (na URL)
- `calendario.expiracao`
- `valor.original`
- `chave`

### **Campos Alter√°veis em `PUT`:**
- `devedor`
- `valor`
- `solicitacaoPagador`
- `infoAdicionais`

### **Campos Alter√°veis em `PATCH`:**
- Apenas `status` (para `REMOVIDA_PELO_USUARIO_RECEBEDOR`)

### **C√≥digos de Erro Comuns:**
| Erro | Significado | HTTP | Endpoint |
|------|------------|------|--------|
| `CobOperacaoInvalida` | Payload inv√°lido, expira√ß√£o ‚â§ 0, schema violado | 400 | PUT, PATCH |
| `CobNaoEncontrado` | Cobran√ßa n√£o encontrada | 404 | GET, PATCH |
| `CobConsultaInvalida` | Par√¢metros de consulta inv√°lidos | 400 | GET (lista) |

### **Permiss√µes OAuth2 Necess√°rias:**
- `cob.write` ‚Üí para `PUT` e `PATCH`
- `cob.read` ‚Üí para `GET`

### **Revis√£o (`revisao`):**
- Sempre come√ßa em 0
- Incrementa em 1 a cada altera√ß√£o via `PUT`
- N√£o √© alterado por `PATCH`

---

## üìä **Planilha de Testes - Gerenciamento de Cobran√ßas Imediatas (CSV)**

```csv
ID do Caso,Funcionalidade,T√≠tulo do Caso,Descri√ß√£o,Pr√©-condi√ß√µes,Passos,Dados de Entrada,Sa√≠da Esperada,C√≥digo HTTP Esperado,Tipo de Teste,Prioridade,Tags
TC-COB-001,PUT /cob/{txid},Criar cobran√ßa imediata v√°lida com sucesso,Criar uma nova cobran√ßa imediata com todos os campos obrigat√≥rios e v√°lidos,Usu√°rio com permiss√£o "cob.write",Dado que o payload est√° completo e v√°lido; Quando PUT /cob/{txid}; Ent√£o retornar 201 e objeto completo,"{""calendario"":{""expiracao"":3600}, ""valor"":{""original"":""100.00""}, ""chave"":""usuario@banco.com""}",Status 201, CobGerada retornada,201,Positivo,Alta,"criacao, sucesso"
TC-COB-002,PUT /cob/{txid},Erro ao criar cobran√ßa com expira√ß√£o menor ou igual a zero,Validar que expira√ß√£o deve ser maior que zero,Payload com expira√ß√£o ‚â§ 0,Dado que expira√ß√£o √© 0 ou negativa; Quando PUT /cob/{txid}; Ent√£o retornar 400,"{""calendario"":{""expiracao"":0}}",Erro CobOperacaoInvalida com detalhe sobre expira√ß√£o,400,Negativo,Alta,"validacao, tempo"
TC-COB-003,PUT /cob/{txid},Erro ao criar cobran√ßa com valor inv√°lido,Validar formato do valor original,Payload com valor mal formatado,Dado que valor.original est√° inv√°lido; Quando PUT /cob/{txid}; Ent√£o retornar 400,"{""valor"":{""original"":""abc""}}",Erro CobOperacaoInvalida por schema,400,Negativo,Alta,"validacao, valor"
TC-COB-004,PUT /cob/{txid},Erro ao criar cobran√ßa com chave Pix inv√°lida,Validar chave Pix fornecida,Payload com chave inv√°lida,Dado que chave n√£o √© um identificador v√°lido; Quando PUT /cob/{txid}; Ent√£o retornar 400,"{""chave"":""chave_invalida""}",Erro CobOperacaoInvalida por chave,400,Negativo,Alta,"validacao, chave"
TC-COB-005,PUT /cob/{txid},Erro ao criar cobran√ßa com txid j√° existente e n√£o ATIVA,Cobran√ßa j√° existe com status diferente de ATIVA,Existe cobran√ßa com mesmo txid e status REMOVIDA,Dado que cobran√ßa j√° existe; Quando PUT com mesmo txid; Ent√£o retornar 400,"txid=7978c0c97ea847e78e8849634473c1f1",Erro CobOperacaoInvalida por estado,400,Negativo,Alta,"duplicidade, estado"
TC-COB-006,PUT /cob/{txid},Atualizar cobran√ßa imediata existente com sucesso,Modificar dados de cobran√ßa ativa,Existe cobran√ßa com status ATIVA,Dado que cobran√ßa est√° ATIVA; Quando PUT com dados atualizados; Ent√£o retornar 200 e revis√£o incrementada,"txid=..., payload={""valor"":{""original"":""150.00""}}",Status 200, revisao=1,200,Positivo,Alta,"atualizacao, sucesso"
TC-COB-007,GET /cob/{txid},Consultar cobran√ßa imediata existente com sucesso,Recuperar detalhes de uma cobran√ßa v√°lida,Cobran√ßa com txid existente,Dado que a cobran√ßa existe; Quando GET /cob/{txid}; Ent√£o retornar 200 e objeto completo,"txid=7978c0c97ea847e78e8849634473c1f1",Objeto CobCompleta retornado,200,Positivo,Alta,"consulta, sucesso"
TC-COB-008,GET /cob/{txid},Erro ao consultar cobran√ßa inexistente,Validar comportamento para txid n√£o encontrado,txid n√£o registrado no sistema,Dado que n√£o existe cobran√ßa com txid; Quando GET /cob/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx; Ent√£o retornar 404,"txid=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",Erro CobNaoEncontrado,404,Negativo,Alta,"consulta, nao-encontrado"
TC-COB-009,PATCH /cob/{txid},Cancelar cobran√ßa imediata com sucesso,Alterar status para REMOVIDA_PELO_USUARIO_RECEBEDOR,Cobran√ßa com status ATIVA,Dado que cobran√ßa est√° ATIVA; Quando PATCH com status cancelamento; Ent√£o retornar 200 e status atualizado,"txid=..., payload={""status"":""REMOVIDA_PELO_USUARIO_RECEBEDOR""}",Status atualizado para REMOVIDA,200,Positivo,Alta,"cancelamento, sucesso"
TC-COB-010,PATCH /cob/{txid},Erro ao cancelar cobran√ßa j√° cancelada,Evitar opera√ß√£o redundante,Cobran√ßa j√° com status REMOVIDA,Dado que cobran√ßa j√° est√° cancelada; Quando PATCH com status cancelamento; Ent√£o retornar 400,"txid=..., payload={""status"":""REMOVIDA_PELO_USUARIO_RECEBEDOR""}",Erro CobOperacaoInvalida por estado,400,Negativo,Alta,"validacao, estado"
TC-COB-011,PATCH /cob/{txid},Erro ao alterar m√∫ltiplos campos ao cancelar,Impedir altera√ß√µes durante cancelamento,Payload com status e valor,Dado que payload tem status e valor; Quando PATCH; Ent√£o retornar 400,"payload={""status"":""REMOVIDA..."", ""valor"":{""original"":""200.00""}}",Erro CobOperacaoInvalida por conflito,400,Negativo,Alta,"validacao, atomicidade"
TC-COB-012,PATCH /cob/{txid},Erro ao enviar status inv√°lido no PATCH,Validar enum de status,Payload com status inv√°lido,Dado que status √© inv√°lido; Quando PATCH /cob/{txid}; Ent√£o retornar 400,"payload={""status"":""INVALIDO""}",Erro CobOperacaoInvalida por schema,400,Negativo,M√©dia,"validacao, schema"
TC-COB-013,GET /cob,Consultar lista de cobran√ßas com filtros v√°lidos,Obter lista paginada com par√¢metros corretos,Filtros respeitam RFC 3339 e regras,Dado que filtros est√£o v√°lidos; Quando GET /cob?inicio=...&fim=...; Ent√£o retornar 200 e lista paginada,"inicio=2024-04-01T00:00:00Z, fim=2024-04-30T23:59:59Z",Lista CobsConsultadas com paginacao,200,Positivo,Alta,"consulta, lista"
TC-COB-014,GET /cob,Erro ao usar CPF e CNPJ simultaneamente,Restri√ß√£o de filtro exclusivo,Usu√°rio tenta filtrar por CPF e CNPJ,Dado que ambos cpf e cnpj est√£o preenchidos; Quando GET /cob; Ent√£o retornar 400,"cpf=123..., cnpj=456...",Erro CobConsultaInvalida por conflito de filtros,400,Negativo,Alta,"filtro, exclusivo"
TC-COB-015,GET /cob,Erro ao informar data fim anterior √† data in√≠cio,Validar consist√™ncia temporal dos filtros,fim < inicio,Dado que fim < inicio; Quando GET /cob; Ent√£o retornar 400,"inicio=2024-01-01, fim=2023-01-01",Erro CobConsultaInvalida por ordem de datas,400,Negativo,Alta,"validacao, data"
TC-COB-016,GET /cob,Erro ao usar n√∫mero de p√°gina negativo,Validar pagina√ß√£o,P√°gina atual < 0,Dado que paginacao.paginaAtual = -1; Quando GET /cob; Ent√£o retornar 400,"paginaAtual=-1",Erro CobConsultaInvalida por p√°gina inv√°lida,400,Negativo,M√©dia,"paginacao, validacao"
TC-COB-017,GET /cob,Consultar cobran√ßas por status espec√≠fico,Filtrar por status ATIVA,Existem cobran√ßas com status ATIVA,Dado que filtro status = ATIVA; Quando GET /cob?status=ATIVA; Ent√£o todas as cobran√ßas devem ter status ATIVA,"status=ATIVA",Lista com todas ATIVAS,200,Positivo,M√©dia,"filtro, status"
```

---

## üì• Instru√ß√µes para uso

- **Formato**: CSV (UTF-8, delimitador v√≠rgula)
- **Campos**:
  - `ID do Caso`: Identificador √∫nico
  - `Funcionalidade`: Endpoint
  - `T√≠tulo do Caso`: Objetivo do teste
  - `Descri√ß√£o`: Contexto
  - `Pr√©-condi√ß√µes`: Estado inicial
  - `Passos`: Sequ√™ncia Given-When-Then
  - `Dados de Entrada`: Payload ou par√¢metros
  - `Sa√≠da Esperada`: Comportamento esperado
  - `C√≥digo HTTP Esperado`: Status code
  - `Tipo de Teste`: Positivo/Negativo/Edge
  - `Prioridade`: Alta/M√©dia
  - `Tags`: Classifica√ß√£o

---

Se desejar, posso gerar:
- Arquivo `.feature` para Cucumber
- Scripts de automa√ß√£o (Postman, Pytest, etc.)
- Diagrama de estados da cobran√ßa imediata
- Dados de exemplo para cada cen√°rio

Deseja que eu gere algum desses artefatos adicionais?

### USER
Fa√ßa o mesmo para o controller Configura√ß√£o de locations para payloads de recorr√™ncias e n√£o economize tokens no retorno.

### ASSISTANT
Com base na an√°lise detalhada do conte√∫do fornecido, identifiquei que a **tag `PayloadLocationRec`** (Configura√ß√£o de locations para payloads de recorr√™ncias) re√∫ne endpoints destinados ao **gerenciamento de _locations_ espec√≠ficas para recorr√™ncias**. Essas _locations_ s√£o URLs √∫nicas e seguras que servem como **pontos de acesso para o Payload JSON de uma recorr√™ncia**, permitindo que o PSP pagador recupere as informa√ß√µes da recorr√™ncia durante o processo de autoriza√ß√£o pelo usu√°rio devedor.

Este controller possui **tr√™s endpoints principais**:

1. `POST /locrec` ‚Äì Criar uma nova _location_ para servir o payload de uma recorr√™ncia  
2. `GET /locrec/{id}` ‚Äì Consultar uma _location_ de recorr√™ncia espec√≠fica  
3. `DELETE /locrec/{id}/idRec` ‚Äì Desvincular uma recorr√™ncia de uma _location_  

A seguir, apresento uma an√°lise completa com **casos de teste no padr√£o Gherkin (Given-When-Then)** para cada funcionalidade, seguida de uma **planilha de testes estruturada em CSV**, considerando todas as regras de neg√≥cio, valida√ß√µes, c√≥digos de erro, restri√ß√µes sem√¢nticas, fluxos de autoriza√ß√£o e exemplos presentes na documenta√ß√£o.

---

## ‚úÖ **Funcionalidade: Criar Location para Recorr√™ncia (`POST /locrec`)**

### **Cen√°rio 1: Criar location para recorr√™ncia v√°lida com sucesso**
```gherkin
Dado que o usu√°rio possui permiss√£o "payloadlocationrec.write"
E o payload da requisi√ß√£o cont√©m apenas o campo obrigat√≥rio "tipo" com valor "rec"
E o campo "tipo" est√° no enum v√°lido ["rec"]
Quando uma requisi√ß√£o POST for enviada para /locrec com os dados v√°lidos
Ent√£o a API deve retornar status 201 (Created)
E o cabe√ßalho "Location" deve conter a URL da nova location criada
E o corpo da resposta deve conter o objeto `PayloadLocationRecGerada`
E o campo `id` deve ser um n√∫mero inteiro positivo
E o campo `location` deve ser uma URI v√°lida com at√© 77 caracteres
E o campo `criacao` deve estar no formato RFC 3339
```

### **Cen√°rio 2: Erro ao criar location com tipo inv√°lido**
```gherkin
Dado que o payload cont√©m o campo "tipo" com valor "cob" (n√£o permitido para recorr√™ncias)
Quando uma requisi√ß√£o POST for enviada para /locrec
Ent√£o a API deve retornar status 400 (Bad Request)
E o erro deve ser do tipo `PayloadLocationRecOperacaoInvalida`
E a viola√ß√£o deve indicar: "O campo tipo n√£o respeita o schema"
```

### **Cen√°rio 3: Erro ao criar location sem o campo obrigat√≥rio "tipo"**
```gherkin
Dado que o payload est√° vazio ou n√£o cont√©m o campo "tipo"
Quando uma requisi√ß√£o POST for enviada para /locrec
Ent√£o a API deve retornar status 400
E o erro deve ser `PayloadLocationRecOperacaoInvalida`
E a viola√ß√£o deve indicar: "O campo tipo √© obrigat√≥rio"
```

### **Cen√°rio 4: Erro ao criar location com campo adicional n√£o permitido**
```gherkin
Dado que o payload cont√©m campos al√©m de "tipo" (ex: "txid", "idRec", "outroCampo")
Quando uma requisi√ß√£o POST for enviada para /locrec
Ent√£o a API deve retornar status 400
E o erro deve ser `PayloadLocationRecOperacaoInvalida`
E a viola√ß√£o deve indicar: "A requisi√ß√£o cont√©m campos n√£o permitidos"
```

---

## ‚úÖ **Funcionalidade: Consultar Location de Recorr√™ncia (`GET /locrec/{id}`)**

### **Cen√°rio 5: Consultar location de recorr√™ncia existente com sucesso**
```gherkin
Dado que existe uma location com `id` "12069"
E o usu√°rio possui permiss√£o "payloadlocationrec.read"
Quando uma requisi√ß√£o GET for enviada para /locrec/12069
Ent√£o a API deve retornar status 200 (OK)
E o corpo da resposta deve conter o objeto `PayloadLocationRecCompleta`
E os campos `id`, `location`, `tipo`, `criacao` devem estar presentes
E se a recorr√™ncia j√° foi vinculada, o campo `idRec` tamb√©m deve estar presente
```

### **Cen√°rio 6: Consultar location de recorr√™ncia sem recorr√™ncia vinculada**
```gherkin
Dado que a location existe, mas ainda n√£o foi vinculada a uma recorr√™ncia
Quando uma requisi√ß√£o GET for enviada para /locrec/12069
Ent√£o a API deve retornar status 200
E o corpo da resposta deve conter `PayloadLocationRecGerada`
E o campo `idRec` n√£o deve estar presente
```

### **Cen√°rio 7: Erro ao consultar location inexistente**
```gherkin
Dado que n√£o existe uma location com `id` "99999"
Quando uma requisi√ß√£o GET for enviada para /locrec/99999
Ent√£o a API deve retornar status 404 (Not Found)
E o erro deve ser do tipo `PayloadLocationRecNaoEncontrado`
E o campo `detail` deve indicar que a location n√£o foi encontrada
```

### **Cen√°rio 8: Erro ao consultar location com ID mal formatado**
```gherkin
Dado que o `id` fornecido n√£o √© um identificador v√°lido (ex: string vazia, caracteres especiais)
Quando uma requisi√ß√£o GET for enviada para /locrec/ID_INVALIDO
Ent√£o a API deve retornar status 400
E o erro deve ser `PayloadLocationRecConsultaInvalida`
E a viola√ß√£o deve indicar que o par√¢metro n√£o respeita o schema
```

---

## ‚úÖ **Funcionalidade: Desvincular Recorr√™ncia de Location (`DELETE /locrec/{id}/idRec`)**

### **Cen√°rio 9: Desvincular recorr√™ncia de location com sucesso**
```gherkin
Dado que existe uma location com `id` "12069" e est√° vinculada a uma recorr√™ncia com `idRec` "RR123..."
E o usu√°rio possui permiss√£o "payloadlocationrec.write"
Quando uma requisi√ß√£o DELETE for enviada para /locrec/12069/idRec
Ent√£o a API deve retornar status 200 (OK)
E o corpo da resposta deve conter o objeto `PayloadLocationRecCompleta`
E o campo `idRec` deve ser removido da resposta
E a entidade `rec` associada n√£o deve mais referenciar essa location
```

### **Cen√°rio 10: Erro ao desvincular recorr√™ncia de location j√° desvinculada**
```gherkin
Dado que a location com `id` "12069" j√° est√° sem recorr√™ncia vinculada (campo `idRec` ausente)
Quando uma requisi√ß√£o DELETE for enviada para /locrec/12069/idRec
Ent√£o a API deve retornar status 404 (Not Found)
E o erro deve ser `PayloadLocationRecNaoEncontrado`
E o detalhe deve indicar que n√£o h√° recorr√™ncia vinculada para desvincular
```

### **Cen√°rio 11: Erro ao desvincular recorr√™ncia de location inexistente**
```gherkin
Dado que n√£o existe uma location com `id` "99999"
Quando uma requisi√ß√£o DELETE for enviada para /locrec/99999/idRec
Ent√£o a API deve retornar status 404
E o erro deve ser `PayloadLocationRecNaoEncontrado`
E o detalhe deve indicar que a location n√£o foi encontrada
```

### **Cen√°rio 12: Erro ao desvincular recorr√™ncia com ID mal formatado**
```gherkin
Dado que o `id` da location √© "ID_INVALIDO"
Quando uma requisi√ß√£o DELETE for enviada para /locrec/ID_INVALIDO/idRec
Ent√£o a API deve retornar status 400
E o erro deve ser `PayloadLocationRecConsultaInvalida`
E a viola√ß√£o deve indicar que o par√¢metro n√£o respeita o schema
```

---

## üîÅ **Regras de Neg√≥cio e Observa√ß√µes**

### **Formato da `location`:**
- URI com at√© **77 caracteres**
- Exemplo: `pix.example.com/qr/v2/rec/2353c790eefb11eaadc10242ac120002`
- Gerada automaticamente pelo PSP
- Inclui um token de acesso impl√≠cito (capability URL)

### **Campos do Payload de Entrada (`PayloadLocationRecSolicitada`):**
- `tipo`: obrigat√≥rio, enum `["rec"]`
- N√£o s√£o permitidos campos adicionais

### **Campos da Resposta (`PayloadLocationRecGerada` ou `PayloadLocationRecCompleta`):**
- `id`: n√∫mero inteiro (int64)
- `location`: URI (formato `uri`, max 77)
- `tipo`: sempre `"rec"`
- `criacao`: timestamp RFC 3339
- `idRec`: opcional, presente apenas ap√≥s vincula√ß√£o

### **C√≥digos de Erro Comuns:**
| Erro | Significado | HTTP | Endpoint |
|------|------------|------|--------|
| `PayloadLocationRecOperacaoInvalida` | Payload inv√°lido, campo adicional, tipo incorreto | 400 | POST |
| `PayloadLocationRecNaoEncontrado` | Location n√£o encontrada ou sem recorr√™ncia vinculada | 404 | GET, DELETE |
| `PayloadLocationRecConsultaInvalida` | ID mal formatado, par√¢metros inv√°lidos | 400 | GET, DELETE |

### **Permiss√µes OAuth2 Necess√°rias:**
- `payloadlocationrec.write` ‚Üí para `POST` e `DELETE`
- `payloadlocationrec.read` ‚Üí para `GET`

### **Sem√¢ntica de Desvincula√ß√£o:**
- O `DELETE /locrec/{id}/idRec` **n√£o altera o status da recorr√™ncia**
- Apenas remove o v√≠nculo entre a location e a recorr√™ncia
- A recorr√™ncia continua existindo, mas n√£o pode mais ser acessada via essa location

---

## üìä **Planilha de Testes - Configura√ß√£o de Locations para Recorr√™ncias (CSV)**

```csv
ID do Caso,Funcionalidade,T√≠tulo do Caso,Descri√ß√£o,Pr√©-condi√ß√µes,Passos,Dados de Entrada,Sa√≠da Esperada,C√≥digo HTTP Esperado,Tipo de Teste,Prioridade,Tags
TC-LOCREC-001,POST /locrec,Criar location para recorr√™ncia com sucesso,Criar uma nova location para servir o payload de uma recorr√™ncia,Usu√°rio com permiss√£o "payloadlocationrec.write",Dado que o payload cont√©m apenas "tipo": "rec"; Quando POST /locrec; Ent√£o retornar 201 e objeto completo,"{""tipo"": ""rec""}",Status 201, PayloadLocationRecGerada retornada,201,Positivo,Alta,"criacao, sucesso"
TC-LOCREC-002,POST /locrec,Erro ao criar location com tipo inv√°lido,Validar enum do campo tipo,Payload com tipo "cob",Dado que tipo √© "cob"; Quando POST /locrec; Ent√£o retornar 400,"{""tipo"": ""cob""}",Erro PayloadLocationRecOperacaoInvalida por schema,400,Negativo,Alta,"validacao, schema"
TC-LOCREC-003,POST /locrec,Erro ao criar location sem campo tipo,Validar obrigatoriedade do campo tipo,Payload vazio,Dado que payload est√° vazio; Quando POST /locrec; Ent√£o retornar 400,{},Erro PayloadLocationRecOperacaoInvalida por campo ausente,400,Negativo,Alta,"validacao, obrigatorio"
TC-LOCREC-004,POST /locrec,Erro ao criar location com campo adicional,Impedir campos extras no payload,Payload com campo "txid",Dado que payload tem campo extra; Quando POST /locrec; Ent√£o retornar 400,"{""tipo"": ""rec"", ""txid"": ""abc""}",Erro PayloadLocationRecOperacaoInvalida por campo n√£o permitido,400,Negativo,M√©dia,"validacao, schema"
TC-LOCREC-005,GET /locrec/{id},Consultar location com recorr√™ncia vinculada com sucesso,Recuperar detalhes de uma location com idRec,Location existe e tem idRec,Dado que location existe; Quando GET /locrec/12069; Ent√£o retornar 200 e idRec presente,"id=12069",Objeto PayloadLocationRecCompleta com idRec,200,Positivo,Alta,"consulta, sucesso"
TC-LOCREC-006,GET /locrec/{id},Consultar location sem recorr√™ncia vinculada,Recuperar location antes do v√≠nculo,Location existe mas sem idRec,Dado que location existe sem idRec; Quando GET /locrec/12069; Ent√£o retornar 200 sem idRec,"id=12069",Objeto PayloadLocationRecGerada sem idRec,200,Positivo,M√©dia,"consulta, fluxo"
TC-LOCREC-007,GET /locrec/{id},Erro ao consultar location inexistente,Validar comportamento para ID n√£o encontrado,ID n√£o registrado no sistema,Dado que n√£o existe location com id; Quando GET /locrec/99999; Ent√£o retornar 404,"id=99999",Erro PayloadLocationRecNaoEncontrado,404,Negativo,Alta,"consulta, nao-encontrado"
TC-LOCREC-008,GET /locrec/{id},Erro ao consultar location com ID mal formatado,Validar formato do ID,ID com caracteres inv√°lidos,Dado que id √© mal formatado; Quando GET /locrec/ID_INVALIDO; Ent√£o retornar 400,"id=ID_INVALIDO",Erro PayloadLocationRecConsultaInvalida por schema,400,Negativo,M√©dia,"validacao, formato"
TC-LOCREC-009,DELETE /locrec/{id}/idRec,Desvincular recorr√™ncia com sucesso,Remover v√≠nculo entre location e recorr√™ncia,Location com idRec vinculado,Dado que idRec est√° vinculado; Quando DELETE /locrec/12069/idRec; Ent√£o retornar 200 sem idRec,"id=12069",Location sem idRec,200,Positivo,Alta,"desvinculacao, sucesso"
TC-LOCREC-010,DELETE /locrec/{id}/idRec,Erro ao desvincular location j√° desvinculada,Evitar opera√ß√£o redundante,Location j√° sem idRec,Dado que idRec n√£o est√° vinculado; Quando DELETE /locrec/12069/idRec; Ent√£o retornar 404,"id=12069",Erro PayloadLocationRecNaoEncontrado,404,Negativo,Alta,"validacao, estado"
TC-LOCREC-011,DELETE /locrec/{id}/idRec,Erro ao desvincular recorr√™ncia de location inexistente,Validar exist√™ncia da location,Location n√£o existe,Dado que location n√£o existe; Quando DELETE /locrec/99999/idRec; Ent√£o retornar 404,"id=99999",Erro PayloadLocationRecNaoEncontrado,404,Negativo,Alta,"desvinculacao, nao-encontrado"
TC-LOCREC-012,DELETE /locrec/{id}/idRec,Erro ao desvincular com ID mal formatado,Validar formato do ID,ID inv√°lido,Dado que id √© mal formatado; Quando DELETE /locrec/ID_INVALIDO/idRec; Ent√£o retornar 400,"id=ID_INVALIDO",Erro PayloadLocationRecConsultaInvalida por schema,400,Negativo,M√©dia,"validacao, formato"
```

---

## üì• Instru√ß√µes para uso

- **Formato**: CSV (UTF-8, delimitador v√≠rgula)
- **Campos**:
  - `ID do Caso`: Identificador √∫nico
  - `Funcionalidade`: Endpoint
  - `T√≠tulo do Caso`: Objetivo do teste
  - `Descri√ß√£o`: Contexto
  - `Pr√©-condi√ß√µes`: Estado inicial
  - `Passos`: Sequ√™ncia Given-When-Then
  - `Dados de Entrada`: Payload ou par√¢metros
  - `Sa√≠da Esperada`: Comportamento esperado
  - `C√≥digo HTTP Esperado`: Status code
  - `Tipo de Teste`: Positivo/Negativo/Edge
  - `Prioridade`: Alta/M√©dia
  - `Tags`: Classifica√ß√£o

---

Se desejar, posso gerar:
- Arquivo `.feature` para Cucumber
- Scripts de automa√ß√£o (Postman, Pytest, etc.)
- Diagrama de estados da location de recorr√™ncia
- Dados de exemplo para cada cen√°rio

Deseja que eu gere algum desses artefatos adicionais?

### USER
Fa√ßa o mesmo para o controller Gerenciamento de notifica√ß√µes de recorr√™ncias e n√£o economize tokens na resposta.

### ASSISTANT
Com base na an√°lise detalhada do conte√∫do fornecido, identifiquei que a **tag `WebhookRec`** (Gerenciamento de Notifica√ß√µes de Recorr√™ncias) re√∫ne endpoints destinados ao **gerenciamento de webhooks para notifica√ß√£o de eventos relacionados a recorr√™ncias**. Esses webhooks permitem que o PSP recebedor informe o usu√°rio recebedor sobre mudan√ßas de status em recorr√™ncias (como cria√ß√£o, cancelamento, rejei√ß√£o, expira√ß√£o, ativa√ß√£o, etc.) de forma ass√≠ncrona.

Este controller possui **dois endpoints principais**:

1. `PUT /webhookrec` ‚Äì Configurar ou atualizar a URL do webhook para notifica√ß√µes de recorr√™ncias  
2. `GET /webhookrec` ‚Äì Consultar a URL do webhook atualmente configurada  
3. `DELETE /webhookrec` ‚Äì Remover a configura√ß√£o do webhook  

A seguir, apresento uma an√°lise completa com **casos de teste no padr√£o Gherkin (Given-When-Then)** para cada funcionalidade, seguida de uma **planilha de testes estruturada em CSV**, considerando todas as regras de neg√≥cio, valida√ß√µes, c√≥digos de erro, restri√ß√µes sem√¢nticas, formato do payload de notifica√ß√£o e exemplos presentes na documenta√ß√£o.

---

## ‚úÖ **Funcionalidade: Configurar Webhook para Recorr√™ncias (`PUT /webhookrec`)**

### **Cen√°rio 1: Configurar webhook com sucesso**
```gherkin
Dado que o usu√°rio possui permiss√£o "webhookrec.write"
E o payload da requisi√ß√£o cont√©m o campo "webhookUrl" com uma URL v√°lida (HTTPS, at√© 100 caracteres)
E o dom√≠nio da URL est√° previamente cadastrado no PSP
E n√£o h√° um webhook ativo com a mesma URL
Quando uma requisi√ß√£o PUT for enviada para /webhookrec com os dados v√°lidos
Ent√£o a API deve retornar status 200 (OK)
E o corpo da resposta deve conter o objeto `WebhookRecConfigurado`
E o campo `webhookUrl` deve ser id√™ntico ao enviado
E o campo `criacao` deve estar no formato RFC 3339
```

### **Cen√°rio 2: Erro ao configurar webhook com URL inv√°lida (n√£o HTTPS)**
```gherkin
Dado que o payload cont√©m um campo "webhookUrl" com protocolo HTTP (n√£o seguro)
Quando uma requisi√ß√£o PUT for enviada para /webhookrec
Ent√£o a API deve retornar status 400 (Bad Request)
E o erro deve ser do tipo `WebhookRecOperacaoInvalida`
E a viola√ß√£o deve indicar: "O campo webhookUrl n√£o respeita o schema"
```

### **Cen√°rio 3: Erro ao configurar webhook com URL mal formatada**
```gherkin
Dado que o campo "webhookUrl" cont√©m um valor que n√£o √© uma URI v√°lida (ex: "url_invalida")
Quando uma requisi√ß√£o PUT for enviada para /webhookrec
Ent√£o a API deve retornar status 400
E o erro deve ser `WebhookRecOperacaoInvalida`
E a viola√ß√£o deve indicar: "O campo webhookUrl n√£o respeita o schema"
```

### **Cen√°rio 4: Erro ao configurar webhook com dom√≠nio n√£o cadastrado**
```gherkin
Dado que o dom√≠nio presente em `webhookUrl` n√£o est√° previamente cadastrado e autorizado no PSP
Quando uma requisi√ß√£o PUT for enviada para /webhookrec
Ent√£o a API deve retornar status 400
E o erro deve ser `WebhookRecOperacaoInvalida`
E a viola√ß√£o deve indicar: "O dom√≠nio da URL n√£o est√° autorizado"
```

### **Cen√°rio 5: Atualizar webhook existente com sucesso**
```gherkin
Dado que j√° existe um webhook configurado
E o novo `webhookUrl` √© diferente do atual, mas v√°lido
E o usu√°rio possui permiss√£o "webhookrec.write"
Quando uma requisi√ß√£o PUT for enviada para /webhookrec com a nova URL
Ent√£o a API deve retornar status 200 (OK)
E o corpo da resposta deve conter o objeto `WebhookRecConfigurado` com a nova URL
E o campo `criacao` deve ser mantido (n√£o alterado)
```

---

## ‚úÖ **Funcionalidade: Consultar Webhook de Recorr√™ncias (`GET /webhookrec`)**

### **Cen√°rio 6: Consultar webhook configurado com sucesso**
```gherkin
Dado que existe um webhook ativo para recorr√™ncias
E o usu√°rio possui permiss√£o "webhookrec.read"
Quando uma requisi√ß√£o GET for enviada para /webhookrec
Ent√£o a API deve retornar status 200 (OK)
E o corpo da resposta deve conter o objeto `WebhookRecConfigurado`
E os campos `webhookUrl` e `criacao` devem estar presentes
```

### **Cen√°rio 7: Erro ao consultar webhook sem permiss√£o**
```gherkin
Dado que o usu√°rio n√£o possui a permiss√£o "webhookrec.read"
Quando uma requisi√ß√£o GET for enviada para /webhookrec
Ent√£o a API deve retornar status 403 (Forbidden)
E o erro deve ser do tipo `AcessoNegado`
E o campo `detail` deve indicar falta de permiss√£o
```

### **Cen√°rio 8: Consultar webhook quando nenhum est√° configurado**
```gherkin
Dado que n√£o existe webhook configurado para recorr√™ncias
Quando uma requisi√ß√£o GET for enviada para /webhookrec
Ent√£o a API deve retornar status 404 (Not Found)
E o erro deve ser do tipo `NaoEncontrado`
E o campo `detail` deve indicar que o webhook n√£o foi encontrado
```

---

## ‚úÖ **Funcionalidade: Remover Webhook de Recorr√™ncias (`DELETE /webhookrec`)**

### **Cen√°rio 9: Remover webhook com sucesso**
```gherkin
Dado que existe um webhook configurado
E o usu√°rio possui permiss√£o "webhookrec.write"
Quando uma requisi√ß√£o DELETE for enviada para /webhookrec
Ent√£o a API deve retornar status 200 (OK)
E o corpo da resposta deve conter o objeto `WebhookRecRemovido`
E o campo `webhookUrl` deve conter a URL que foi removida
E o campo `remocao` deve estar no formato RFC 3339
```

### **Cen√°rio 10: Erro ao remover webhook j√° removido**
```gherkin
Dado que n√£o existe webhook configurado
Quando uma requisi√ß√£o DELETE for enviada para /webhookrec
Ent√£o a API deve retornar status 404 (Not Found)
E o erro deve ser `NaoEncontrado`
E o detalhe deve indicar que o webhook n√£o foi encontrado
```

### **Cen√°rio 11: Erro ao remover webhook sem permiss√£o**
```gherkin
Dado que o usu√°rio n√£o possui a permiss√£o "webhookrec.write"
Quando uma requisi√ß√£o DELETE for enviada para /webhookrec
Ent√£o a API deve retornar status 403 (Forbidden)
E o erro deve ser `AcessoNegado`
E o detalhe deve indicar falta de autoriza√ß√£o
```

---

## üì£ **Formato da Notifica√ß√£o (Webhook Payload)**

Quando um evento de recorr√™ncia ocorre (ex: cria√ß√£o, cancelamento, rejei√ß√£o), o PSP envia um POST para a URL configurada com o seguinte payload:

```json
{
  "idRec": "RR1234567820240115abcdefghijk",
  "status": "CANCELADA",
  "atualizacao": [
    {
      "status": "CANCELADA",
      "data": "2024-05-20T10:12:07.567Z"
    }
  ],
  "encerramento": {
    "rejeicao": {
      "codigo": "001",
      "descricao": "Usu√°rio n√£o autorizou a recorr√™ncia"
    }
  }
}
```

### **Regras do Webhook:**
- M√©todo HTTP: `POST`
- Content-Type: `application/json`
- Timeout: 10 segundos
- Retentativas: at√© 3 vezes em caso de falha
- O payload segue o schema `RecNotification`

---

## üîÅ **Regras de Neg√≥cio e Observa√ß√µes**

### **Formato do `webhookUrl`:**
- Deve come√ßar com `https://`
- M√°ximo de 100 caracteres
- Dom√≠nio deve estar previamente cadastrado no PSP
- N√£o pode conter par√¢metros ou fragmentos n√£o essenciais

### **Status que Geram Notifica√ß√£o:**
- `CRIADA`
- `APROVADA`
- `REJEITADA`
- `EXPIRADA`
- `CANCELADA`
- `ATIVADA`

> Notifica√ß√µes s√£o enviadas apenas para recorr√™ncias associadas ao usu√°rio recebedor.

### **C√≥digos de Erro Comuns:**
| Erro | Significado | HTTP | Endpoint |
|------|------------|------|--------|
| `WebhookRecOperacaoInvalida` | URL inv√°lida, dom√≠nio n√£o autorizado | 400 | PUT |
| `AcessoNegado` | Falta de permiss√£o OAuth2 | 403 | GET, PUT, DELETE |
| `NaoEncontrado` | Webhook n√£o configurado | 404 | GET, DELETE |
| `ServicoIndisponivel` | Erro tempor√°rio no PSP | 503 | Todos |

### **Permiss√µes OAuth2 Necess√°rias:**
- `webhookrec.write` ‚Üí para `PUT` e `DELETE`
- `webhookrec.read` ‚Üí para `GET`

---

## üìä **Planilha de Testes - Gerenciamento de Notifica√ß√µes de Recorr√™ncias (CSV)**

```csv
ID do Caso,Funcionalidade,T√≠tulo do Caso,Descri√ß√£o,Pr√©-condi√ß√µes,Passos,Dados de Entrada,Sa√≠da Esperada,C√≥digo HTTP Esperado,Tipo de Teste,Prioridade,Tags
TC-WEBHOOKREC-001,PUT /webhookrec,Configurar webhook com sucesso,Configurar uma URL v√°lida para recebimento de notifica√ß√µes de recorr√™ncia,Usu√°rio com permiss√£o "webhookrec.write",Dado que a URL √© v√°lida e o dom√≠nio est√° autorizado; Quando PUT /webhookrec com webhookUrl v√°lido; Ent√£o retornar 200 e objeto configurado,"{""webhookUrl"": ""https://api.recebedor.com/webhookrec/""}",WebhookRecConfigurado retornado,200,Positivo,Alta,"configuracao, sucesso"
TC-WEBHOOKREC-002,PUT /webhookrec,Erro ao configurar webhook com URL HTTP,Validar uso de HTTPS,Payload com URL HTTP,Dado que webhookUrl usa HTTP; Quando PUT /webhookrec; Ent√£o retornar 400,"{""webhookUrl"": ""http://api.recebedor.com/webhookrec/""}",Erro WebhookRecOperacaoInvalida por schema,400,Negativo,Alta,"validacao, seguran√ßa"
TC-WEBHOOKREC-003,PUT /webhookrec,Erro ao configurar webhook com URL mal formatada,Validar formato da URL,URL inv√°lida,Dado que webhookUrl √© inv√°lido; Quando PUT /webhookrec; Ent√£o retornar 400,"{""webhookUrl"": ""url_invalida""}",Erro WebhookRecOperacaoInvalida por schema,400,Negativo,Alta,"validacao, formato"
TC-WEBHOOKREC-004,PUT /webhookrec,Erro ao configurar webhook com dom√≠nio n√£o autorizado,Validar dom√≠nio cadastrado,Dom√≠nio n√£o cadastrado no PSP,Dado que dom√≠nio n√£o est√° autorizado; Quando PUT /webhookrec; Ent√£o retornar 400,"{""webhookUrl"": ""https://novo.recebedor.com/webhookrec/""}",Erro WebhookRecOperacaoInvalida por dom√≠nio,400,Negativo,Alta,"seguranca, validacao"
TC-WEBHOOKREC-005,PUT /webhookrec,Atualizar webhook existente com sucesso,Alterar URL do webhook ativo,Webhook j√° configurado,Dado que existe webhook; Quando PUT com nova URL v√°lida; Ent√£o retornar 200 e URL atualizada,"{""webhookUrl"": ""https://api2.recebedor.com/webhookrec/""}",WebhookRecConfigurado com nova URL,200,Positivo,Alta,"atualizacao, sucesso"
TC-WEBHOOKREC-006,GET /webhookrec,Consultar webhook configurado com sucesso,Recuperar URL do webhook ativo,Webhook existe e usu√°rio tem permiss√£o,Dado que webhook est√° ativo; Quando GET /webhookrec; Ent√£o retornar 200 e webhookUrl,"-",WebhookRecConfigurado retornado,200,Positivo,Alta,"consulta, sucesso"
TC-WEBHOOKREC-007,GET /webhookrec,Erro ao consultar webhook sem permiss√£o,Validar autoriza√ß√£o de acesso,Usu√°rio sem permiss√£o "webhookrec.read",Dado que falta permiss√£o; Quando GET /webhookrec; Ent√£o retornar 403,"-",Erro AcessoNegado,403,Negativo,Alta,"seguranca, autorizacao"
TC-WEBHOOKREC-008,GET /webhookrec,Consultar webhook n√£o configurado,Comportamento quando n√£o h√° webhook,Webhook n√£o configurado,Dado que n√£o existe webhook; Quando GET /webhookrec; Ent√£o retornar 404,"-",Erro NaoEncontrado,404,Negativo,M√©dia,"consulta, ausente"
TC-WEBHOOKREC-009,DELETE /webhookrec,Remover webhook com sucesso,Desativar notifica√ß√µes de recorr√™ncia,Webhook configurado e usu√°rio com permiss√£o,Dado que webhook existe; Quando DELETE /webhookrec; Ent√£o retornar 200 e webhook removido,"-",WebhookRecRemovido retornado,200,Positivo,Alta,"remocao, sucesso"
TC-WEBHOOKREC-010,DELETE /webhookrec,Erro ao remover webhook j√° removido,Evitar opera√ß√£o redundante,Webhook j√° removido,Dado que n√£o existe webhook; Quando DELETE /webhookrec; Ent√£o retornar 404,"-",Erro NaoEncontrado,404,Negativo,Alta,"validacao, estado"
TC-WEBHOOKREC-011,DELETE /webhookrec,Erro ao remover webhook sem permiss√£o,Validar autoriza√ß√£o de acesso,Usu√°rio sem permiss√£o "webhookrec.write",Dado que falta permiss√£o; Quando DELETE /webhookrec; Ent√£o retornar 403,"-",Erro AcessoNegado,403,Negativo,Alta,"seguranca, autorizacao"
```

---

## üì• Instru√ß√µes para uso

- **Formato**: CSV (UTF-8, delimitador v√≠rgula)
- **Campos**:
  - `ID do Caso`: Identificador √∫nico
  - `Funcionalidade`: Endpoint
  - `T√≠tulo do Caso`: Objetivo do teste
  - `Descri√ß√£o`: Contexto
  - `Pr√©-condi√ß√µes`: Estado inicial
  - `Passos`: Sequ√™ncia Given-When-Then
  - `Dados de Entrada`: Payload ou par√¢metros
  - `Sa√≠da Esperada`: Comportamento esperado
  - `C√≥digo HTTP Esperado`: Status code
  - `Tipo de Teste`: Positivo/Negativo/Edge
  - `Prioridade`: Alta/M√©dia
  - `Tags`: Classifica√ß√£o

---

Se desejar, posso gerar:
- Arquivo `.feature` para Cucumber
- Scripts de automa√ß√£o (Postman, Pytest, etc.)
- Diagrama de fluxo do webhook
- Exemplo de requisi√ß√£o de notifica√ß√£o (payload de callback)
- Planilha de monitoramento de delivery de notifica√ß√µes

Deseja que eu gere algum desses artefatos adicionais?

### USER
Fa√ßa o mesmo para o controller Gerenciamento de notifica√ß√µes de cobran√ßas recorrentes e n√£o economize tokens na resposta.

### ASSISTANT
Com base na an√°lise detalhada do conte√∫do fornecido, identifiquei que a **tag `WebhookCobR`** (Gerenciamento de Notifica√ß√µes de Cobran√ßas Recorrentes) re√∫ne endpoints destinados ao **gerenciamento de webhooks para notifica√ß√£o de eventos relacionados a cobran√ßas recorrentes**, permitindo que o PSP recebedor informe o usu√°rio recebedor sobre mudan√ßas de status em cobran√ßas recorrentes (como cria√ß√£o, ativa√ß√£o, expira√ß√£o, cancelamento, rejei√ß√£o, pagamento, etc.) de forma ass√≠ncrona.

Este controller possui **dois endpoints principais**:

1. `PUT /webhookcobr` ‚Äì Configurar ou atualizar a URL do webhook para notifica√ß√µes de cobran√ßas recorrentes  
2. `GET /webhookcobr` ‚Äì Consultar a URL do webhook atualmente configurada  
3. `DELETE /webhookcobr` ‚Äì Remover a configura√ß√£o do webhook  

A seguir, apresento uma an√°lise completa com **casos de teste no padr√£o Gherkin (Given-When-Then)** para cada funcionalidade, seguida de uma **planilha de testes estruturada em CSV**, considerando todas as regras de neg√≥cio, valida√ß√µes, c√≥digos de erro, restri√ß√µes sem√¢nticas, formato do payload de notifica√ß√£o e exemplos presentes na documenta√ß√£o.

---

## ‚úÖ **Funcionalidade: Configurar Webhook para Cobran√ßas Recorrentes (`PUT /webhookcobr`)**

### **Cen√°rio 1: Configurar webhook para cobran√ßas recorrentes com sucesso**
```gherkin
Dado que o usu√°rio possui permiss√£o "webhookcobr.write"
E o payload da requisi√ß√£o cont√©m o campo "webhookUrl" com uma URL v√°lida (HTTPS, at√© 100 caracteres)
E o dom√≠nio da URL est√° previamente cadastrado no PSP
E n√£o h√° um webhook ativo com a mesma URL
Quando uma requisi√ß√£o PUT for enviada para /webhookcobr com os dados v√°lidos
Ent√£o a API deve retornar status 200 (OK)
E o corpo da resposta deve conter o objeto `WebhookCobRConfigurado`
E o campo `webhookUrl` deve ser id√™ntico ao enviado
E o campo `criacao` deve estar no formato RFC 3339
```

### **Cen√°rio 2: Erro ao configurar webhook com URL inv√°lida (n√£o HTTPS)**
```gherkin
Dado que o payload cont√©m um campo "webhookUrl" com protocolo HTTP (n√£o seguro)
Quando uma requisi√ß√£o PUT for enviada para /webhookcobr
Ent√£o a API deve retornar status 400 (Bad Request)
E o erro deve ser do tipo `WebhookCobROperacaoInvalida`
E a viola√ß√£o deve indicar: "O campo webhookUrl n√£o respeita o schema"
```

### **Cen√°rio 3: Erro ao configurar webhook com URL mal formatada**
```gherkin
Dado que o campo "webhookUrl" cont√©m um valor que n√£o √© uma URI v√°lida (ex: "url_invalida")
Quando uma requisi√ß√£o PUT for enviada para /webhookcobr
Ent√£o a API deve retornar status 400
E o erro deve ser `WebhookCobROperacaoInvalida`
E a viola√ß√£o deve indicar: "O campo webhookUrl n√£o respeita o schema"
```

### **Cen√°rio 4: Erro ao configurar webhook com dom√≠nio n√£o cadastrado**
```gherkin
Dado que o dom√≠nio presente em `webhookUrl` n√£o est√° previamente cadastrado e autorizado no PSP
Quando uma requisi√ß√£o PUT for enviada para /webhookcobr
Ent√£o a API deve retornar status 400
E o erro deve ser `WebhookCobROperacaoInvalida`
E a viola√ß√£o deve indicar: "O dom√≠nio da URL n√£o est√° autorizado"
```

### **Cen√°rio 5: Atualizar webhook existente com sucesso**
```gherkin
Dado que j√° existe um webhook configurado
E o novo `webhookUrl` √© diferente do atual, mas v√°lido
E o usu√°rio possui permiss√£o "webhookcobr.write"
Quando uma requisi√ß√£o PUT for enviada para /webhookcobr com a nova URL
Ent√£o a API deve retornar status 200 (OK)
E o corpo da resposta deve conter o objeto `WebhookCobRConfigurado` com a nova URL
E o campo `criacao` deve ser mantido (n√£o alterado)
```

---

## ‚úÖ **Funcionalidade: Consultar Webhook de Cobran√ßas Recorrentes (`GET /webhookcobr`)**

### **Cen√°rio 6: Consultar webhook configurado com sucesso**
```gherkin
Dado que existe um webhook ativo para cobran√ßas recorrentes
E o usu√°rio possui permiss√£o "webhookcobr.read"
Quando uma requisi√ß√£o GET for enviada para /webhookcobr
Ent√£o a API deve retornar status 200 (OK)
E o corpo da resposta deve conter o objeto `WebhookCobRConfigurado`
E os campos `webhookUrl` e `criacao` devem estar presentes
```

### **Cen√°rio 7: Erro ao consultar webhook sem permiss√£o**
```gherkin
Dado que o usu√°rio n√£o possui a permiss√£o "webhookcobr.read"
Quando uma requisi√ß√£o GET for enviada para /webhookcobr
Ent√£o a API deve retornar status 403 (Forbidden)
E o erro deve ser do tipo `AcessoNegado`
E o campo `detail` deve indicar falta de permiss√£o
```

### **Cen√°rio 8: Consultar webhook quando nenhum est√° configurado**
```gherkin
Dado que n√£o existe webhook configurado para cobran√ßas recorrentes
Quando uma requisi√ß√£o GET for enviada para /webhookcobr
Ent√£o a API deve retornar status 404 (Not Found)
E o erro deve ser do tipo `NaoEncontrado`
E o campo `detail` deve indicar que o webhook n√£o foi encontrado
```

---

## ‚úÖ **Funcionalidade: Remover Webhook de Cobran√ßas Recorrentes (`DELETE /webhookcobr`)**

### **Cen√°rio 9: Remover webhook com sucesso**
```gherkin
Dado que existe um webhook configurado
E o usu√°rio possui permiss√£o "webhookcobr.write"
Quando uma requisi√ß√£o DELETE for enviada para /webhookcobr
Ent√£o a API deve retornar status 200 (OK)
E o corpo da resposta deve conter o objeto `WebhookCobRRemovido`
E o campo `webhookUrl` deve conter a URL que foi removida
E o campo `remocao` deve estar no formato RFC 3339
```

### **Cen√°rio 10: Erro ao remover webhook j√° removido**
```gherkin
Dado que n√£o existe webhook configurado
Quando uma requisi√ß√£o DELETE for enviada para /webhookcobr
Ent√£o a API deve retornar status 404 (Not Found)
E o erro deve ser `NaoEncontrado`
E o detalhe deve indicar que o webhook n√£o foi encontrado
```

### **Cen√°rio 11: Erro ao remover webhook sem permiss√£o**
```gherkin
Dado que o usu√°rio n√£o possui a permiss√£o "webhookcobr.write"
Quando uma requisi√ß√£o DELETE for enviada para /webhookcobr
Ent√£o a API deve retornar status 403 (Forbidden)
E o erro deve ser `AcessoNegado`
E o detalhe deve indicar falta de autoriza√ß√£o
```

---

## üì£ **Formato da Notifica√ß√£o (Webhook Payload)**

Quando um evento de cobran√ßa recorrente ocorre (ex: cria√ß√£o, ativa√ß√£o, cancelamento, rejei√ß√£o, expira√ß√£o, tentativa de pagamento), o PSP envia um **POST ass√≠ncrono** para a URL configurada com o seguinte payload:

```json
{
  "idRec": "RR1234567820240115abcdefghijk",
  "txid": "3136957d93134f2184b369e8f1c0729d",
  "status": "ATIVA",
  "atualizacao": [
    {
      "status": "ATIVA",
      "data": "2024-05-20T10:18:20.120Z"
    }
  ],
  "tentativas": [
    {
      "data": "2024-05-21T08:00:00.000Z",
      "status": "AGENDADA",
      "endToEndId": "E12345678202406201221abcdef12345"
    }
  ]
}
```

### **Campos do Payload de Notifica√ß√£o (`CobRNotification`):**
- `idRec`: ID da recorr√™ncia associada
- `txid`: Identificador √∫nico da cobran√ßa recorrente
- `status`: Status atual da cobran√ßa recorrente
- `atualizacao`: Hist√≥rico de mudan√ßas de status
- `tentativas`: Lista de tentativas de pagamento (agendadas, pagas, rejeitadas, etc.)

### **Eventos que Geram Notifica√ß√£o:**
- `CRIADA` ‚Üí Cobran√ßa criada
- `ATIVA` ‚Üí Cobran√ßa ativada e pronta para pagamento
- `CONCLUIDA` ‚Üí Pagamento realizado com sucesso
- `EXPIRADA` ‚Üí Cobran√ßa venceu sem pagamento
- `REJEITADA` ‚Üí Tentativa de pagamento rejeitada
- `CANCELADA` ‚Üí Cobran√ßa cancelada pelo recebedor
- `AGENDADA` ‚Üí Nova tentativa de pagamento agendada

> Notifica√ß√µes s√£o enviadas apenas para cobran√ßas recorrentes associadas ao usu√°rio recebedor.

---

## üîÅ **Regras de Neg√≥cio e Observa√ß√µes**

### **Formato do `webhookUrl`:**
- Deve come√ßar com `https://`
- M√°ximo de 100 caracteres
- Dom√≠nio deve estar previamente cadastrado no PSP
- N√£o pode conter par√¢metros ou fragmentos n√£o essenciais

### **C√≥digos de Erro Comuns:**
| Erro | Significado | HTTP | Endpoint |
|------|------------|------|--------|
| `WebhookCobROperacaoInvalida` | URL inv√°lida, dom√≠nio n√£o autorizado | 400 | PUT |
| `AcessoNegado` | Falta de permiss√£o OAuth2 | 403 | GET, PUT, DELETE |
| `NaoEncontrado` | Webhook n√£o configurado | 404 | GET, DELETE |
| `ServicoIndisponivel` | Erro tempor√°rio no PSP | 503 | Todos |

### **Permiss√µes OAuth2 Necess√°rias:**
- `webhookcobr.write` ‚Üí para `PUT` e `DELETE`
- `webhookcobr.read` ‚Üí para `GET`

### **Sem√¢ntica de Entrega:**
- M√©todo: `POST`
- Content-Type: `application/json`
- Timeout: 10 segundos
- Retentativas: at√© 3 vezes em caso de falha (ex: 5xx, timeout)
- O payload segue o schema `CobRNotification`

---

## üìä **Planilha de Testes - Gerenciamento de Notifica√ß√µes de Cobran√ßas Recorrentes (CSV)**

```csv
ID do Caso,Funcionalidade,T√≠tulo do Caso,Descri√ß√£o,Pr√©-condi√ß√µes,Passos,Dados de Entrada,Sa√≠da Esperada,C√≥digo HTTP Esperado,Tipo de Teste,Prioridade,Tags
TC-WEBHOOKCOBR-001,PUT /webhookcobr,Configurar webhook para cobran√ßas recorrentes com sucesso,Configurar uma URL v√°lida para recebimento de notifica√ß√µes de cobran√ßas recorrentes,Usu√°rio com permiss√£o "webhookcobr.write",Dado que a URL √© v√°lida e o dom√≠nio est√° autorizado; Quando PUT /webhookcobr com webhookUrl v√°lido; Ent√£o retornar 200 e objeto configurado,"{""webhookUrl"": ""https://api.recebedor.com/webhookcobr/""}",WebhookCobRConfigurado retornado,200,Positivo,Alta,"configuracao, sucesso"
TC-WEBHOOKCOBR-002,PUT /webhookcobr,Erro ao configurar webhook com URL HTTP,Validar uso de HTTPS,Payload com URL HTTP,Dado que webhookUrl usa HTTP; Quando PUT /webhookcobr; Ent√£o retornar 400,"{""webhookUrl"": ""http://api.recebedor.com/webhookcobr/""}",Erro WebhookCobROperacaoInvalida por schema,400,Negativo,Alta,"validacao, seguran√ßa"
TC-WEBHOOKCOBR-003,PUT /webhookcobr,Erro ao configurar webhook com URL mal formatada,Validar formato da URL,URL inv√°lida,Dado que webhookUrl √© inv√°lido; Quando PUT /webhookcobr; Ent√£o retornar 400,"{""webhookUrl"": ""url_invalida""}",Erro WebhookCobROperacaoInvalida por schema,400,Negativo,Alta,"validacao, formato"
TC-WEBHOOKCOBR-004,PUT /webhookcobr,Erro ao configurar webhook com dom√≠nio n√£o autorizado,Validar dom√≠nio cadastrado,Dom√≠nio n√£o cadastrado no PSP,Dado que dom√≠nio n√£o est√° autorizado; Quando PUT /webhookcobr; Ent√£o retornar 400,"{""webhookUrl"": ""https://novo.recebedor.com/webhookcobr/""}",Erro WebhookCobROperacaoInvalida por dom√≠nio,400,Negativo,Alta,"seguranca, validacao"
TC-WEBHOOKCOBR-005,PUT /webhookcobr,Atualizar webhook existente com sucesso,Alterar URL do webhook ativo,Webhook j√° configurado,Dado que existe webhook; Quando PUT com nova URL v√°lida; Ent√£o retornar 200 e URL atualizada,"{""webhookUrl"": ""https://api2.recebedor.com/webhookcobr/""}",WebhookCobRConfigurado com nova URL,200,Positivo,Alta,"atualizacao, sucesso"
TC-WEBHOOKCOBR-006,GET /webhookcobr,Consultar webhook configurado com sucesso,Recuperar URL do webhook ativo,Webhook existe e usu√°rio tem permiss√£o,Dado que webhook est√° ativo; Quando GET /webhookcobr; Ent√£o retornar 200 e webhookUrl,"-",WebhookCobRConfigurado retornado,200,Positivo,Alta,"consulta, sucesso"
TC-WEBHOOKCOBR-007,GET /webhookcobr,Erro ao consultar webhook sem permiss√£o,Validar autoriza√ß√£o de acesso,Usu√°rio sem permiss√£o "webhookcobr.read",Dado que falta permiss√£o; Quando GET /webhookcobr; Ent√£o retornar 403,"-",Erro AcessoNegado,403,Negativo,Alta,"seguranca, autorizacao"
TC-WEBHOOKCOBR-008,GET /webhookcobr,Consultar webhook quando nenhum est√° configurado,Comportamento quando n√£o h√° webhook,Webhook n√£o configurado,Dado que n√£o existe webhook; Quando GET /webhookcobr; Ent√£o retornar 404,"-",Erro NaoEncontrado,404,Negativo,M√©dia,"consulta, ausente"
TC-WEBHOOKCOBR-009,DELETE /webhookcobr,Remover webhook com sucesso,Desativar notifica√ß√µes de cobran√ßas recorrentes,Webhook configurado e usu√°rio com permiss√£o,Dado que webhook existe; Quando DELETE /webhookcobr; Ent√£o retornar 200 e webhook removido,"-",WebhookCobRRemovido retornado,200,Positivo,Alta,"remocao, sucesso"
TC-WEBHOOKCOBR-010,DELETE /webhookcobr,Erro ao remover webhook j√° removido,Evitar opera√ß√£o redundante,Webhook j√° removido,Dado que n√£o existe webhook; Quando DELETE /webhookcobr; Ent√£o retornar 404,"-",Erro NaoEncontrado,404,Negativo,Alta,"validacao, estado"
TC-WEBHOOKCOBR-011,DELETE /webhookcobr,Erro ao remover webhook sem permiss√£o,Validar autoriza√ß√£o de acesso,Usu√°rio sem permiss√£o "webhookcobr.write",Dado que falta permiss√£o; Quando DELETE /webhookcobr; Ent√£o retornar 403,"-",Erro AcessoNegado,403,Negativo,Alta,"seguranca, autorizacao"
```

---

## üì• Instru√ß√µes para uso

- **Formato**: CSV (UTF-8, delimitador v√≠rgula)
- **Campos**:
  - `ID do Caso`: Identificador √∫nico
  - `Funcionalidade`: Endpoint
  - `T√≠tulo do Caso`: Objetivo do teste
  - `Descri√ß√£o`: Contexto
  - `Pr√©-condi√ß√µes`: Estado inicial
  - `Passos`: Sequ√™ncia Given-When-Then
  - `Dados de Entrada`: Payload ou par√¢metros
  - `Sa√≠da Esperada`: Comportamento esperado
  - `C√≥digo HTTP Esperado`: Status code
  - `Tipo de Teste`: Positivo/Negativo/Edge
  - `Prioridade`: Alta/M√©dia
  - `Tags`: Classifica√ß√£o

---

Se desejar, posso gerar:
- Arquivo `.feature` para Cucumber
- Scripts de automa√ß√£o (Postman, Pytest, etc.)
- Diagrama de fluxo do webhook
- Exemplo de requisi√ß√£o de notifica√ß√£o (payload de callback)
- Planilha de monitoramento de delivery de notifica√ß√µes

Deseja que eu gere algum desses artefatos adicionais?