Com base na anÃ¡lise completa e detalhada do **Guia de ImplementaÃ§Ã£o do Pix AutomÃ¡tico (versÃ£o 1.2)**, apresento abaixo uma **visÃ£o integrada, tÃ©cnica e operacional** do fluxo do Pix AutomÃ¡tico, com foco na **jornada de troca de mensagens entre o PSP pagador e o PSP recebedor**, incluindo todas as **jornadas de autorizaÃ§Ã£o**, as **mensagens do SPI (pain.009, pain.012, pain.013, camt.054, camt.055)**, os **papÃ©is dos usuÃ¡rios**, as **regras de validaÃ§Ã£o**, os **fluxos de erro**, e as **responsabilidades de notificaÃ§Ã£o**.

Este documento Ã© uma **referÃªncia completa e definitiva** para especialistas em Pix, equipes de desenvolvimento, compliance e operaÃ§Ãµes de instituiÃ§Ãµes financeiras e fintechs.

---

# ğŸ“˜ **Guia Completo: Jornada do Pix AutomÃ¡tico â€“ Fluxo de Mensagens entre PSPs**

---

## ğŸ” **1. IntroduÃ§Ã£o**

O **Pix AutomÃ¡tico** Ã© um mecanismo de **pagamento recorrente autorizado previamente** pelo usuÃ¡rio pagador, que permite o **dÃ©bito automÃ¡tico** de valores em sua conta transacional, mediante **autorizaÃ§Ã£o explÃ­cita** e **agendamento prÃ©vio** via infraestrutura do Sistema de Pagamentos InstantÃ¢neos (SPI) do Banco Central.

Este guia detalha o **fluxo completo**, com foco na **troca de mensagens entre os PSPs (Participantes do SPI)**, com base no **Guia de ImplementaÃ§Ã£o do Pix AutomÃ¡tico (v1.2)**.

---

## ğŸ§© **2. Etapas Fundamentais do Pix AutomÃ¡tico**

O processo pode ser dividido em **6 etapas principais**:

1. **CriaÃ§Ã£o da RecorrÃªncia**
2. **AutorizaÃ§Ã£o (com 4 jornadas possÃ­veis)**
3. **Agendamento do DÃ©bito (via pain.013)**
4. **LiquidaÃ§Ã£o**
5. **GestÃ£o PÃ³s-Pagamento (notificaÃ§Ãµes, cancelamentos, retentativas)**
6. **DevoluÃ§Ã£o (MED)**

Vamos detalhar cada uma.

---

## âœ… **3. Etapa 1: CriaÃ§Ã£o da RecorrÃªncia**

### ğŸ“Œ ResponsÃ¡vel: **PSP Recebedor** (por solicitaÃ§Ã£o do **usuÃ¡rio recebedor**)

### ğŸ“¥ Dados da RecorrÃªncia
A recorrÃªncia Ã© criada com status **â€œpendente de confirmaÃ§Ã£oâ€** e contÃ©m os seguintes dados:

| Campo | DescriÃ§Ã£o |
|------|----------|
| `idRecorrencia` | ID Ãºnico no formato: `RRxxxxxxxxyyyyMMddkkkkkkkkkkk` (29 caracteres) |
| `formaDeIniciacao` | Sempre `AUTO` |
| `valor` | ObrigatÃ³rio apenas para recorrÃªncias de **valor fixo** |
| `periodicidade` | Semanal, mensal, trimestral, semestral, anual |
| `dataInicio` | Data de inÃ­cio da vigÃªncia |
| `dataFim` | Opcional. Recomenda-se que esteja alguns dias apÃ³s o Ãºltimo pagamento previsto |
| `descricao` | DescriÃ§Ã£o opcional do objeto da cobranÃ§a |
| `idObjetoCobranca` | NÃºmero do contrato, pedido ou cÃ³digo do cliente |
| `politicaRetentativa` | Define se permite novas tentativas apÃ³s vencimento (`S` ou `N`) |

> ğŸ“Œ **Regra**: O campo `idRecorrencia` codifica informaÃ§Ãµes:
> - `RR` = criada no Pix + permite retentativas pÃ³s-vencimento
> - `RN` = criada no Pix + **nÃ£o** permite retentativas
> - `CR`/`CN` = criada via Open Finance

---

## ğŸ” **4. Etapa 2: AutorizaÃ§Ã£o â€“ As 4 Jornadas**

A autorizaÃ§Ã£o Ã© o momento em que o **usuÃ¡rio pagador confirma** que aceita o pagamento recorrente. Existem **4 jornadas possÃ­veis**, com diferentes pontos de partida.

---

### ğŸŸ¦ **Jornada 1: AutorizaÃ§Ã£o sem QR Code (NotificaÃ§Ã£o via App)**

**Fluxo**: O usuÃ¡rio pagador Ã© convidado a autorizar uma recorrÃªncia por canais **externos ao Pix** (ex: e-mail, ligaÃ§Ã£o, app do recebedor).

#### ğŸ” Fluxo de Mensagens

```mermaid
sequenceDiagram
    participant Recebedor
    participant PSPR as PSP Recebedor
    participant PSPC as PSP Pagador
    participant Pagador

    Recebedor->>PSPR: Solicita criaÃ§Ã£o da recorrÃªncia
    PSPR->>PSPC: Envia pain.009 (solicitaÃ§Ã£o de confirmaÃ§Ã£o)
    PSPC->>Pagador: Notifica via app: "Autorizar recorrÃªncia?"
    Pagador->>PSPC: Confirma (com autenticaÃ§Ã£o)
    PSPC->>PSPR: Envia pain.012 (status = true)
    PSPR->>Recebedor: Informa sucesso da autorizaÃ§Ã£o
```

#### ğŸ”‘ Mensagens
- **`pain.009`**: Inicia a autorizaÃ§Ã£o. ContÃ©m todos os dados da recorrÃªncia.
- **`pain.012`**: Resposta do PSP pagador. Se `status=true`, a autorizaÃ§Ã£o estÃ¡ confirmada.

> âš ï¸ **Importante**: Se o PSP pagador **nÃ£o tiver o codMunIBGE**, deve preencher como `0000000` na `pain.012`.

> ğŸ“Œ **Regra**: NÃ£o podem existir mÃºltiplas `pain.009` ativas para a mesma recorrÃªncia.

---

### ğŸŸ¨ **Jornada 2: QR Code (sÃ³ recorrÃªncia)**

**Fluxo**: O pagador escaneia um QR Code que **aponta apenas para os dados da recorrÃªncia**.

#### ğŸ” Fluxo de Mensagens

```mermaid
sequenceDiagram
    participant Recebedor
    participant PSPR
    participant PSPC
    participant Pagador

    Recebedor->>PSPR: Cria recorrÃªncia + gera QR Code com location
    PSPR->>Recebedor: Gera QR Code (faixa 80-99)
    Pagador->>PSPC: LÃª QR Code
    PSPC->>PSPR: GET /pix/v2/rec/{txid}
    PSPR->>PSPC: Retorna dados da recorrÃªncia
    PSPC->>Pagador: Exibe detalhes e pede confirmaÃ§Ã£o
    Pagador->>PSPC: Confirma
    PSPC->>PSPR: Envia pain.012 (status = true)
    PSPR->>Recebedor: Informa sucesso
```

> âœ… **NÃ£o hÃ¡ `pain.009`** nesta jornada. A `pain.012` Ã© enviada diretamente apÃ³s a confirmaÃ§Ã£o.

---

### ğŸŸ¥ **Jornada 3: QR Code Composto (Pagamento Imediato + RecorrÃªncia)**

**Fluxo**: QR Code com **dois payloads**:
- Um para **pagamento imediato** (via `location` ou dados estÃ¡ticos)
- Outro para **recorrÃªncia** (sempre via `location`)

#### ğŸ” Fluxo de Mensagens

```mermaid
sequenceDiagram
    participant Recebedor
    participant PSPR
    participant PSPC
    participant Pagador

    Recebedor->>PSPR: Cria cobranÃ§a imediata + recorrÃªncia
    PSPR->>Recebedor: Gera QR Code composto
    Pagador->>PSPC: LÃª QR Code
    PSPC->>PSPR: GET /cobv/{txid} e GET /rec/{txid}
    PSPR->>PSPC: Retorna dados
    PSPC->>Pagador: Exibe pagamento + checkbox "Autorizar recorrÃªncia"
    Pagador->>PSPC: Confirma ambos
    PSPC->>PSPR: Inicia Pix imediato (pacs.008)
    PSPC->>PSPR: ApÃ³s sucesso, envia pain.012 (status = true)
    PSPR->>Recebedor: Informa sucesso do pagamento e da autorizaÃ§Ã£o
```

> âš ï¸ **Regra crÃ­tica**: A autorizaÃ§Ã£o da recorrÃªncia **sÃ³ Ã© confirmada apÃ³s a liquidaÃ§Ã£o do pagamento imediato**.

> ğŸ“Œ **Extrato**: O pagamento imediato aparece como **Pix normal**, nÃ£o como Pix AutomÃ¡tico.

---

### ğŸŸ§ **Jornada 4: AutorizaÃ§Ã£o ApÃ³s Pagamento/Agendamento com Vencimento**

**Fluxo**: O usuÃ¡rio paga ou agenda uma cobranÃ§a com vencimento e, **ao final**, recebe a oferta de adesÃ£o ao Pix AutomÃ¡tico.

#### ğŸ” Fluxo de Mensagens

```mermaid
sequenceDiagram
    participant Recebedor
    participant PSPR
    participant PSPC
    participant Pagador

    Recebedor->>PSPR: Cria cobranÃ§a com vencimento + recorrÃªncia
    PSPR->>Recebedor: Gera QR Code composto
    Pagador->>PSPC: LÃª QR Code e paga/agenda
    PSPC->>PSPR: Confirma pagamento/agendamento
    PSPC->>Pagador: Oferece adesÃ£o ao Pix AutomÃ¡tico
    Pagador->>PSPC: Aceita ou recusa
    alt Aceita
        PSPC->>PSPR: Envia pain.012 (status = true)
        PSPR->>Recebedor: Informa sucesso
    else Recusa
        PSPC->>PSPR: NÃ£o envia nada
    end
```

> âœ… **Diferencial**: AutorizaÃ§Ã£o **opcional** e **pÃ³s-pagamento**.

> âš ï¸ **Regra**: Se o pagamento falhar, **nÃ£o pode ser ofertado** o Pix AutomÃ¡tico.

---

## ğŸ”„ **5. Etapa 3: Agendamento do DÃ©bito (InstruÃ§Ã£o de Pagamento)**

ApÃ³s a autorizaÃ§Ã£o, o **PSP recebedor envia a `pain.013`** para agendar o dÃ©bito.

### ğŸ“¥ `pain.013` â€“ InstruÃ§Ã£o de Pagamento

| Campo | Valor |
|------|-------|
| `formaDeIniciacao` | `AUTO` |
| `idFimAFim` | Data prevista para liquidaÃ§Ã£o (no formato `YYYYMMDD`) |
| `finalidadeDoAgendamento` | Pode ser: `AGND`, `RIFL`, `NTAG` |
| `valor` | Valor da cobranÃ§a |
| `idConciliacaoRecebedor` | ID para conciliaÃ§Ã£o |
| `dataHoraCriacaoParaEmissao` | Data/hora de envio da instruÃ§Ã£o (para validaÃ§Ã£o de prazo) |

### ğŸ“… **Prazos de Envio**
- A `pain.013` deve ser enviada **entre 2 e 10 dias corridos antes** da data de liquidaÃ§Ã£o.
- O PSP pagador valida com base no campo `dataHoraCriacaoParaEmissao`.

---

### ğŸš« **ValidaÃ§Ãµes no PSP Pagador**

O PSP pagador **rejeita** o agendamento se:

| CondiÃ§Ã£o | Mensagem |
|--------|---------|
| Valor â‰  valor autorizado (fixo) | `camt.054` |
| Valor > valor mÃ¡ximo (variÃ¡vel) | `camt.054` |
| Data incompatÃ­vel com periodicidade | `camt.054` |
| CNPJ do recebedor divergente | `pain.014` com erro `AB10` |
| Sem autorizaÃ§Ã£o vigente | `camt.054` |
| Fora do prazo (menos de 2 dias) | `camt.054` |

> âœ… **ExceÃ§Ã£o**: InstruÃ§Ãµes com `finalidadeDoAgendamento = RIFL` **nÃ£o sÃ£o validadas quanto a valor mÃ¡ximo ou autorizaÃ§Ã£o ativa**.

---

## ğŸ’¸ **6. Etapa 4: LiquidaÃ§Ã£o**

- Ocorre entre **0h e 8h** do dia agendado.
- O PSP pagador envia uma **ordem de pagamento (pacs.008)** ao SPI.
- Se houver **insuficiÃªncia de saldo ou falha operacional**, o PSP pagador **nÃ£o envia a ordem** e notifica o usuÃ¡rio.

### ğŸ›‘ **ApÃ³s as 21h:**
- **NÃ£o sÃ£o aceitas novas instruÃ§Ãµes com `RIFL`**.
- Se o pagamento nÃ£o foi liquidado, o PSP pagador **informa o usuÃ¡rio** que deve pagar por outros meios.

---

## ğŸ” **7. Retentativas de Pagamento**

Se o pagamento falhar, hÃ¡ dois tipos de retentativa:

### ğŸ”„ **RIFL (ReinÃ­cio da InstruÃ§Ã£o por Falha na LiquidaÃ§Ã£o)**
- Usada **intradiariamente** (atÃ© 23h59 do dia anterior).
- Finalidade: `RIFL`
- Pode ser reenviada vÃ¡rias vezes.
- **NÃ£o Ã© validada quanto a valor mÃ¡ximo**.

### ğŸ“… **NTAG (Nova Tentativa pÃ³s Vencimento)**
- Usada **quando a recorrÃªncia permite retentativas apÃ³s vencimento**.
- Finalidade: `NTAG`
- Enviada via `POST /cobr/{txid}/retentativa/{data}`
- **UsuÃ¡rio pagador nÃ£o pode cancelar** agendamentos com `NTAG`.

> ğŸ“Œ **Regra**: O campo `politicaRetentativa` da recorrÃªncia define se `NTAG` Ã© permitida.

---

## ğŸ“¢ **8. NotificaÃ§Ãµes ObrigatÃ³rias**

### ğŸ“± **Para o UsuÃ¡rio Pagador**
O PSP pagador **deve notificar** em:
- Sucesso/insucesso do agendamento
- Cancelamento do agendamento (por ele ou pelo recebedor)
- Falha na liquidaÃ§Ã£o
- Oferta de adesÃ£o (Jornada 4)

> âœ… **Pode ser desabilitado** pelo usuÃ¡rio.

### ğŸ“± **Para o UsuÃ¡rio Recebedor**
O PSP recebedor **deve informar**:
- Sucesso/insucesso do agendamento
- Cancelamento pelo pagador
- Sucesso/insucesso do cancelamento da cobranÃ§a

---

## ğŸš« **9. Cancelamento**

### ğŸ›‘ **Pelo UsuÃ¡rio Pagador**
- Pode cancelar **a qualquer momento**.
- O agendamento Ã© cancelado atÃ© a **vÃ©spera da liquidaÃ§Ã£o**.
- ApÃ³s 22h do dia anterior, **nÃ£o pode mais cancelar**.

### ğŸ›‘ **Pelo UsuÃ¡rio Recebedor**
- Pode cancelar a cobranÃ§a.
- **ApÃ³s 22h do dia anterior**, o PSP recebedor **deve rejeitar** o cancelamento.

---

## ğŸ”„ **10. AlteraÃ§Ã£o de RecorrÃªncia**

- **NÃ£o Ã© permitido alterar recorrÃªncia confirmada**.
- Deve-se:
  1. **Cancelar** a recorrÃªncia atual
  2. **Criar uma nova** com os dados alterados
  3. **Solicitar nova autorizaÃ§Ã£o**

> âš ï¸ **ExceÃ§Ã£o**: AlteraÃ§Ãµes antes da confirmaÃ§Ã£o sÃ£o permitidas.

---

## ğŸ” **11. Papel do PSI (Prestador de ServiÃ§o de IniciaÃ§Ã£o)**

No modelo Open Finance:

- O usuÃ¡rio pagador concede **consentimento ao PSI**.
- O PSI atua como intermediÃ¡rio.
- O PSP pagador **valida o consentimento** a cada pagamento.
- Se os dados nÃ£o batem ou o consentimento estiver expirado, **nÃ£o agenda o dÃ©bito**.

> ğŸ“Œ O consentimento contÃ©m:
> - ID da recorrÃªncia
> - Valor mÃ¡ximo
> - PerÃ­odo de vigÃªncia
> - Status (`AUTHORIZED`, `REVOKED`, etc.)

---

## ğŸ”„ **12. Fluxo de Erros e Cancelamentos**

| Mensagem | Uso |
|--------|-----|
| `camt.054` | RejeiÃ§Ã£o **antes** da liquidaÃ§Ã£o (ex: valor invÃ¡lido) |
| `camt.055` | Cancelamento **apÃ³s** falha na liquidaÃ§Ã£o |
| `pain.014` | Erros especÃ­ficos (ex: `AB10` = CNPJ divergente) |

---

## ğŸ“„ **13. MED â€“ Mecanismo Especial de DevoluÃ§Ã£o**

- O usuÃ¡rio pagador pode solicitar devoluÃ§Ã£o em atÃ© **90 dias**.
- O PSP pagador **devolve em atÃ© 24h**.
- Depois, solicita ressarcimento ao PSP recebedor via **DICT**.

> âœ… **ElegÃ­vel** para Pix AutomÃ¡tico.

---

## ğŸ“Š **14. Resumo das Mensagens do SPI**

| Mensagem | Origem â†’ Destino | Finalidade |
|--------|------------------|-----------|
| `pain.009` | PSP Recebedor â†’ PSP Pagador | Iniciar autorizaÃ§Ã£o (Jornada 1) |
| `pain.012` | PSP Pagador â†’ PSP Recebedor | Confirmar/rejeitar autorizaÃ§Ã£o |
| `pain.013` | PSP Recebedor â†’ PSP Pagador | Agendar dÃ©bito recorrente |
| `camt.054` | PSP Pagador â†’ PSP Recebedor | Rejeitar agendamento |
| `camt.055` | PSP Pagador â†’ PSP Recebedor | Cancelar ordem apÃ³s falha |
| `pain.014` | PSP Recebedor â†’ PSP Pagador | Informar erro especÃ­fico |
| `pacs.008` | PSP Pagador â†’ SPI | Ordem de pagamento (liquidaÃ§Ã£o) |

---

## ğŸ“Œ **15. Boas PrÃ¡ticas e Regras CrÃ­ticas**

1. **QR Code**:
   - Faixa 26-51: obrigatÃ³ria (mesmo que vazia).
   - Faixa 80-99: opcional, para dados da recorrÃªncia.

2. **Valor MÃ¡ximo**:
   - Armazenado apenas no **PSP pagador** (nÃ£o compartilhado).
   - AplicÃ¡vel apenas a recorrÃªncias de **valor variÃ¡vel**.

3. **Ajuste de Dia Ãštil**:
   - Se a data de pagamento cair em dia nÃ£o Ãºtil, o PSP recebedor **deve ajustar para o prÃ³ximo dia Ãºtil**, considerando **feriados locais** (com base no `codMunIBGE`).

4. **Data Final da RecorrÃªncia**:
   - Deve ser alguns dias apÃ³s o Ãºltimo pagamento, para permitir retentativas.

5. **NotificaÃ§Ã£o de Agendamento**:
   - Deve ocorrer **imediatamente**, exceto se for de madrugada (neste caso, adiar para horÃ¡rio diurno).

---

## ğŸ **ConclusÃ£o**

O Pix AutomÃ¡tico Ã© um sistema robusto, seguro e flexÃ­vel, que combina **autorizaÃ§Ã£o explÃ­cita**, **agendamento prÃ©vio**, **liquidaÃ§Ã£o automÃ¡tica** e **gestÃ£o de erros padronizada**.

As **quatro jornadas de autorizaÃ§Ã£o** permitem adaptaÃ§Ã£o a diferentes modelos de negÃ³cio, desde assinaturas digitais atÃ© pagamentos recorrentes em lojas fÃ­sicas.

O **fluxo de mensagens entre PSPs** â€” especialmente `pain.009`, `pain.012`, `pain.013`, `camt.054` e `camt.055` â€” Ã© o coraÃ§Ã£o do sistema, garantindo **integridade, seguranÃ§a e transparÃªncia**.

---

Se desejar, posso gerar:
- Um **diagrama Mermaid completo** com todas as jornadas
- Um **modelo de API Pix** para criaÃ§Ã£o de recorrÃªncia
- Um **checklist de conformidade** para PSPs
- Um **fluxograma em PNG/SVG**

Deseja algum desses artefatos?