### USER
Como um especialista em pix , analise o manual do pix automÃ¡tico e me explique em uma visÃ£o de jornada o fluxo de troca de mensagens entre o recebedor e o pagador 

### ASSISTANT
Com base no **Guia de ImplementaÃ§Ã£o do Pix AutomÃ¡tico** ([`guia_pix_automatico.pdf`](guia_pix_automatico.pdf)), Ã© possÃ­vel descrever, de forma clara e estruturada, o **fluxo de troca de mensagens entre o PSP pagador e o PSP recebedor**, considerando as diferentes **jornadas de autorizaÃ§Ã£o** previstas. Abaixo, apresento uma **visÃ£o por jornada**, destacando as etapas principais e a **sequÃªncia de mensagens trocadas entre os participantes**.

---

## ğŸ” VisÃ£o Geral: Etapas Fundamentais do Pix AutomÃ¡tico

Antes de detalhar as jornadas, Ã© importante entender os **estÃ¡gios comuns** a todos os fluxos:

1. **CriaÃ§Ã£o da recorrÃªncia** pelo usuÃ¡rio recebedor (ou PSI) â†’ PSP recebedor.
2. **AutorizaÃ§Ã£o do usuÃ¡rio pagador** ao seu PSP.
3. **Troca de mensagens entre PSPs** via infraestrutura do Pix (SPI).
4. **Armazenamento da autorizaÃ§Ã£o** no PSP pagador.
5. **ConfirmaÃ§Ã£o da autorizaÃ§Ã£o** ao PSP recebedor.
6. **GeraÃ§Ã£o de instruÃ§Ãµes de pagamento** periÃ³dicas (via API Pix ou arquivo).
7. **Agendamento e liquidaÃ§Ã£o automÃ¡tica** dos dÃ©bitos.

---

## ğŸš¶â€â™‚ï¸ Jornadas de AutorizaÃ§Ã£o e Fluxo de Mensagens

O documento define **4 jornadas de autorizaÃ§Ã£o**. Cada uma tem um ponto de partida diferente, mas todas convergem para a **confirmaÃ§Ã£o da autorizaÃ§Ã£o** e a **troca de mensagens entre os PSPs**.

---

### ğŸŸ¦ Jornada 1: AutorizaÃ§Ã£o sem QR Code, com notificaÃ§Ã£o via app

**Fluxo**:  
O usuÃ¡rio pagador Ã© informado **fora do ecossistema Pix** (ex: ligaÃ§Ã£o, e-mail, WhatsApp) que o recebedor deseja usar o Pix AutomÃ¡tico.

#### ğŸ” Fluxo de Mensagens:

| Etapa | Participante | AÃ§Ã£o | Mensagem Trocada |
|------|--------------|------|------------------|
| 1 | Recebedor â†’ PSP Recebedor | Solicita criaÃ§Ã£o da recorrÃªncia | CriaÃ§Ã£o da recorrÃªncia com status â€œcriadaâ€ |
| 2 | PSP Recebedor â†’ PSP Pagador | Envia solicitaÃ§Ã£o de autorizaÃ§Ã£o via SPI | Mensagem `pain.013` (tipo: autorizaÃ§Ã£o) |
| 3 | PSP Pagador â†’ UsuÃ¡rio Pagador | Notifica via app: â€œAutorizaÃ§Ã£o pendenteâ€ | NotificaÃ§Ã£o no app (ex: push) |
| 4 | UsuÃ¡rio Pagador â†’ PSP Pagador | Confirma autorizaÃ§Ã£o (com autenticaÃ§Ã£o) | AutorizaÃ§Ã£o confirmada no app |
| 5 | PSP Pagador â†’ PSP Recebedor | Informa confirmaÃ§Ã£o da autorizaÃ§Ã£o | Resposta Ã  `pain.013` com status â€œconfirmadaâ€ |
| 6 | PSP Recebedor â†’ Recebedor | Informa sucesso da autorizaÃ§Ã£o | ConfirmaÃ§Ã£o ao recebedor |

> âœ… **Importante**: A troca de dados da recorrÃªncia ocorre **via mensageria Pix (pain.013)**, mesmo sem QR Code.

---

### ğŸŸ¨ Jornada 2: AutorizaÃ§Ã£o com QR Code contendo apenas dados da recorrÃªncia

**Fluxo**:  
O pagador escaneia um QR Code que **sÃ³ contÃ©m dados da recorrÃªncia** (sem cobranÃ§a imediata).

#### ğŸ” Fluxo de Mensagens:

| Etapa | Participante | AÃ§Ã£o | Mensagem Trocada |
|------|--------------|------|------------------|
| 1 | Recebedor â†’ PSP Recebedor | Cria recorrÃªncia e gera QR Code com `location` | Dados da recorrÃªncia armazenados |
| 2 | PSP Recebedor â†’ Sistema | Gera QR Code com `location` apontando para dados da recorrÃªncia | QR Code gerado |
| 3 | UsuÃ¡rio Pagador â†’ App do PSP Pagador | LÃª QR Code ou usa â€œPix Copia e Colaâ€ | App acessa dados via `GET /pix/v2/rec/{txid}` |
| 4 | PSP Pagador â†’ PSP Recebedor | Busca dados da recorrÃªncia via API Pix | RequisiÃ§Ã£o de dados da recorrÃªncia |
| 5 | PSP Pagador â†’ UsuÃ¡rio Pagador | Exibe detalhes e pede confirmaÃ§Ã£o | Tela de autorizaÃ§Ã£o no app |
| 6 | UsuÃ¡rio Pagador â†’ PSP Pagador | Confirma autorizaÃ§Ã£o | AutorizaÃ§Ã£o concedida |
| 7 | PSP Pagador â†’ PSP Recebedor | Confirma autorizaÃ§Ã£o via mensageria Pix | `pain.013` com status â€œconfirmadaâ€ |
| 8 | PSP Recebedor â†’ Recebedor | Informa sucesso da autorizaÃ§Ã£o | ConfirmaÃ§Ã£o ao recebedor |

> âœ… **Destaque**: Nesta jornada, **nÃ£o hÃ¡ pagamento imediato** â€” apenas autorizaÃ§Ã£o.

---

### ğŸŸ¥ Jornada 3: QR Code com cobranÃ§a imediata + dados da recorrÃªncia

**Fluxo**:  
O QR Code contÃ©m **duas informaÃ§Ãµes**: pagamento imediato **e** autorizaÃ§Ã£o para recorrÃªncia futura. O pagamento imediato Ã© obrigatÃ³rio.

#### ğŸ” Fluxo de Mensagens:

| Etapa | Participante | AÃ§Ã£o | Mensagem Trocada |
|------|--------------|------|------------------|
| 1 | Recebedor â†’ PSP Recebedor | Cria cobranÃ§a imediata + recorrÃªncia | Gera QR Code com dois `location` |
| 2 | PSP Recebedor â†’ Sistema | Gera QR Code com dados da cobranÃ§a e da recorrÃªncia | QR Code composto gerado |
| 3 | UsuÃ¡rio Pagador â†’ App | LÃª QR Code | App acessa dados da cobranÃ§a e da recorrÃªncia |
| 4 | PSP Pagador â†’ PSP Recebedor | Busca dados da cobranÃ§a e da recorrÃªncia | `GET /pix/v2/cobr/{txid}` e `GET /pix/v2/rec/{txid}` |
| 5 | App do Pagador | Exibe pagamento imediato **e** autorizaÃ§Ã£o recorrente (com checkbox) | Tela com os dois elementos |
| 6 | UsuÃ¡rio Pagador | Confirma pagamento **e** autorizaÃ§Ã£o | AÃ§Ã£o Ãºnica no app |
| 7 | PSP Pagador â†’ PSP Recebedor | Inicia liquidaÃ§Ã£o do pagamento imediato | Mensagem de Pix normal |
| 8 | PSP Pagador â†’ PSP Recebedor | ApÃ³s sucesso do pagamento, confirma autorizaÃ§Ã£o da recorrÃªncia | `pain.013` com status â€œconfirmadaâ€ |
| 9 | PSP Recebedor â†’ Recebedor | Informa sucesso do pagamento e da autorizaÃ§Ã£o | ConfirmaÃ§Ã£o ao recebedor |

> âš ï¸ **Regra crÃ­tica**: O fluxo de autorizaÃ§Ã£o **sÃ³ prossegue apÃ³s a liquidaÃ§Ã£o do pagamento imediato**.

> ğŸ“Œ **IdentificaÃ§Ã£o**: O pagamento imediato aparece no extrato como **Pix normal**, nÃ£o como Pix AutomÃ¡tico.

---

### ğŸŸ§ Jornada 4: AutorizaÃ§Ã£o apÃ³s pagamento/agendamento com vencimento

**Fluxo**:  
O pagador realiza um **pagamento ou agendamento** (com vencimento) via QR Code e, **ao final**, recebe a oferta de adesÃ£o ao Pix AutomÃ¡tico.

#### ğŸ” Fluxo de Mensagens:

| Etapa | Participante | AÃ§Ã£o | Mensagem Trocada |
|------|--------------|------|------------------|
| 1 | Recebedor â†’ PSP Recebedor | Cria cobranÃ§a com vencimento + recorrÃªncia | Gera QR Code com dois `location` |
| 2 | PSP Recebedor â†’ Sistema | Gera QR Code com dados do pagamento e da recorrÃªncia | QR Code composto |
| 3 | UsuÃ¡rio Pagador â†’ App | LÃª QR Code e paga ou agenda | Pagamento ou agendamento normal |
| 4 | PSP Pagador â†’ PSP Recebedor | Confirma pagamento/agendamento | Mensagem de Pix padrÃ£o |
| 5 | PSP Pagador â†’ UsuÃ¡rio Pagador | Oferece adesÃ£o ao Pix AutomÃ¡tico **apÃ³s** o pagamento | NotificaÃ§Ã£o no app |
| 6 | UsuÃ¡rio Pagador | Aceita ou recusa a autorizaÃ§Ã£o | Resposta no app |
| 7 | PSP Pagador â†’ PSP Recebedor | Confirma autorizaÃ§Ã£o da recorrÃªncia | `pain.013` com status â€œconfirmadaâ€ |
| 8 | PSP Recebedor â†’ Recebedor | Informa sucesso da autorizaÃ§Ã£o | ConfirmaÃ§Ã£o ao recebedor |

> âœ… **Diferencial**: AutorizaÃ§Ã£o Ã© **opcional** e ocorre **apÃ³s** o pagamento inicial.

> âš ï¸ **AtenÃ§Ã£o**: Se houver erro no pagamento ou agendamento, **nÃ£o deve ser ofertado o Pix AutomÃ¡tico**.

---

## ğŸ”„ Mensagens-Chave no Fluxo entre PSPs

A principal mensagem de troca entre PSPs Ã©:

- **`pain.013` â€“ InstruÃ§Ã£o de Pagamento (Pix AutomÃ¡tico)**  
  - Usada em todas as jornadas para **solicitar e confirmar autorizaÃ§Ãµes**.
  - ContÃ©m:
    - Dados da recorrÃªncia (valor, periodicidade, data de inÃ­cio/fim).
    - IdentificaÃ§Ã£o do recebedor e do pagador.
    - Campo `formaDeIniciacao = AUTO`.
    - Campo `tipoPrioridadePagamento = PAGAGD` (pagamento agendado).

> ğŸ“¥ A mensagem `pain.013` Ã© enviada **do PSP recebedor para o PSP pagador** no inÃ­cio da autorizaÃ§Ã£o (Jornada 1) ou como confirmaÃ§Ã£o (outras jornadas).

---

## ğŸ§© ParticipaÃ§Ã£o de PSI (Prestador de ServiÃ§o de IniciaÃ§Ã£o)

Quando hÃ¡ **PSI** envolvido (ex: fintech que gerencia assinaturas):

- O usuÃ¡rio pagador concede **consentimento ao PSI** no Ã¢mbito do **Open Finance**.
- O PSI atua como intermediÃ¡rio, mas a **autorizaÃ§Ã£o final Ã© feita no app do PSP pagador**.
- A comunicaÃ§Ã£o entre PSI e PSPs ocorre via **APIs do Open Finance**.
- O PSP pagador **deve respeitar os parÃ¢metros do consentimento**.

> ğŸ” O consentimento do usuÃ¡rio ao PSI **substitui** a necessidade de nova autorizaÃ§Ã£o direta ao PSP recebedor.

---

## ğŸ“Œ ConclusÃ£o: VisÃ£o de Jornada

| Jornada | InÃ­cio | Pagamento Imediato? | AutorizaÃ§Ã£o | Mensagem Principal |
|--------|-------|----------------------|-------------|---------------------|
| **1** | NotificaÃ§Ã£o fora do Pix | NÃ£o | Via notificaÃ§Ã£o no app | `pain.013` (solicitaÃ§Ã£o) |
| **2** | QR Code (sÃ³ recorrÃªncia) | NÃ£o | Via leitura do QR | `pain.013` (confirmaÃ§Ã£o) |
| **3** | QR Code (cobranÃ§a + recorrÃªncia) | Sim (obrigatÃ³rio) | SimultÃ¢nea ao pagamento | `pain.013` (apÃ³s pagamento) |
| **4** | QR Code (pagamento/agendamento) | Sim (com vencimento) | ApÃ³s pagamento (opcional) | `pain.013` (confirmaÃ§Ã£o) |

---

## âœ… Boas PrÃ¡ticas e Requisitos

- Todos os PSPs pagadores **devem ofertar todas as jornadas**.
- O **extrato** deve identificar transaÃ§Ãµes do Pix AutomÃ¡tico.
- O **comprovante** deve estar disponÃ­vel.
- LiquidaÃ§Ã£o ocorre entre **0h e 8h** (canal secundÃ¡rio).
- Cancelamento pode ser feito pelo **pagador a qualquer momento** (no app).
- Recebedor **nÃ£o pode cancelar apÃ³s 22h do dia anterior** Ã  liquidaÃ§Ã£o.

---

Se desejar, posso gerar um **fluxograma textual ou visual** com base nesse conteÃºdo. Deseja isso?

### USER
Gere um fluxograma visual

### ASSISTANT
Com base no conteÃºdo do **Guia de ImplementaÃ§Ã£o do Pix AutomÃ¡tico (versÃ£o 1.2)**, abaixo estÃ¡ um **fluxograma visual textual** detalhado que representa a **jornada completa do Pix AutomÃ¡tico**, com foco no **fluxo de mensagens entre o PSP pagador e o PSP recebedor**, desde a criaÃ§Ã£o da recorrÃªncia atÃ© a liquidaÃ§Ã£o e gestÃ£o pÃ³s-autorizaÃ§Ã£o.

Este fluxograma cobre as **quatro jornadas de autorizaÃ§Ã£o**, destacando os pontos de decisÃ£o, trocas de mensagens (como `pain.013`, `camt.055`), notificaÃ§Ãµes aos usuÃ¡rios e regras crÃ­ticas.

---

### ğŸ”„ **Fluxograma Visual: Jornada do Pix AutomÃ¡tico**

```
+----------------------------------+
| 1. CriaÃ§Ã£o da RecorrÃªncia        |
| - Recebedor cria recorrÃªncia    |
|   no PSP Recebedor              |
| - Gera ID Ãºnico (ex: RRxxxx...) |
| - Define: valor, periodicidade, |
|   data inÃ­cio/fim, finalidade   |
+----------------------------------+
                  |
                  v
     +----------------------------+
     | 2. Escolha da Jornada de   |
     |    AutorizaÃ§Ã£o             |
     +----------------------------+
                  |
        +---------+---------+---------+---------+
        |                   |                   |
        v                   v                   v
+----------------+  +----------------+  +------------------------+
| Jornada 1:       |  | Jornada 2:       |  | Jornada 3:               |
| Sem QR Code      |  | QR Code (sÃ³     |  | QR Code (pagamento +     |
| NotificaÃ§Ã£o via  |  | recorrÃªncia)    |  | recorrÃªncia)             |
| app              |  |                 |  | Pagamento imediato       |
+----------------+  +----------------+  +------------------------+
        |                   |                   |
        v                   v                   v
+----------------+  +----------------+  +------------------------+
| PSP Recebedor â†’ |  | Gera QR Code    |  | Gera QR Code com:       |
| SPI: pain.013   |  | com location    |  | - location (cobranÃ§a)   |
| (solicita aut.) |  | para recorrÃªncia|  | - location (recorrÃªncia)|
+----------------+  +----------------+  +------------------------+
        |                   |                   |
        v                   v                   v
+----------------+  +----------------+  +------------------------+
| PSP Pagador â†’   |  | UsuÃ¡rio lÃª QR   |  | UsuÃ¡rio lÃª QR Code      |
| UsuÃ¡rio:        |  | Code            |  | - Paga imediatamente    |
| Notifica "Aut.  |  | â†’ App busca     |   (Pix normal)           |
| pendente"       |  | dados via API   | - Autoriza Pix AutomÃ¡tico|
+----------------+  +--------+--------+  +------------------------+
                             |                        |
                             v                        v
                    +--------+--------+     +---------+---------+
                    | UsuÃ¡rio confirma  |     | PSP aguarda liquidaÃ§Ã£o|
                    | autorizaÃ§Ã£o no app|     | do pagamento imediato |
                    +--------+--------+     +---------+---------+
                             |                        |
                             v                        v
          +----------------------------------+  +----+----+
          | 3. ConfirmaÃ§Ã£o da AutorizaÃ§Ã£o    |  | Sucesso? |
          | PSP Pagador â†’ PSP Recebedor      |  +----+----+
          | Envia: pain.013 (status: confirmado)      |
          +----------------+-------------------------+
                           |
                           v
        +----------------------------------------------+
        | 4. Armazenamento da AutorizaÃ§Ã£o              |
        | - PSP Pagador armazena:                      |
        |   â€¢ ID da recorrÃªncia                        |
        |   â€¢ ParÃ¢metros do pagador (ex: valor mÃ¡x.)   |
        | - Dados NÃƒO compartilhados com recebedor     |
        +----------------------------------------------+
                           |
                           v
        +----------------------------------------------+
        | 5. Agendamento do DÃ©bito (por cobranÃ§a)      |
        | - Recebedor envia cobranÃ§a via API Pix       |
        |   ou arquivo padronizado                     |
        | - PSP Recebedor envia: pain.013               |
        |   â€¢ idFimAFim = data de liquidaÃ§Ã£o           |
        |   â€¢ finalidadeDoAgendamento = "RIFL"          |
        |   â€¢ valor, idConciliacaoRecebedor, etc.       |
        +----------------------------------------------+
                           |
                           v
        +----------------------------------------------+
        | 6. PSP Pagador Valida AutorizaÃ§Ã£o            |
        | - Verifica:                                  |
        |   â€¢ ID da recorrÃªncia vÃ¡lida?                |
        |   â€¢ Valor dentro do limite? (se variÃ¡vel)     |
        |   â€¢ Data compatÃ­vel?                         |
        | â†’ Se invÃ¡lido: rejeita e notifica pagador    |
        +----------------+-----------------------------+
                         |
         +---------------+---------------+
         |                               |
         v                               v
+------------------+      +----------------------------+
| Sucesso:         |      | Falha (ex: valor invÃ¡lido,|
| Agendamento      |      | sem autorizaÃ§Ã£o, erro sist.)|
| registrado       |      | â†’ PSP envia camt.054        |
| â†’ Notifica       |      | â†’ Notifica usuÃ¡rio pagador |
| usuÃ¡rio pagador  |      +----------------------------+
+------------------+
         |
         v
+-----------------------------+
| 7. LiquidaÃ§Ã£o (entre 0h e 8h)|
| - PSP Pagador envia ordem   |
|   de pagamento ao SPI       |
| - DÃ©bito automÃ¡tico         |
| - Comprovante gerado        |
+-----------------------------+
         |
         +---------------------+
         |                     |
         v                     v
+------------------+  +-------------------------+
| Sucesso           |  | Falha na LiquidaÃ§Ã£o     |
| â†’ Comprovante     |  | (ex: saldo insuficiente)|
| â†’ Extrato atualizado| â†’ PSP envia camt.055     |
|                   |  |   com motivo = "FAIL"    |
+------------------+  +------------+------------+
                                   |
                                   v
                   +-------------------------------+
                   | Nova Tentativa?               |
                   | OpÃ§Ãµes:                       |
                   | a) IntradiÃ¡ria (RIFL): nova   |
                   |    pain.013 atÃ© 23h59         |
                   | b) PÃ³s-vencimento (NTAG):     |
                   |    PSP Recebedor decide       |
                   |    se tenta novamente         |
                   +-------------------------------+
                                   |
                                   v
                   +-------------------------------+
                   | PSP Recebedor envia nova      |
                   | pain.013 com:                 |
                   | â€¢ novo idFimAFim              |
                   | â€¢ finalidadeDoAgendamento =   |
                   |   "RIFL" ou "NTAG"            |
                   +-------------------------------+
                                   |
                                   v
                              (retorna ao passo 6)

         |
         v
+----------------------------------+
| 8. GestÃ£o PÃ³s-AutorizaÃ§Ã£o        |
| - UsuÃ¡rio pagador pode:          |
|   â€¢ Cancelar autorizaÃ§Ã£o a qualquer momento |
|   â€¢ Cancelar agendamento atÃ© vÃ©spera |
|   â€¢ Consultar pagamentos agendados |
|   â€¢ Habilitar/desabilitar notificaÃ§Ãµes |
| - PSP Pagador notifica:          |
|   â€¢ Sucesso/insucesso agendamento|
|   â€¢ Cancelamento (pagador ou recebedor) |
+----------------------------------+

         |
         v
+----------------------------------+
| 9. DevoluÃ§Ã£o (MED)               |
| - Pagador pode solicitar devoluÃ§Ã£o|
|   em atÃ© 90 dias                  |
| - PSP Pagador devolve recursos   |
|   em atÃ© 24h (com comprovante)   |
| - Depois, solicita ressarcimento |
|   ao PSP Recebedor via DICT      |
+----------------------------------+
```

---

### ğŸ”‘ **Legenda de Mensagens e CÃ³digos**

| SÃ­mbolo | Significado |
|--------|------------|
| `pain.013` | Mensagem de **InstruÃ§Ã£o de Pagamento** (autorizaÃ§Ã£o, agendamento, nova tentativa) |
| `camt.054` | Mensagem de **rejeiÃ§Ã£o da instruÃ§Ã£o** (antes da liquidaÃ§Ã£o) |
| `camt.055` | Mensagem de **cancelamento da ordem** (apÃ³s falha na liquidaÃ§Ã£o) |
| `RIFL`   | Finalidade: **ReinÃ­cio da InstruÃ§Ã£o por Falha na LiquidaÃ§Ã£o** (intradiÃ¡ria) |
| `NTAG`   | Finalidade: **Nova Tentativa pÃ³s Vencimento** |
| `MED`    | Mecanismo Especial de DevoluÃ§Ã£o â€“ elegÃ­vel para Pix AutomÃ¡tico |

---

### ğŸ“Œ **Principais Regras do Fluxo**

1. **NotificaÃ§Ã£o ao Pagador**:
   - ObrigatÃ³ria apÃ³s agendamento, cancelamento ou falha.
   - Pode ser habilitada/desabilitada pelo usuÃ¡rio.

2. **QR Code**:
   - Faixa 26-51: obrigatÃ³ria (mesmo que vazio, para compatibilidade).
   - Faixa 80-99: opcional, usada para dados da recorrÃªncia.

3. **AlteraÃ§Ã£o de RecorrÃªncia**:
   - SÃ³ permitida **antes da confirmaÃ§Ã£o**.
   - ApÃ³s confirmaÃ§Ã£o: deve-se **cancelar e criar nova**.

4. **Cancelamento**:
   - Pagador pode cancelar **a qualquer momento**.
   - Recebedor pode cancelar, mas **nÃ£o apÃ³s 22h do dia anterior** Ã  liquidaÃ§Ã£o.

5. **PSI (Prestador de ServiÃ§o de IniciaÃ§Ã£o)**:
   - Fluxo regido pelo **Open Finance**.
   - Consentimento do usuÃ¡rio ao PSI substitui necessidade de nova autorizaÃ§Ã£o direta.

---

### ğŸ–¼ï¸ Deseja o Fluxograma em Formato Visual (Imagem)?

Se desejar, posso gerar um **diagrama em Mermaid.js** (para uso em plataformas como Notion, GitHub, ou editores online) ou converter este conteÃºdo em um **arquivo PNG/SVG** (via ferramenta externa). 

#### Exemplo em Mermaid (copie e cole em um editor compatÃ­vel):

```mermaid
graph TD
    A[CriaÃ§Ã£o da RecorrÃªncia] --> B[Escolha da Jornada]
    B --> C[Jornada 1: NotificaÃ§Ã£o via App]
    B --> D[Jornada 2: QR Code (sÃ³ recorrÃªncia)]
    B --> E[Jornada 3: QR Code + Pagamento Imediato]
    B --> F[Jornada 4: QR Code + Agendamento]

    C --> G[PSP Recebedor envia pain.013]
    G --> H[PSP Pagador notifica usuÃ¡rio]
    H --> I[UsuÃ¡rio confirma no app]
    I --> J[PSP Pagador confirma com pain.013]

    D --> K[Gera QR Code com location]
    K --> L[UsuÃ¡rio lÃª QR Code]
    L --> M[App busca dados via API]
    M --> N[UsuÃ¡rio confirma]
    N --> J

    E --> O[Gera QR Code composto]
    O --> P[UsuÃ¡rio paga + autoriza]
    P --> Q[Aguarda liquidaÃ§Ã£o do pagamento imediato]
    Q --> J

    J --> K1[Armazenamento da AutorizaÃ§Ã£o]
    K1 --> L1[Agendamento: PSP envia pain.013 (RIFL)]
    L1 --> M1{ValidaÃ§Ã£o no PSP Pagador?}
    M1 -->|Sim| N1[Agendamento confirmado]
    M1 -->|NÃ£o| O1[Rejeita com camt.054 + notifica]
    N1 --> P1[LiquidaÃ§Ã£o (0h-8h)]
    P1 --> Q1{Sucesso?}
    Q1 -->|Sim| R1[Fim - Comprovante gerado]
    Q1 -->|NÃ£o| S1[Envia camt.055 (FAIL)]
    S1 --> T1[Decide: RIFL ou NTAG?]
    T1 --> U1[Envia nova pain.013]
    U1 --> L1

    R1 --> V1[GestÃ£o: cancelamento, consulta, notificaÃ§Ãµes]
    V1 --> W1[DevoluÃ§Ã£o via MED (atÃ© 90 dias)]
```

---

Se quiser, posso gerar um **PDF ou imagem do fluxograma**. Deseja isso?

### USER
NÃ£o fluxo de pain009?

### ASSISTANT
Ã“tima pergunta! VocÃª estÃ¡ absolutamente certo em questionar o **fluxo da mensagem `pain.009`**, pois, com base no conteÃºdo do **Guia de ImplementaÃ§Ã£o do Pix AutomÃ¡tico (versÃ£o 1.1)** que vocÃª enviou, **a `pain.009` desempenha um papel fundamental no inÃ­cio da jornada de autorizaÃ§Ã£o**, especialmente na **Jornada 1**.

Vamos esclarecer com precisÃ£o **o que Ã© a `pain.009`**, **onde ela se encaixa no fluxo**, e **por que ela Ã© crÃ­tica**, mesmo que nÃ£o tenha sido destacada no meu fluxograma anterior.

---

## ğŸ§© O que Ã© a `pain.009`?

A **`pain.009`** Ã© a mensagem oficial do **CatÃ¡logo de Mensagens do SPI** chamada:

> **"SolicitaÃ§Ã£o de ConfirmaÃ§Ã£o de RecorrÃªncia"**

Ela Ã© enviada **do PSP recebedor para o PSP pagador** com o objetivo de **iniciar o processo de autorizaÃ§Ã£o do Pix AutomÃ¡tico**, informando os detalhes da recorrÃªncia que o usuÃ¡rio pagador deve confirmar.

---

## ğŸ” Fluxo Correto com `pain.009` â€“ Foco na Jornada 1

A **Jornada 1** (autorizaÃ§Ã£o sem QR Code, com notificaÃ§Ã£o via app) **comeÃ§a com a `pain.009`**, nÃ£o com a `pain.013`.

Corrigindo e aprofundando o fluxo com base no documento:

```
+----------------------------------+
| 1. CriaÃ§Ã£o da RecorrÃªncia        |
| - Recebedor cria recorrÃªncia no  |
|   PSP Recebedor (status: criada) |
+----------------------------------+
                  |
                  v
+----------------------------------+
| 2. PSP Recebedor envia pain.009  |
| - Envia ao PSP Pagador via SPI   |
| - ContÃ©m:                        |
|   â€¢ Dados da recorrÃªncia         |
|   â€¢ ID da recorrÃªncia (ex: RR...)|
|   â€¢ Valor, periodicidade,        |
|     data inÃ­cio/fim, finalidade  |
|   â€¢ formaDeIniciacao = AUTO      |
+----------------------------------+
                  |
                  v
+----------------------------------+
| 3. PSP Pagador notifica usuÃ¡rio  |
| - App exibe notificaÃ§Ã£o:         |
|   â€œVocÃª foi convidado a autorizar |
|   um pagamento recorrenteâ€       |
| - Aguarda confirmaÃ§Ã£o do usuÃ¡rio |
+----------------------------------+
                  |
                  v
+----------------------------------+
| 4. UsuÃ¡rio Pagador confirma      |
| - Confirma (ou rejeita) no app   |
| - AutenticaÃ§Ã£o por biometria,    |
|   senha, etc.                    |
+----------------------------------+
                  |
         +--------+--------+
         |                 |
         v                 v
+----------------+  +----------------------+
| ConfirmaÃ§Ã£o     |  | RejeiÃ§Ã£o             |
|                 |  |                      |
| â†’ PSP Pagador   |  | â†’ PSP Pagador envia  |
| envia pain.012  |  | pain.012 com status   |
| com status=true |  | = false              |
|                 |  |                      |
| (confirma aut.) |  | (nÃ£o hÃ¡ retorno ao   |
|                 |  | PSP Recebedor)       |
+----------------+  +----------------------+
         |
         v
+----------------------------------+
| 5. PSP Pagador envia pain.012    |
| - Com status = true              |
| - Informa:                       |
|   â€¢ codMunIBGE (municÃ­pio do pagador) |
|   â€¢ dados do usuÃ¡rio pagador     |
|   â€¢ confirmaÃ§Ã£o da autorizaÃ§Ã£o   |
+----------------------------------+
                  |
                  v
+----------------------------------+
| 6. PSP Recebedor recebe pain.012 |
| - Armazena confirmaÃ§Ã£o           |
| - Atualiza status da recorrÃªncia |
|   para â€œconfirmadaâ€              |
| - Pode agora enviar cobranÃ§as   |
|   via pain.013                   |
+----------------------------------+
```

---

## ğŸ“Œ Papel das Mensagens no Fluxo

| Mensagem | Sentido | DescriÃ§Ã£o |
|--------|--------|----------|
| **`pain.009`** | PSP Recebedor â†’ PSP Pagador | **Inicia a autorizaÃ§Ã£o**. Envia os dados da recorrÃªncia para que o pagador possa confirmar. |
| **`pain.012`** | PSP Pagador â†’ PSP Recebedor | **Confirma ou rejeita a autorizaÃ§Ã£o**. Se `status=true`, a recorrÃªncia estÃ¡ autorizada. |
| **`pain.013`** | PSP Recebedor â†’ PSP Pagador | **InstruÃ§Ã£o de pagamento** (agendamento). SÃ³ pode ser enviada **apÃ³s** a `pain.012` com `status=true`. |

> âœ… **Regra clara no documento**:  
> > *"SolicitaÃ§Ã£o de confirmaÃ§Ã£o de recorrÃªncia: corresponde Ã  mensagem pain.009, enviada ao PSP pagador para que ele apresente ao usuÃ¡rio pagador uma recorrÃªncia de cobranÃ§as que, se confirmada pelo usuÃ¡rio, podem ser pagas por meio do Pix AutomÃ¡tico."*

---

## â— Por que a `pain.009` nÃ£o apareceu antes?

No meu fluxograma anterior, **foi um erro de foco** â€” eu **generalizei o inÃ­cio do fluxo como `pain.013`**, o que estÃ¡ **incorreto para a Jornada 1**. A `pain.013` Ã© usada **apÃ³s a autorizaÃ§Ã£o**, para **agendar pagamentos**.

A `pain.009` Ã© **especÃ­fica da Jornada 1**. Nas outras jornadas (2, 3 e 4), a autorizaÃ§Ã£o Ã© feita via **QR Code + interaÃ§Ã£o direta no app**, e **nÃ£o hÃ¡ necessidade de `pain.009`**, porque a **confirmaÃ§Ã£o jÃ¡ Ã© feita com `pain.012` diretamente**.

---

## âœ… Resumo: Quando usar `pain.009`?

| Jornada | Usa `pain.009`? | ExplicaÃ§Ã£o |
|--------|-----------------|-----------|
| **Jornada 1** (notificaÃ§Ã£o via app) | âœ… Sim | PSP recebedor inicia com `pain.009` |
| **Jornada 2** (QR Code sÃ³ recorrÃªncia) | âŒ NÃ£o | AutorizaÃ§Ã£o via leitura do QR â†’ `pain.012` direto |
| **Jornada 3** (QR Code + pagamento imediato) | âŒ NÃ£o | AutorizaÃ§Ã£o simultÃ¢nea ao pagamento â†’ `pain.012` |
| **Jornada 4** (QR Code + agendamento) | âŒ NÃ£o | AutorizaÃ§Ã£o apÃ³s pagamento/agendamento â†’ `pain.012` |

---

## ğŸ”„ Fluxo Alternativo: Jornadas 2, 3 e 4 (sem `pain.009`)

Nessas jornadas, o fluxo comeÃ§a com o **usuÃ¡rio pagador lendo um QR Code**, e o app do PSP pagador faz um `GET /pix/v2/rec/{txid}` para buscar os dados da recorrÃªncia. ApÃ³s a confirmaÃ§Ã£o, o PSP pagador envia **diretamente a `pain.012`** ao PSP recebedor.

```
QR Code â†’ GET /rec/{txid} â†’ ConfirmaÃ§Ã£o no app â†’ pain.012 (sem pain.009)
```

---

## ğŸ“š ConclusÃ£o

- A **`pain.009` Ã© essencial na Jornada 1**, onde nÃ£o hÃ¡ QR Code.
- Ela **inicia o processo de autorizaÃ§Ã£o** entre PSPs.
- A **`pain.012` Ã© a resposta do PSP pagador**, confirmando ou rejeitando.
- A **`pain.013` sÃ³ entra em cena depois**, para **agendar os dÃ©bitos recorrentes**.
- Nas jornadas com QR Code, **a `pain.009` nÃ£o Ã© usada** â€” a autorizaÃ§Ã£o Ã© iniciada pelo prÃ³prio usuÃ¡rio ao interagir com o QR.

---

Se desejar, posso atualizar o **fluxograma visual** para incluir a `pain.009` corretamente na Jornada 1. Deseja isso?

### USER
Sim, revise tudo e gere a informaÃ§Ã£o completa e nÃ£o economize tokens.

### ASSISTANT
Com base na anÃ¡lise completa e detalhada do **Guia de ImplementaÃ§Ã£o do Pix AutomÃ¡tico (versÃ£o 1.2)**, apresento abaixo uma **visÃ£o integrada, tÃ©cnica e operacional** do fluxo do Pix AutomÃ¡tico, com foco na **jornada de troca de mensagens entre o PSP pagador e o PSP recebedor**, incluindo todas as **jornadas de autorizaÃ§Ã£o**, as **mensagens do SPI (pain.009, pain.012, pain.013, camt.054, camt.055)**, os **papÃ©is dos usuÃ¡rios**, as **regras de validaÃ§Ã£o**, os **fluxos de erro**, e as **responsabilidades de notificaÃ§Ã£o**.

Este documento Ã© uma **referÃªncia completa e definitiva** para especialistas em Pix, equipes de desenvolvimento, compliance e operaÃ§Ãµes de instituiÃ§Ãµes financeiras e fintechs.

---

# ğŸ“˜ **Guia Completo: Jornada do Pix AutomÃ¡tico â€“ Fluxo de Mensagens entre PSPs**

---

## ğŸ” **1. IntroduÃ§Ã£o**

O **Pix AutomÃ¡tico** Ã© um mecanismo de **pagamento recorrente autorizado previamente** pelo usuÃ¡rio pagador, que permite o **dÃ©bito automÃ¡tico** de valores em sua conta transacional, mediante **autorizaÃ§Ã£o explÃ­cita** e **agendamento prÃ©vio** via infraestrutura do Sistema de Pagamentos InstantÃ¢neos (SPI) do Banco Central.

Este guia detalha o **fluxo completo**, com foco na **troca de mensagens entre os PSPs (Participantes do SPI)**, com base no **Guia de ImplementaÃ§Ã£o do Pix AutomÃ¡tico (v1.2)**.

---

## ğŸ§© **2. Etapas Fundamentais do Pix AutomÃ¡tico**

O processo pode ser dividido em **6 etapas principais**:

1. **CriaÃ§Ã£o da RecorrÃªncia**
2. **AutorizaÃ§Ã£o (com 4 jornadas possÃ­veis)**
3. **Agendamento do DÃ©bito (via pain.013)**
4. **LiquidaÃ§Ã£o**
5. **GestÃ£o PÃ³s-Pagamento (notificaÃ§Ãµes, cancelamentos, retentativas)**
6. **DevoluÃ§Ã£o (MED)**

Vamos detalhar cada uma.

---

## âœ… **3. Etapa 1: CriaÃ§Ã£o da RecorrÃªncia**

### ğŸ“Œ ResponsÃ¡vel: **PSP Recebedor** (por solicitaÃ§Ã£o do **usuÃ¡rio recebedor**)

### ğŸ“¥ Dados da RecorrÃªncia
A recorrÃªncia Ã© criada com status **â€œpendente de confirmaÃ§Ã£oâ€** e contÃ©m os seguintes dados:

| Campo | DescriÃ§Ã£o |
|------|----------|
| `idRecorrencia` | ID Ãºnico no formato: `RRxxxxxxxxyyyyMMddkkkkkkkkkkk` (29 caracteres) |
| `formaDeIniciacao` | Sempre `AUTO` |
| `valor` | ObrigatÃ³rio apenas para recorrÃªncias de **valor fixo** |
| `periodicidade` | Semanal, mensal, trimestral, semestral, anual |
| `dataInicio` | Data de inÃ­cio da vigÃªncia |
| `dataFim` | Opcional. Recomenda-se que esteja alguns dias apÃ³s o Ãºltimo pagamento previsto |
| `descricao` | DescriÃ§Ã£o opcional do objeto da cobranÃ§a |
| `idObjetoCobranca` | NÃºmero do contrato, pedido ou cÃ³digo do cliente |
| `politicaRetentativa` | Define se permite novas tentativas apÃ³s vencimento (`S` ou `N`) |

> ğŸ“Œ **Regra**: O campo `idRecorrencia` codifica informaÃ§Ãµes:
> - `RR` = criada no Pix + permite retentativas pÃ³s-vencimento
> - `RN` = criada no Pix + **nÃ£o** permite retentativas
> - `CR`/`CN` = criada via Open Finance

---

## ğŸ” **4. Etapa 2: AutorizaÃ§Ã£o â€“ As 4 Jornadas**

A autorizaÃ§Ã£o Ã© o momento em que o **usuÃ¡rio pagador confirma** que aceita o pagamento recorrente. Existem **4 jornadas possÃ­veis**, com diferentes pontos de partida.

---

### ğŸŸ¦ **Jornada 1: AutorizaÃ§Ã£o sem QR Code (NotificaÃ§Ã£o via App)**

**Fluxo**: O usuÃ¡rio pagador Ã© convidado a autorizar uma recorrÃªncia por canais **externos ao Pix** (ex: e-mail, ligaÃ§Ã£o, app do recebedor).

#### ğŸ” Fluxo de Mensagens

```mermaid
sequenceDiagram
    participant Recebedor
    participant PSPR as PSP Recebedor
    participant PSPC as PSP Pagador
    participant Pagador

    Recebedor->>PSPR: Solicita criaÃ§Ã£o da recorrÃªncia
    PSPR->>PSPC: Envia pain.009 (solicitaÃ§Ã£o de confirmaÃ§Ã£o)
    PSPC->>Pagador: Notifica via app: "Autorizar recorrÃªncia?"
    Pagador->>PSPC: Confirma (com autenticaÃ§Ã£o)
    PSPC->>PSPR: Envia pain.012 (status = true)
    PSPR->>Recebedor: Informa sucesso da autorizaÃ§Ã£o
```

#### ğŸ”‘ Mensagens
- **`pain.009`**: Inicia a autorizaÃ§Ã£o. ContÃ©m todos os dados da recorrÃªncia.
- **`pain.012`**: Resposta do PSP pagador. Se `status=true`, a autorizaÃ§Ã£o estÃ¡ confirmada.

> âš ï¸ **Importante**: Se o PSP pagador **nÃ£o tiver o codMunIBGE**, deve preencher como `0000000` na `pain.012`.

> ğŸ“Œ **Regra**: NÃ£o podem existir mÃºltiplas `pain.009` ativas para a mesma recorrÃªncia.

---

### ğŸŸ¨ **Jornada 2: QR Code (sÃ³ recorrÃªncia)**

**Fluxo**: O pagador escaneia um QR Code que **aponta apenas para os dados da recorrÃªncia**.

#### ğŸ” Fluxo de Mensagens

```mermaid
sequenceDiagram
    participant Recebedor
    participant PSPR
    participant PSPC
    participant Pagador

    Recebedor->>PSPR: Cria recorrÃªncia + gera QR Code com location
    PSPR->>Recebedor: Gera QR Code (faixa 80-99)
    Pagador->>PSPC: LÃª QR Code
    PSPC->>PSPR: GET /pix/v2/rec/{txid}
    PSPR->>PSPC: Retorna dados da recorrÃªncia
    PSPC->>Pagador: Exibe detalhes e pede confirmaÃ§Ã£o
    Pagador->>PSPC: Confirma
    PSPC->>PSPR: Envia pain.012 (status = true)
    PSPR->>Recebedor: Informa sucesso
```

> âœ… **NÃ£o hÃ¡ `pain.009`** nesta jornada. A `pain.012` Ã© enviada diretamente apÃ³s a confirmaÃ§Ã£o.

---

### ğŸŸ¥ **Jornada 3: QR Code Composto (Pagamento Imediato + RecorrÃªncia)**

**Fluxo**: QR Code com **dois payloads**:
- Um para **pagamento imediato** (via `location` ou dados estÃ¡ticos)
- Outro para **recorrÃªncia** (sempre via `location`)

#### ğŸ” Fluxo de Mensagens

```mermaid
sequenceDiagram
    participant Recebedor
    participant PSPR
    participant PSPC
    participant Pagador

    Recebedor->>PSPR: Cria cobranÃ§a imediata + recorrÃªncia
    PSPR->>Recebedor: Gera QR Code composto
    Pagador->>PSPC: LÃª QR Code
    PSPC->>PSPR: GET /cobv/{txid} e GET /rec/{txid}
    PSPR->>PSPC: Retorna dados
    PSPC->>Pagador: Exibe pagamento + checkbox "Autorizar recorrÃªncia"
    Pagador->>PSPC: Confirma ambos
    PSPC->>PSPR: Inicia Pix imediato (pacs.008)
    PSPC->>PSPR: ApÃ³s sucesso, envia pain.012 (status = true)
    PSPR->>Recebedor: Informa sucesso do pagamento e da autorizaÃ§Ã£o
```

> âš ï¸ **Regra crÃ­tica**: A autorizaÃ§Ã£o da recorrÃªncia **sÃ³ Ã© confirmada apÃ³s a liquidaÃ§Ã£o do pagamento imediato**.

> ğŸ“Œ **Extrato**: O pagamento imediato aparece como **Pix normal**, nÃ£o como Pix AutomÃ¡tico.

---

### ğŸŸ§ **Jornada 4: AutorizaÃ§Ã£o ApÃ³s Pagamento/Agendamento com Vencimento**

**Fluxo**: O usuÃ¡rio paga ou agenda uma cobranÃ§a com vencimento e, **ao final**, recebe a oferta de adesÃ£o ao Pix AutomÃ¡tico.

#### ğŸ” Fluxo de Mensagens

```mermaid
sequenceDiagram
    participant Recebedor
    participant PSPR
    participant PSPC
    participant Pagador

    Recebedor->>PSPR: Cria cobranÃ§a com vencimento + recorrÃªncia
    PSPR->>Recebedor: Gera QR Code composto
    Pagador->>PSPC: LÃª QR Code e paga/agenda
    PSPC->>PSPR: Confirma pagamento/agendamento
    PSPC->>Pagador: Oferece adesÃ£o ao Pix AutomÃ¡tico
    Pagador->>PSPC: Aceita ou recusa
    alt Aceita
        PSPC->>PSPR: Envia pain.012 (status = true)
        PSPR->>Recebedor: Informa sucesso
    else Recusa
        PSPC->>PSPR: NÃ£o envia nada
    end
```

> âœ… **Diferencial**: AutorizaÃ§Ã£o **opcional** e **pÃ³s-pagamento**.

> âš ï¸ **Regra**: Se o pagamento falhar, **nÃ£o pode ser ofertado** o Pix AutomÃ¡tico.

---

## ğŸ”„ **5. Etapa 3: Agendamento do DÃ©bito (InstruÃ§Ã£o de Pagamento)**

ApÃ³s a autorizaÃ§Ã£o, o **PSP recebedor envia a `pain.013`** para agendar o dÃ©bito.

### ğŸ“¥ `pain.013` â€“ InstruÃ§Ã£o de Pagamento

| Campo | Valor |
|------|-------|
| `formaDeIniciacao` | `AUTO` |
| `idFimAFim` | Data prevista para liquidaÃ§Ã£o (no formato `YYYYMMDD`) |
| `finalidadeDoAgendamento` | Pode ser: `AGND`, `RIFL`, `NTAG` |
| `valor` | Valor da cobranÃ§a |
| `idConciliacaoRecebedor` | ID para conciliaÃ§Ã£o |
| `dataHoraCriacaoParaEmissao` | Data/hora de envio da instruÃ§Ã£o (para validaÃ§Ã£o de prazo) |

### ğŸ“… **Prazos de Envio**
- A `pain.013` deve ser enviada **entre 2 e 10 dias corridos antes** da data de liquidaÃ§Ã£o.
- O PSP pagador valida com base no campo `dataHoraCriacaoParaEmissao`.

---

### ğŸš« **ValidaÃ§Ãµes no PSP Pagador**

O PSP pagador **rejeita** o agendamento se:

| CondiÃ§Ã£o | Mensagem |
|--------|---------|
| Valor â‰  valor autorizado (fixo) | `camt.054` |
| Valor > valor mÃ¡ximo (variÃ¡vel) | `camt.054` |
| Data incompatÃ­vel com periodicidade | `camt.054` |
| CNPJ do recebedor divergente | `pain.014` com erro `AB10` |
| Sem autorizaÃ§Ã£o vigente | `camt.054` |
| Fora do prazo (menos de 2 dias) | `camt.054` |

> âœ… **ExceÃ§Ã£o**: InstruÃ§Ãµes com `finalidadeDoAgendamento = RIFL` **nÃ£o sÃ£o validadas quanto a valor mÃ¡ximo ou autorizaÃ§Ã£o ativa**.

---

## ğŸ’¸ **6. Etapa 4: LiquidaÃ§Ã£o**

- Ocorre entre **0h e 8h** do dia agendado.
- O PSP pagador envia uma **ordem de pagamento (pacs.008)** ao SPI.
- Se houver **insuficiÃªncia de saldo ou falha operacional**, o PSP pagador **nÃ£o envia a ordem** e notifica o usuÃ¡rio.

### ğŸ›‘ **ApÃ³s as 21h:**
- **NÃ£o sÃ£o aceitas novas instruÃ§Ãµes com `RIFL`**.
- Se o pagamento nÃ£o foi liquidado, o PSP pagador **informa o usuÃ¡rio** que deve pagar por outros meios.

---

## ğŸ” **7. Retentativas de Pagamento**

Se o pagamento falhar, hÃ¡ dois tipos de retentativa:

### ğŸ”„ **RIFL (ReinÃ­cio da InstruÃ§Ã£o por Falha na LiquidaÃ§Ã£o)**
- Usada **intradiariamente** (atÃ© 23h59 do dia anterior).
- Finalidade: `RIFL`
- Pode ser reenviada vÃ¡rias vezes.
- **NÃ£o Ã© validada quanto a valor mÃ¡ximo**.

### ğŸ“… **NTAG (Nova Tentativa pÃ³s Vencimento)**
- Usada **quando a recorrÃªncia permite retentativas apÃ³s vencimento**.
- Finalidade: `NTAG`
- Enviada via `POST /cobr/{txid}/retentativa/{data}`
- **UsuÃ¡rio pagador nÃ£o pode cancelar** agendamentos com `NTAG`.

> ğŸ“Œ **Regra**: O campo `politicaRetentativa` da recorrÃªncia define se `NTAG` Ã© permitida.

---

## ğŸ“¢ **8. NotificaÃ§Ãµes ObrigatÃ³rias**

### ğŸ“± **Para o UsuÃ¡rio Pagador**
O PSP pagador **deve notificar** em:
- Sucesso/insucesso do agendamento
- Cancelamento do agendamento (por ele ou pelo recebedor)
- Falha na liquidaÃ§Ã£o
- Oferta de adesÃ£o (Jornada 4)

> âœ… **Pode ser desabilitado** pelo usuÃ¡rio.

### ğŸ“± **Para o UsuÃ¡rio Recebedor**
O PSP recebedor **deve informar**:
- Sucesso/insucesso do agendamento
- Cancelamento pelo pagador
- Sucesso/insucesso do cancelamento da cobranÃ§a

---

## ğŸš« **9. Cancelamento**

### ğŸ›‘ **Pelo UsuÃ¡rio Pagador**
- Pode cancelar **a qualquer momento**.
- O agendamento Ã© cancelado atÃ© a **vÃ©spera da liquidaÃ§Ã£o**.
- ApÃ³s 22h do dia anterior, **nÃ£o pode mais cancelar**.

### ğŸ›‘ **Pelo UsuÃ¡rio Recebedor**
- Pode cancelar a cobranÃ§a.
- **ApÃ³s 22h do dia anterior**, o PSP recebedor **deve rejeitar** o cancelamento.

---

## ğŸ”„ **10. AlteraÃ§Ã£o de RecorrÃªncia**

- **NÃ£o Ã© permitido alterar recorrÃªncia confirmada**.
- Deve-se:
  1. **Cancelar** a recorrÃªncia atual
  2. **Criar uma nova** com os dados alterados
  3. **Solicitar nova autorizaÃ§Ã£o**

> âš ï¸ **ExceÃ§Ã£o**: AlteraÃ§Ãµes antes da confirmaÃ§Ã£o sÃ£o permitidas.

---

## ğŸ” **11. Papel do PSI (Prestador de ServiÃ§o de IniciaÃ§Ã£o)**

No modelo Open Finance:

- O usuÃ¡rio pagador concede **consentimento ao PSI**.
- O PSI atua como intermediÃ¡rio.
- O PSP pagador **valida o consentimento** a cada pagamento.
- Se os dados nÃ£o batem ou o consentimento estiver expirado, **nÃ£o agenda o dÃ©bito**.

> ğŸ“Œ O consentimento contÃ©m:
> - ID da recorrÃªncia
> - Valor mÃ¡ximo
> - PerÃ­odo de vigÃªncia
> - Status (`AUTHORIZED`, `REVOKED`, etc.)

---

## ğŸ”„ **12. Fluxo de Erros e Cancelamentos**

| Mensagem | Uso |
|--------|-----|
| `camt.054` | RejeiÃ§Ã£o **antes** da liquidaÃ§Ã£o (ex: valor invÃ¡lido) |
| `camt.055` | Cancelamento **apÃ³s** falha na liquidaÃ§Ã£o |
| `pain.014` | Erros especÃ­ficos (ex: `AB10` = CNPJ divergente) |

---

## ğŸ“„ **13. MED â€“ Mecanismo Especial de DevoluÃ§Ã£o**

- O usuÃ¡rio pagador pode solicitar devoluÃ§Ã£o em atÃ© **90 dias**.
- O PSP pagador **devolve em atÃ© 24h**.
- Depois, solicita ressarcimento ao PSP recebedor via **DICT**.

> âœ… **ElegÃ­vel** para Pix AutomÃ¡tico.

---

## ğŸ“Š **14. Resumo das Mensagens do SPI**

| Mensagem | Origem â†’ Destino | Finalidade |
|--------|------------------|-----------|
| `pain.009` | PSP Recebedor â†’ PSP Pagador | Iniciar autorizaÃ§Ã£o (Jornada 1) |
| `pain.012` | PSP Pagador â†’ PSP Recebedor | Confirmar/rejeitar autorizaÃ§Ã£o |
| `pain.013` | PSP Recebedor â†’ PSP Pagador | Agendar dÃ©bito recorrente |
| `camt.054` | PSP Pagador â†’ PSP Recebedor | Rejeitar agendamento |
| `camt.055` | PSP Pagador â†’ PSP Recebedor | Cancelar ordem apÃ³s falha |
| `pain.014` | PSP Recebedor â†’ PSP Pagador | Informar erro especÃ­fico |
| `pacs.008` | PSP Pagador â†’ SPI | Ordem de pagamento (liquidaÃ§Ã£o) |

---

## ğŸ“Œ **15. Boas PrÃ¡ticas e Regras CrÃ­ticas**

1. **QR Code**:
   - Faixa 26-51: obrigatÃ³ria (mesmo que vazia).
   - Faixa 80-99: opcional, para dados da recorrÃªncia.

2. **Valor MÃ¡ximo**:
   - Armazenado apenas no **PSP pagador** (nÃ£o compartilhado).
   - AplicÃ¡vel apenas a recorrÃªncias de **valor variÃ¡vel**.

3. **Ajuste de Dia Ãštil**:
   - Se a data de pagamento cair em dia nÃ£o Ãºtil, o PSP recebedor **deve ajustar para o prÃ³ximo dia Ãºtil**, considerando **feriados locais** (com base no `codMunIBGE`).

4. **Data Final da RecorrÃªncia**:
   - Deve ser alguns dias apÃ³s o Ãºltimo pagamento, para permitir retentativas.

5. **NotificaÃ§Ã£o de Agendamento**:
   - Deve ocorrer **imediatamente**, exceto se for de madrugada (neste caso, adiar para horÃ¡rio diurno).

---

## ğŸ **ConclusÃ£o**

O Pix AutomÃ¡tico Ã© um sistema robusto, seguro e flexÃ­vel, que combina **autorizaÃ§Ã£o explÃ­cita**, **agendamento prÃ©vio**, **liquidaÃ§Ã£o automÃ¡tica** e **gestÃ£o de erros padronizada**.

As **quatro jornadas de autorizaÃ§Ã£o** permitem adaptaÃ§Ã£o a diferentes modelos de negÃ³cio, desde assinaturas digitais atÃ© pagamentos recorrentes em lojas fÃ­sicas.

O **fluxo de mensagens entre PSPs** â€” especialmente `pain.009`, `pain.012`, `pain.013`, `camt.054` e `camt.055` â€” Ã© o coraÃ§Ã£o do sistema, garantindo **integridade, seguranÃ§a e transparÃªncia**.

---

Se desejar, posso gerar:
- Um **diagrama Mermaid completo** com todas as jornadas
- Um **modelo de API Pix** para criaÃ§Ã£o de recorrÃªncia
- Um **checklist de conformidade** para PSPs
- Um **fluxograma em PNG/SVG**

Deseja algum desses artefatos?

### USER
Quero todas as opÃ§Ãµes.Nao economize tokens

### ASSISTANT
Com base na anÃ¡lise completa do **Guia de ImplementaÃ§Ã£o do Pix AutomÃ¡tico (versÃ£o 1.2)**, e atendendo ao seu pedido de **informaÃ§Ã£o completa, detalhada e sem economia de tokens**, apresento abaixo um **documento tÃ©cnico definitivo** sobre o Pix AutomÃ¡tico.

Este conteÃºdo Ã© o mais completo possÃ­vel, integrando:
- **Todas as jornadas de autorizaÃ§Ã£o**
- **O fluxo completo de mensagens entre PSPs** (pain.009, pain.012, pain.013, camt.054, camt.055, pacs.008)
- **Regras de validaÃ§Ã£o, cancelamento, retentativas e liquidaÃ§Ã£o**
- **Funcionalidades obrigatÃ³rias para pagador e recebedor**
- **Papel do PSI (Open Finance)**
- **Modelos de QR Code**
- **Checklist de conformidade**
- **Fluxograma Mermaid completo**
- **Modelo de API Pix**
- **Checklist de notificaÃ§Ãµes**
- **PDF e PNG do fluxograma (via link simulado)**

---

# ğŸ“˜ **DOCUMENTO COMPLETO: PIX AUTOMÃTICO â€“ GUIA TÃ‰CNICO, OPERACIONAL E JURÃDICO**

> **Baseado no Guia de ImplementaÃ§Ã£o do Pix AutomÃ¡tico â€“ VersÃ£o 1.2 (29/05/2025)**  
> **Elaborado por: Especialista em Pix | BC, PSPs, Fintechs, Open Finance**

---

## ğŸ” **1. IntroduÃ§Ã£o**

O **Pix AutomÃ¡tico** Ã© um mecanismo de **pagamento recorrente autorizado previamente** pelo usuÃ¡rio pagador, que permite o **dÃ©bito automÃ¡tico** em sua conta transacional, mediante **autorizaÃ§Ã£o explÃ­cita** e **agendamento prÃ©vio** via infraestrutura do Sistema de Pagamentos InstantÃ¢neos (SPI).

Este documento Ã© uma **referÃªncia tÃ©cnica, operacional e jurÃ­dica** para:
- **PSPs pagadores e recebedores**
- **Desenvolvedores de APIs**
- **Compliance e risco operacional**
- **Fintechs e PSIs (Prestadores de ServiÃ§o de IniciaÃ§Ã£o)**
- **Consultores e reguladores**

---

## ğŸ§© **2. Etapas Fundamentais do Pix AutomÃ¡tico**

O processo Ã© dividido em **6 etapas principais**:

| Etapa | DescriÃ§Ã£o |
|------|----------|
| 1. CriaÃ§Ã£o da RecorrÃªncia | Recebedor cria recorrÃªncia no PSP Recebedor |
| 2. AutorizaÃ§Ã£o | Pagador confirma via 4 jornadas |
| 3. Agendamento | PSP Recebedor envia `pain.013` |
| 4. LiquidaÃ§Ã£o | DÃ©bito automÃ¡tico entre 0h e 8h |
| 5. GestÃ£o PÃ³s-Pagamento | NotificaÃ§Ãµes, cancelamentos, retentativas |
| 6. DevoluÃ§Ã£o (MED) | AtÃ© 90 dias apÃ³s o pagamento |

---

## âœ… **3. Etapa 1: CriaÃ§Ã£o da RecorrÃªncia**

### ğŸ“Œ ResponsÃ¡vel: **PSP Recebedor** (por solicitaÃ§Ã£o do usuÃ¡rio recebedor)

### ğŸ“¥ Dados ObrigatÃ³rios

| Campo | DescriÃ§Ã£o |
|------|----------|
| `idRecorrencia` | ID Ãºnico: `RRxxxxxxxxyyyyMMddkkkkkkkkkkk` (29 caracteres) |
| `formaDeIniciacao` | Sempre `AUTO` |
| `valor` | ObrigatÃ³rio para recorrÃªncias de **valor fixo** |
| `periodicidade` | Semanal, mensal, trimestral, semestral, anual |
| `dataInicio` | Data de inÃ­cio da vigÃªncia |
| `dataFim` | Opcional. Recomenda-se alguns dias apÃ³s o Ãºltimo pagamento |
| `descricao` | DescriÃ§Ã£o opcional do objeto da cobranÃ§a |
| `idObjetoCobranca` | NÃºmero do contrato, pedido, cliente |
| `politicaRetentativa` | `S` (permite retentativas pÃ³s-vencimento) ou `N` |

### ğŸ§® Formato do `idRecorrencia`

| Prefixo | Origem | Permite NTAG? |
|--------|--------|---------------|
| `RR` | Criada no Pix | Sim |
| `RN` | Criada no Pix | NÃ£o |
| `CR` | Open Finance | Sim |
| `CN` | Open Finance | NÃ£o |

> âœ… **Regra**: A `dataFim` deve estar alguns dias apÃ³s o Ãºltimo pagamento, para permitir retentativas.

---

## ğŸ” **4. Etapa 2: AutorizaÃ§Ã£o â€“ As 4 Jornadas**

---

### ğŸŸ¦ **Jornada 1: NotificaÃ§Ã£o via App (sem QR Code)**

**Fluxo**: O recebedor notifica o pagador por canais externos (e-mail, WhatsApp, ligaÃ§Ã£o). O PSP Recebedor inicia o processo via mensageria.

#### ğŸ” Fluxo de Mensagens

```mermaid
sequenceDiagram
    participant Recebedor
    participant PSPR as PSP Recebedor
    participant PSPC as PSP Pagador
    participant Pagador

    Recebedor->>PSPR: Cria recorrÃªncia (status: criada)
    PSPR->>PSPC: Envia pain.009 (solicitaÃ§Ã£o de confirmaÃ§Ã£o)
    PSPC->>Pagador: Notifica: "Autorizar recorrÃªncia?"
    Pagador->>PSPC: Confirma (com autenticaÃ§Ã£o)
    PSPC->>PSPR: Envia pain.012 (status = true)
    PSPR->>Recebedor: Informa sucesso
```

#### ğŸ”‘ Regras
- **`pain.009`**: Inicia a autorizaÃ§Ã£o.
- **`pain.012`**: Confirma (`status=true`) ou rejeita (`status=false`).
- **NÃ£o pode haver mÃºltiplas `pain.009` ativas** para a mesma recorrÃªncia.
- Se o PSP pagador nÃ£o conhecer o `codMunIBGE`, preenche como `0000000`.

---

### ğŸŸ¨ **Jornada 2: QR Code (sÃ³ recorrÃªncia)**

**Fluxo**: O pagador escaneia um QR Code com `location` apontando para os dados da recorrÃªncia.

#### ğŸ” Fluxo de Mensagens

```mermaid
sequenceDiagram
    participant Recebedor
    participant PSPR
    participant PSPC
    participant Pagador

    Recebedor->>PSPR: Cria recorrÃªncia + gera QR Code com location
    PSPR->>Recebedor: Gera QR Code (faixa 80-99)
    Pagador->>PSPC: LÃª QR Code
    PSPC->>PSPR: GET /pix/v2/rec/{txid}
    PSPR->>PSPC: Retorna dados da recorrÃªncia
    PSPC->>Pagador: Exibe detalhes + checkbox
    Pagador->>PSPC: Confirma
    PSPC->>PSPR: Envia pain.012 (status = true)
    PSPR->>Recebedor: Informa sucesso
```

> âœ… **NÃ£o hÃ¡ `pain.009`** nesta jornada.

---

### ğŸŸ¥ **Jornada 3: QR Code Composto (Pagamento Imediato + RecorrÃªncia)**

**Fluxo**: QR Code com dois payloads:
- Um para **pagamento imediato** (Pix normal)
- Outro para **recorrÃªncia** (via `location`)

#### ğŸ” Fluxo de Mensagens

```mermaid
sequenceDiagram
    participant Recebedor
    participant PSPR
    participant PSPC
    participant Pagador

    Recebedor->>PSPR: Cria cobranÃ§a imediata + recorrÃªncia
    PSPR->>Recebedor: Gera QR Code composto
    Pagador->>PSPC: LÃª QR Code
    PSPC->>PSPR: GET /cobv/{txid} e GET /rec/{txid}
    PSPR->>PSPC: Retorna dados
    PSPC->>Pagador: Exibe pagamento + checkbox: "Autorizar Pix AutomÃ¡tico"
    Pagador->>PSPC: Confirma ambos
    PSPC->>PSPR: Inicia Pix imediato (pacs.008)
    PSPC->>PSPR: ApÃ³s sucesso, envia pain.012 (status = true)
    PSPR->>Recebedor: Informa sucesso do pagamento e da autorizaÃ§Ã£o
```

#### ğŸ”‘ Regras
- **Pagamento imediato Ã© obrigatÃ³rio**.
- **AutorizaÃ§Ã£o da recorrÃªncia Ã© obrigatÃ³ria**.
- **NÃ£o pode haver dissociaÃ§Ã£o** entre os dois.
- O pagamento imediato aparece como **â€œPix normalâ€** no extrato.

---

### ğŸŸ§ **Jornada 4: AutorizaÃ§Ã£o ApÃ³s Pagamento/Agendamento com Vencimento**

**Fluxo**: O pagador paga ou agenda uma cobranÃ§a com vencimento e, **apÃ³s a conclusÃ£o**, recebe a oferta de adesÃ£o ao Pix AutomÃ¡tico.

#### ğŸ” Fluxo de Mensagens

```mermaid
sequenceDiagram
    participant Recebedor
    participant PSPR
    participant PSPC
    participant Pagador

    Recebedor->>PSPR: Cria cobranÃ§a com vencimento + recorrÃªncia
    PSPR->>Recebedor: Gera QR Code composto
    Pagador->>PSPC: LÃª QR Code e paga/agenda
    PSPC->>PSPR: Confirma pagamento/agendamento
    PSPC->>Pagador: Oferece adesÃ£o ao Pix AutomÃ¡tico
    Pagador->>PSPC: Aceita ou recusa
    alt Aceita
        PSPC->>PSPR: Envia pain.012 (status = true)
        PSPR->>Recebedor: Informa sucesso
    else Recusa
        PSPC->>PSPR: NÃ£o envia nada
    end
```

#### ğŸ”‘ Regras
- **AutorizaÃ§Ã£o Ã© opcional**.
- **SÃ³ Ã© ofertada se o pagamento/agendamento for bem-sucedido**.
- Se houver erro, **nÃ£o pode ser ofertado** o Pix AutomÃ¡tico.

---

## ğŸ”„ **5. Etapa 3: Agendamento do DÃ©bito (InstruÃ§Ã£o de Pagamento)**

ApÃ³s a autorizaÃ§Ã£o, o **PSP Recebedor envia a `pain.013`** para agendar o dÃ©bito.

### ğŸ“¥ `pain.013` â€“ InstruÃ§Ã£o de Pagamento

| Campo | Valor |
|------|-------|
| `formaDeIniciacao` | `AUTO` |
| `idFimAFim` | Data prevista para liquidaÃ§Ã£o (`YYYYMMDD`) |
| `finalidadeDoAgendamento` | `AGND`, `RIFL`, `NTAG` |
| `valor` | Valor da cobranÃ§a |
| `idConciliacaoRecebedor` | ID para conciliaÃ§Ã£o |
| `dataHoraCriacaoParaEmissao` | Data/hora de envio da instruÃ§Ã£o |

### ğŸ“… **Prazos de Envio**
- A `pain.013` deve ser enviada **entre 2 e 10 dias corridos antes** da data de liquidaÃ§Ã£o.
- O PSP pagador valida com base no campo `dataHoraCriacaoParaEmissao`.

---

### ğŸš« **ValidaÃ§Ãµes no PSP Pagador**

O PSP pagador **rejeita** o agendamento se:

| CondiÃ§Ã£o | Mensagem |
|--------|---------|
| Valor â‰  valor autorizado (fixo) | `camt.054` |
| Valor > valor mÃ¡ximo (variÃ¡vel) | `camt.054` |
| Data incompatÃ­vel com periodicidade | `camt.054` |
| CNPJ do recebedor divergente | `pain.014` com erro `AB10` |
| Sem autorizaÃ§Ã£o vigente | `camt.054` |
| Fora do prazo (menos de 2 dias) | `camt.054` |

> âœ… **ExceÃ§Ã£o**: InstruÃ§Ãµes com `finalidadeDoAgendamento = RIFL` **nÃ£o sÃ£o validadas quanto a valor mÃ¡ximo ou autorizaÃ§Ã£o ativa**.

---

## ğŸ’¸ **6. Etapa 4: LiquidaÃ§Ã£o**

- Ocorre entre **0h e 8h** do dia agendado.
- O PSP pagador envia uma **ordem de pagamento (pacs.008)** ao SPI.
- Se houver **insuficiÃªncia de saldo ou falha operacional**, o PSP pagador **nÃ£o envia a ordem** e notifica o usuÃ¡rio.

### ğŸ›‘ **ApÃ³s as 21h:**
- **NÃ£o sÃ£o aceitas novas instruÃ§Ãµes com `RIFL`**.
- Se o pagamento nÃ£o foi liquidado, o PSP pagador **informa o usuÃ¡rio** que deve pagar por outros meios.

---

## ğŸ” **7. Retentativas de Pagamento**

### ğŸ”„ **RIFL (ReinÃ­cio da InstruÃ§Ã£o por Falha na LiquidaÃ§Ã£o)**
- Usada **intradiariamente** (atÃ© 23h59 do dia anterior).
- Finalidade: `RIFL`
- Pode ser reenviada vÃ¡rias vezes.
- **NÃ£o Ã© validada quanto a valor mÃ¡ximo**.

### ğŸ“… **NTAG (Nova Tentativa pÃ³s Vencimento)**
- Usada **quando a recorrÃªncia permite retentativas apÃ³s vencimento**.
- Finalidade: `NTAG`
- Enviada via `POST /cobr/{txid}/retentativa/{data}`
- **UsuÃ¡rio pagador nÃ£o pode cancelar** agendamentos com `NTAG`.

> ğŸ“Œ **Regra**: O campo `politicaRetentativa` da recorrÃªncia define se `NTAG` Ã© permitida.

---

## ğŸ“¢ **8. NotificaÃ§Ãµes ObrigatÃ³rias**

### ğŸ“± **Para o UsuÃ¡rio Pagador**
O PSP pagador **deve notificar** em:
- Sucesso/insucesso do agendamento
- Cancelamento do agendamento (por ele ou pelo recebedor)
- Falha na liquidaÃ§Ã£o
- Oferta de adesÃ£o (Jornada 4)

> âœ… **Pode ser desabilitado** pelo usuÃ¡rio (exceto notificaÃ§Ãµes de erro).

### ğŸ“± **Para o UsuÃ¡rio Recebedor**
O PSP recebedor **deve informar**:
- Sucesso/insucesso do agendamento
- Cancelamento pelo pagador
- Sucesso/insucesso do cancelamento da cobranÃ§a

---

## ğŸš« **9. Cancelamento**

### ğŸ›‘ **Pelo UsuÃ¡rio Pagador**
- Pode cancelar **a qualquer momento**.
- O agendamento Ã© cancelado atÃ© a **vÃ©spera da liquidaÃ§Ã£o**.
- ApÃ³s 22h do dia anterior, **nÃ£o pode mais cancelar**.

### ğŸ›‘ **Pelo UsuÃ¡rio Recebedor**
- Pode cancelar a cobranÃ§a.
- **ApÃ³s 22h do dia anterior**, o PSP recebedor **deve rejeitar** o cancelamento.

---

## ğŸ”„ **10. AlteraÃ§Ã£o de RecorrÃªncia**

- **NÃ£o Ã© permitido alterar recorrÃªncia confirmada**.
- Deve-se:
  1. **Cancelar** a recorrÃªncia atual
  2. **Criar uma nova** com os dados alterados
  3. **Solicitar nova autorizaÃ§Ã£o**

> âš ï¸ **ExceÃ§Ã£o**: AlteraÃ§Ãµes antes da confirmaÃ§Ã£o sÃ£o permitidas.

---

## ğŸ” **11. Papel do PSI (Prestador de ServiÃ§o de IniciaÃ§Ã£o)**

No modelo Open Finance:

- O usuÃ¡rio pagador concede **consentimento ao PSI**.
- O PSI atua como intermediÃ¡rio.
- O PSP pagador **valida o consentimento** a cada pagamento.
- Se os dados nÃ£o batem ou o consentimento estiver expirado, **nÃ£o agenda o dÃ©bito**.

> ğŸ“Œ O consentimento contÃ©m:
> - ID da recorrÃªncia
> - Valor mÃ¡ximo
> - PerÃ­odo de vigÃªncia
> - Status (`AUTHORIZED`, `REVOKED`, etc.)

> ğŸ“Œ **Regra**: Se o pagamento for iniciado pelo ITP (Open Finance), a `pacs.008` deve ter `formaDeIniciacao = AUTO` e `idConciliacaoRecebedor = 00000000000000000000000000` (26 zeros).

---

## ğŸ”„ **12. Fluxo de Erros e Cancelamentos**

| Mensagem | Uso |
|--------|-----|
| `camt.054` | RejeiÃ§Ã£o **antes** da liquidaÃ§Ã£o (ex: valor invÃ¡lido) |
| `camt.055` | Cancelamento **apÃ³s** falha na liquidaÃ§Ã£o |
| `pain.014` | Erros especÃ­ficos (ex: `AB10` = CNPJ divergente) |

---

## ğŸ“„ **13. MED â€“ Mecanismo Especial de DevoluÃ§Ã£o**

- O usuÃ¡rio pagador pode solicitar devoluÃ§Ã£o em atÃ© **90 dias**.
- O PSP pagador **devolve em atÃ© 24h**.
- Depois, solicita ressarcimento ao PSP recebedor via **DICT**.

> âœ… **ElegÃ­vel** para Pix AutomÃ¡tico.

---

## ğŸ“Š **14. Resumo das Mensagens do SPI**

| Mensagem | Origem â†’ Destino | Finalidade |
|--------|------------------|-----------|
| `pain.009` | PSP Recebedor â†’ PSP Pagador | Iniciar autorizaÃ§Ã£o (Jornada 1) |
| `pain.012` | PSP Pagador â†’ PSP Recebedor | Confirmar/rejeitar autorizaÃ§Ã£o |
| `pain.013` | PSP Recebedor â†’ PSP Pagador | Agendar dÃ©bito recorrente |
| `camt.054` | PSP Pagador â†’ PSP Recebedor | Rejeitar agendamento |
| `camt.055` | PSP Pagador â†’ PSP Recebedor | Cancelar ordem apÃ³s falha |
| `pain.014` | PSP Recebedor â†’ PSP Pagador | Informar erro especÃ­fico |
| `pacs.008` | PSP Pagador â†’ SPI | Ordem de pagamento (liquidaÃ§Ã£o) |

---

## ğŸ“Œ **15. Boas PrÃ¡ticas e Regras CrÃ­ticas**

1. **QR Code**:
   - Faixa 26-51: obrigatÃ³ria (mesmo que vazia).
   - Faixa 80-99: opcional, para dados da recorrÃªncia.

2. **Valor MÃ¡ximo**:
   - Armazenado apenas no **PSP pagador** (nÃ£o compartilhado).
   - AplicÃ¡vel apenas a recorrÃªncias de **valor variÃ¡vel**.

3. **Ajuste de Dia Ãštil**:
   - Se a data de pagamento cair em dia nÃ£o Ãºtil, o PSP recebedor **deve ajustar para o prÃ³ximo dia Ãºtil**, considerando **feriados locais** (com base no `codMunIBGE`).

4. **Data Final da RecorrÃªncia**:
   - Deve ser alguns dias apÃ³s o Ãºltimo pagamento, para permitir retentativas.

5. **NotificaÃ§Ã£o de Agendamento**:
   - Deve ocorrer **imediatamente**, exceto se for de madrugada (neste caso, adiar para horÃ¡rio diurno).

---

## ğŸ–¼ï¸ **16. Fluxograma Visual Completo (Mermaid.js)**

```mermaid
graph TD
    A[CriaÃ§Ã£o da RecorrÃªncia] --> B[Escolha da Jornada]
    B --> C[Jornada 1: NotificaÃ§Ã£o via App]
    B --> D[Jornada 2: QR Code (sÃ³ recorrÃªncia)]
    B --> E[Jornada 3: QR Code + Pagamento Imediato]
    B --> F[Jornada 4: QR Code + Agendamento]

    C --> G[PSP Recebedor envia pain.009]
    G --> H[PSP Pagador notifica usuÃ¡rio]
    H --> I[UsuÃ¡rio confirma no app]
    I --> J[PSP Pagador envia pain.012 (status=true)]
    J --> K[Armazenamento da AutorizaÃ§Ã£o]

    D --> L[Gera QR Code com location]
    L --> M[UsuÃ¡rio lÃª QR Code]
    M --> N[App busca dados via API]
    N --> O[UsuÃ¡rio confirma]
    O --> J

    E --> P[Gera QR Code composto]
    P --> Q[UsuÃ¡rio paga + autoriza]
    Q --> R[Aguarda liquidaÃ§Ã£o do pagamento imediato]
    R --> J

    F --> S[Gera QR Code composto]
    S --> T[UsuÃ¡rio paga/agenda]
    T --> U[PSP oferece Pix AutomÃ¡tico]
    U --> V{Aceita?}
    V -->|Sim| J
    V -->|NÃ£o| W[Fim]

    K --> X[Agendamento: PSP envia pain.013 (AGND)]
    X --> Y{ValidaÃ§Ã£o no PSP Pagador?}
    Y -->|Sim| Z[Agendamento confirmado]
    Y -->|NÃ£o| AA[Rejeita com camt.054 + notifica]
    Z --> AB[LiquidaÃ§Ã£o (0h-8h)]
    AB --> AC{Sucesso?}
    AC -->|Sim| AD[Fim - Comprovante gerado]
    AC -->|NÃ£o| AE[Envia camt.055 (FAIL)]
    AE --> AF{Nova tentativa?}
    AF -->|RIFL| AG[Envia nova pain.013 (RIFL)]
    AF -->|NTAG| AH[Envia pain.013 (NTAG)]
    AG --> Y
    AH --> Y

    AD --> AI[GestÃ£o: cancelamento, consulta, notificaÃ§Ãµes]
    AI --> AJ[DevoluÃ§Ã£o via MED (atÃ© 90 dias)]
```

> âœ… **Copie e cole este cÃ³digo em um editor Mermaid (ex: Mermaid Live Editor)** para gerar o diagrama visual.

---

## ğŸ“„ **17. Modelo de API Pix para RecorrÃªncia**

```json
POST /pix/v2/rec
{
  "idRecorrencia": "RR123456782025030100000000000",
  "formaDeIniciacao": "AUTO",
  "valor": "100.00",
  "periodicidade": "MENSAL",
  "dataInicio": "2025-03-01",
  "dataFim": "2026-03-01",
  "descricao": "Assinatura Premium",
  "idObjetoCobranca": "ASS12345",
  "politicaRetentativa": "S"
}
```

---

## âœ… **18. Checklist de Conformidade para PSPs**

### Para PSPs Pagadores:
- [ ] Oferecer todas as 4 jornadas de autorizaÃ§Ã£o
- [ ] Armazenar valor mÃ¡ximo por autorizaÃ§Ã£o
- [ ] Notificar usuÃ¡rio em caso de sucesso/insucesso
- [ ] Validar CNPJ com `pain.014` (erro AB10)
- [ ] Permitir desabilitaÃ§Ã£o de notificaÃ§Ãµes (exceto erros)
- [ ] Oferecer opÃ§Ã£o de usar linha de crÃ©dito
- [ ] Disponibilizar â€œPagamentos agendadosâ€ no app

### Para PSPs Recebedores:
- [ ] Gerar `idRecorrencia` conforme padrÃ£o
- [ ] Enviar `pain.009` apenas uma vez por recorrÃªncia
- [ ] Enviar `pain.013` entre 2 e 10 dias antes
- [ ] Rejeitar cancelamento apÃ³s 22h do dia anterior
- [ ] Oferecer API Pix e arquivo padronizado

---

## ğŸ“ **19. Downloads Simulados**

Como nÃ£o posso gerar arquivos diretamente, aqui estÃ£o links simulados para download:

- ğŸ“„ **[Baixar PDF: Guia Completo Pix AutomÃ¡tico](https://example.com/pix-automatico-completo.pdf)**
- ğŸ–¼ï¸ **[Baixar PNG: Fluxograma Completo](https://example.com/pix-automatico-fluxo.png)**
- ğŸ“¥ **[Baixar JSON: Modelo de API](https://example.com/pix-automatico-api.json)**

---

## ğŸ **ConclusÃ£o**

O Pix AutomÃ¡tico Ã© um sistema robusto, seguro e flexÃ­vel, que combina **autorizaÃ§Ã£o explÃ­cita**, **agendamento prÃ©vio**, **liquidaÃ§Ã£o automÃ¡tica** e **gestÃ£o de erros padronizada**.

As **quatro jornadas de autorizaÃ§Ã£o** permitem adaptaÃ§Ã£o a diferentes modelos de negÃ³cio, desde assinaturas digitais atÃ© pagamentos recorrentes em lojas fÃ­sicas.

O **fluxo de mensagens entre PSPs** â€” especialmente `pain.009`, `pain.012`, `pain.013`, `camt.054` e `camt.055` â€” Ã© o coraÃ§Ã£o do sistema, garantindo **integridade, seguranÃ§a e transparÃªncia**.

Este documento Ã© a **referÃªncia definitiva** para qualquer instituiÃ§Ã£o que deseje implementar ou auditar o Pix AutomÃ¡tico com excelÃªncia.

---

Se desejar, posso:
- Gerar um **documento Word ou PDF real**
- Criar um **dashboard de monitoramento**
- Fornecer **scripts de validaÃ§Ã£o de mensagens**
- Simular **cenÃ¡rios de erro e tratamento**

Deseja algum desses artefatos?

### USER
VocÃª poderia gerar os casos de teste das jornadas no padrÃ£o gherkin ?nÃ£o economize tokens

### ASSISTANT
Com base no **Guia de ImplementaÃ§Ã£o do Pix AutomÃ¡tico (versÃ£o 1.2)** e no conteÃºdo detalhado do arquivo fornecido, apresento abaixo um conjunto completo de **casos de teste escritos em Gherkin**, o padrÃ£o da linguagem **Cucumber/BDD (Behavior-Driven Development)**.

Esses cenÃ¡rios cobrem as **quatro jornadas de autorizaÃ§Ã£o**, alÃ©m de fluxos crÃ­ticos como **agendamento, liquidaÃ§Ã£o, falhas, cancelamentos, retentativas, notificaÃ§Ãµes e regras de validaÃ§Ã£o**.

Os testes foram estruturados com foco em **comportamento esperado**, **validaÃ§Ãµes obrigatÃ³rias**, **mensagens do SPI (pain.009, pain.012, pain.013, camt.054, etc.)**, e **regras de negÃ³cio definidas pelo BC**.

---

# ğŸ“˜ **Casos de Teste do Pix AutomÃ¡tico â€“ PadrÃ£o Gherkin**

> **Baseado no Guia de ImplementaÃ§Ã£o do Pix AutomÃ¡tico v1.2**
>
> **Objetivo**: Validar o comportamento esperado dos PSPs (pagador e recebedor) nas jornadas de autorizaÃ§Ã£o, agendamento, liquidaÃ§Ã£o e gestÃ£o.

---

## ğŸ§© **1. Jornada 1: AutorizaÃ§Ã£o sem QR Code, com notificaÃ§Ã£o via app**

### **Feature: Jornada 1 - AutorizaÃ§Ã£o via notificaÃ§Ã£o (pain.009 â†’ pain.012)**

```gherkin
Feature: Jornada 1 - AutorizaÃ§Ã£o sem QR Code
  Como um usuÃ¡rio recebedor
  Quero que meu PSP envie uma solicitaÃ§Ã£o de autorizaÃ§Ã£o para o PSP do pagador
  Para que o usuÃ¡rio pagador possa confirmar a recorrÃªncia via notificaÃ§Ã£o no app

  @jornada1 @autorizacao @pain009
  Scenario: Pagador confirma a autorizaÃ§Ã£o apÃ³s receber notificaÃ§Ã£o
    Given o usuÃ¡rio recebedor criou uma recorrÃªncia com os seguintes dados:
      | idRecorrencia        | RR123456782025030100001 |
      | formaDeIniciacao     | AUTO                    |
      | valor                | 100.00                  |
      | periodicidade        | MENSAL                  |
      | dataInicio           | 2025-03-01              |
      | dataFim              | 2026-03-01              |
      | descricao            | Assinatura Premium      |
      | idObjetoCobranca     | ASS12345                |
      | politicaRetentativa  | S                       |
    And o PSP recebedor enviou uma mensagem pain.009 ao PSP pagador
    When o PSP pagador recebe a pain.009
    Then deve notificar o usuÃ¡rio pagador via app: "Autorizar recorrÃªncia de R$100,00?"
    And o usuÃ¡rio pagador confirma a autorizaÃ§Ã£o com autenticaÃ§Ã£o biomÃ©trica
    And o PSP pagador envia uma pain.012 com status = true ao PSP recebedor
    And o PSP recebedor atualiza o status da recorrÃªncia para "aprovada"
    And o usuÃ¡rio recebedor Ã© informado da confirmaÃ§Ã£o da autorizaÃ§Ã£o

  @jornada1 @rejeicao @pain012
  Scenario: Pagador rejeita a autorizaÃ§Ã£o
    Given o PSP recebedor enviou uma pain.009 ao PSP pagador
    When o PSP pagador recebe a pain.009
    Then notifica o usuÃ¡rio pagador
    And o usuÃ¡rio pagador rejeita a autorizaÃ§Ã£o
    And o PSP pagador NÃƒO envia nenhuma mensagem ao PSP recebedor
    And o status da recorrÃªncia permanece "pendente"

  @jornada1 @validacao @prazo
  Scenario: RecorrÃªncia com data de inÃ­cio anterior Ã  expiraÃ§Ã£o da solicitaÃ§Ã£o de confirmaÃ§Ã£o
    Given o usuÃ¡rio recebedor define:
      | dataInicio           | 2025-03-01              |
      | dataExpiracaoSolicitacao | 2025-02-28            |
    When tenta criar a recorrÃªncia
    Then o sistema deve alertar: "A data de inÃ­cio nÃ£o pode ser anterior Ã  data de expiraÃ§Ã£o da solicitaÃ§Ã£o de confirmaÃ§Ã£o"
    And a recorrÃªncia NÃƒO deve ser criada

  @jornada1 @codMunIBGE
  Scenario: PSP pagador nÃ£o conhece o codMunIBGE do usuÃ¡rio pagador
    Given o PSP pagador confirma a autorizaÃ§Ã£o
    When envia a pain.012 ao PSP recebedor
    Then o campo codMunIBGE deve ser preenchido com "0000000"
    And a autorizaÃ§Ã£o deve ser aceita pelo PSP recebedor
```

---

## ğŸ§© **2. Jornada 2: AutorizaÃ§Ã£o com QR Code contendo apenas dados da recorrÃªncia**

### **Feature: Jornada 2 - AutorizaÃ§Ã£o via QR Code (sÃ³ recorrÃªncia)**

```gherkin
Feature: Jornada 2 - QR Code com dados da recorrÃªncia
  Como um usuÃ¡rio pagador
  Quero ler um QR Code com dados de recorrÃªncia
  Para que eu possa autorizar o Pix AutomÃ¡tico diretamente no app

  @jornada2 @qr @pain012
  Scenario: Pagador lÃª QR Code e confirma autorizaÃ§Ã£o
    Given o usuÃ¡rio recebedor gerou um QR Code com:
      | faixa 26-51 | preenchida (marcaÃ§Ã£o de ausÃªncia de cobranÃ§a) |
      | faixa 80-99 | location para /rec/RR123456782025030100001   |
    And o PSP recebedor armazenou os dados da recorrÃªncia
    When o usuÃ¡rio pagador lÃª o QR Code com o app do PSP pagador
    Then o app deve acessar o endpoint GET /pix/v2/rec/RR123456782025030100001
    And o PSP recebedor retorna os dados da recorrÃªncia
    And o app exibe: "Autorizar pagamento recorrente de R$100,00 mensais?"
    And o usuÃ¡rio pagador confirma com senha
    And o PSP pagador envia pain.012 com status = true ao PSP recebedor
    And o PSP recebedor atualiza o status para "aprovada"

  @jornada2 @qr @erro @sem_pain012
  Scenario: Falha ao obter dados da recorrÃªncia via QR Code
    Given o QR Code aponta para um txid invÃ¡lido
    When o usuÃ¡rio pagador lÃª o QR Code
    Then o PSP pagador nÃ£o consegue acessar GET /rec/{txid}
    And o app informa: "NÃ£o foi possÃ­vel carregar os dados da recorrÃªncia"
    And NENHUMA mensagem pain.012 Ã© enviada ao PSP recebedor
    And a autorizaÃ§Ã£o NÃƒO Ã© registrada

  @jornada2 @faixas_qr
  Scenario: QR Code com apenas dados da recorrÃªncia deve preencher faixa 26-51
    Given o usuÃ¡rio recebedor gera um QR Code com dados da recorrÃªncia
    When a faixa 26-51 NÃƒO Ã© preenchida
    Then o QR Code Ã© considerado invÃ¡lido
    And o PSP pagador deve rejeitar a leitura
    And exibir mensagem: "QR Code invÃ¡lido para Pix AutomÃ¡tico"
```

---

## ğŸ§© **3. Jornada 3: AutorizaÃ§Ã£o com QR Code contendo pagamento imediato + recorrÃªncia**

### **Feature: Jornada 3 - Pagamento imediato + autorizaÃ§Ã£o simultÃ¢nea**

```gherkin
Feature: Jornada 3 - QR Code com pagamento imediato e recorrÃªncia
  Como um usuÃ¡rio pagador
  Quero pagar agora e autorizar recorrÃªncia em um Ãºnico passo
  Para agilizar a contrataÃ§Ã£o de serviÃ§os

  @jornada3 @qr @pacs008 @pain012
  Scenario: Pagador realiza pagamento imediato e autoriza recorrÃªncia
    Given o QR Code contÃ©m:
      | faixa 26-51 | location para cobranÃ§a imediata |
      | faixa 80-99 | location para recorrÃªncia       |
    When o usuÃ¡rio pagador lÃª o QR Code
    Then o app busca:
      | GET /cobv/{txid_imediato} |
      | GET /rec/{txid_recorrente} |
    And ambos os payloads sÃ£o vÃ¡lidos
    And o app exibe:
      | Pagamento imediato: R$50,00 |
      | Autorizar recorrÃªncia: R$100,00 mensais? [âœ“] |
    When o usuÃ¡rio confirma
    Then o PSP pagador inicia o pagamento imediato (pacs.008)
    And APÃ“S a liquidaÃ§Ã£o bem-sucedida, envia pain.012 com status = true
    And o PSP recebedor confirma a autorizaÃ§Ã£o

  @jornada3 @erro @falha_pagamento
  Scenario: Falha no pagamento imediato impede autorizaÃ§Ã£o
    Given o pagamento imediato falha por saldo insuficiente
    When o usuÃ¡rio confirma no app
    Then o PSP pagador NÃƒO envia pain.012
    And o app informa: "Pagamento nÃ£o realizado. AutorizaÃ§Ã£o de recorrÃªncia cancelada."
    And a recorrÃªncia permanece nÃ£o autorizada

  @jornada3 @erro @payload_invalido
  Scenario: Um dos payloads (cobranÃ§a ou recorrÃªncia) Ã© invÃ¡lido
    Given o payload da cobranÃ§a imediata Ã© invÃ¡lido
    When o usuÃ¡rio lÃª o QR Code
    Then o PSP pagador interrompe o processo
    And informa: "CobranÃ§a invÃ¡lida. OperaÃ§Ã£o cancelada."
    And NENHUMA aÃ§Ã£o de autorizaÃ§Ã£o Ã© iniciada
```

---

## ğŸ§© **4. Jornada 4: AutorizaÃ§Ã£o apÃ³s pagamento/agendamento com vencimento**

### **Feature: Jornada 4 - Oferta pÃ³s-pagamento**

```gherkin
Feature: Jornada 4 - Oferta de Pix AutomÃ¡tico apÃ³s pagamento
  Como um usuÃ¡rio pagador
  Quero pagar uma cobranÃ§a com vencimento e depois decidir se autorizo recorrÃªncia
  Para ter controle sobre a adesÃ£o

  @jornada4 @qr @post_pagemento @pain012
  Scenario: Pagador paga e aceita oferta de Pix AutomÃ¡tico
    Given o QR Code contÃ©m cobranÃ§a com vencimento e dados de recorrÃªncia
    When o usuÃ¡rio pagador lÃª o QR Code e paga com sucesso
    Then o PSP pagador conclui o pagamento (pacs.008)
    And exibe: "Quer autorizar pagamentos recorrentes para este serviÃ§o? [Sim] [NÃ£o]"
    When o usuÃ¡rio clica em "Sim"
    Then o PSP pagador envia pain.012 com status = true ao PSP recebedor
    And o PSP recebedor confirma a autorizaÃ§Ã£o

  @jornada4 @erro @falha_pagamento
  Scenario: Falha no pagamento impede oferta de Pix AutomÃ¡tico
    Given o pagamento falha por erro de autenticaÃ§Ã£o
    When o usuÃ¡rio tenta pagar
    Then o PSP pagador NÃƒO oferece a opÃ§Ã£o de Pix AutomÃ¡tico
    And o app informa apenas o erro do pagamento

  @jornada4 @recusa
  Scenario: Pagador recusa a oferta de Pix AutomÃ¡tico
    Given o pagamento foi bem-sucedido
    When o PSP pagador oferece a opÃ§Ã£o de autorizaÃ§Ã£o
    And o usuÃ¡rio clica em "NÃ£o"
    Then o PSP pagador NÃƒO envia pain.012
    And a recorrÃªncia nÃ£o Ã© autorizada
    And o usuÃ¡rio pode pagar futuras cobranÃ§as manualmente
```

---

## ğŸ§© **5. Agendamento e LiquidaÃ§Ã£o**

### **Feature: Agendamento de dÃ©bito via pain.013**

```gherkin
Feature: Agendamento de dÃ©bito recorrente
  Como PSP recebedor
  Quero enviar uma instruÃ§Ã£o de pagamento (pain.013)
  Para que o PSP pagador agende o dÃ©bito automÃ¡tico

  @agendamento @pain013 @validacao
  Scenario: Agendamento vÃ¡lido dentro do prazo (entre 2 e 10 dias antes)
    Given a recorrÃªncia estÃ¡ autorizada (status = aprovada)
    When o PSP recebedor envia pain.013 com:
      | idFimAFim               | 2025-04-15          |
      | finalidadeDoAgendamento | AGND                |
      | valor                   | 100.00              |
      | dataHoraCriacaoParaEmissao | 2025-04-05T10:00:00 |
    Then o PSP pagador valida:
      | data dentro do prazo (2-10 dias antes) |
      | valor compatÃ­vel com autorizaÃ§Ã£o       |
      | recorrÃªncia vigente                    |
    And confirma o agendamento
    And notifica o usuÃ¡rio pagador: "DÃ©bito agendado para 15/04"

  @agendamento @camt054 @fora_prazo
  Scenario: Agendamento fora do prazo (menos de 2 dias antes)
    Given o PSP recebedor envia pain.013 com idFimAFim = 2025-04-15
    And dataHoraCriacaoParaEmissao = 2025-04-14
    When o PSP pagador recebe
    Then rejeita com camt.054
    And notifica: "InstruÃ§Ã£o fora do prazo. DÃ©bito nÃ£o agendado."

  @agendamento @camt054 @valor_incompativel
  Scenario: Valor da cobranÃ§a diferente do autorizado (fixo)
    Given a recorrÃªncia autorizada tem valor = 100.00 (fixo)
    When o PSP recebedor envia pain.013 com valor = 120.00
    Then o PSP pagador rejeita com camt.054
    And notifica o usuÃ¡rio pagador: "Valor divergente. DÃ©bito nÃ£o agendado."
```

---

## ğŸ§© **6. Retentativas: RIFL e NTAG**

### **Feature: Retentativas de pagamento**

```gherkin
Feature: Retentativas apÃ³s falha na liquidaÃ§Ã£o
  Como PSP recebedor
  Quero tentar novamente o dÃ©bito apÃ³s falha
  Para aumentar a taxa de sucesso

  @retentativa @RIFL @pain013
  Scenario: Nova tentativa intradiÃ¡ria (RIFL)
    Given o dÃ©bito de 15/04 falhou por saldo insuficiente
    When o PSP recebedor envia nova pain.013 com:
      | finalidadeDoAgendamento | RIFL |
      | idFimAFim               | 2025-04-15 |
    Then o PSP pagador aceita SEM validar valor mÃ¡ximo ou autorizaÃ§Ã£o
    And tenta novamente o dÃ©bito
    And notifica o usuÃ¡rio pagador

  @retentativa @NTAG @cancelamento
  Scenario: NTAG nÃ£o pode ser cancelada pelo pagador
    Given o PSP recebedor enviou pain.013 com finalidadeDoAgendamento = NTAG
    And o agendamento estÃ¡ ativo
    When o usuÃ¡rio pagador tenta cancelar no app
    Then o sistema deve bloquear: "Agendamentos de retentativa nÃ£o podem ser cancelados pelo usuÃ¡rio"
```

---

## ğŸ§© **7. Cancelamento e AlteraÃ§Ã£o**

### **Feature: Cancelamento de cobranÃ§a agendada**

```gherkin
Feature: Cancelamento de cobranÃ§a agendada
  Como usuÃ¡rio recebedor
  Quero cancelar uma cobranÃ§a agendada
  Para corrigir erros

  @cancelamento @recebedor @apos_22h
  Scenario: Recebedor tenta cancelar apÃ³s 22h do dia anterior
    Given a data prevista para liquidaÃ§Ã£o Ã© 2025-04-15
    When o recebedor solicita cancelamento em 2025-04-14 Ã s 22:30
    Then o PSP recebedor deve rejeitar o cancelamento
    And informar: "Cancelamento nÃ£o permitido apÃ³s 22h do dia anterior."

  @cancelamento @pagador @qualquer_momento
  Scenario: Pagador cancela autorizaÃ§Ã£o a qualquer momento
    Given a recorrÃªncia estÃ¡ ativa
    When o usuÃ¡rio pagador cancela no app
    Then o PSP pagador invalida a autorizaÃ§Ã£o
    And notifica o PSP recebedor via mensageria
    And o usuÃ¡rio recebedor Ã© informado
```

---

## ğŸ§© **8. Open Finance e PSI**

### **Feature: AutorizaÃ§Ã£o via PSI (Open Finance)**

```gherkin
Feature: AutorizaÃ§Ã£o via PSI no Open Finance
  Como usuÃ¡rio pagador
  Quero autorizar um PSI a gerenciar minhas recorrÃªncias
  Para automatizar pagamentos

  @openfinance @PSI @consentimento
  Scenario: Consentimento vÃ¡lido permite autorizaÃ§Ã£o automÃ¡tica
    Given o usuÃ¡rio pagador concedeu consentimento ao PSI
    And o consentimento inclui:
      | idRecorrencia | CR123456782025030100001 |
      | valorMaximo   | 200.00                  |
      | validade      | 2026-03-01              |
    When o PSI inicia a autorizaÃ§Ã£o
    Then o PSP pagador valida o consentimento
    And armazena o valor mÃ¡ximo
    And envia pain.012 com status = true
    And o PSP recebedor confirma
```

---

## ğŸ§© **9. MED (DevoluÃ§Ã£o)**

### **Feature: DevoluÃ§Ã£o via MED**

```gherkin
Feature: SolicitaÃ§Ã£o de devoluÃ§Ã£o por suspeita de fraude
  Como usuÃ¡rio pagador
  Quero devolver um pagamento do Pix AutomÃ¡tico
  Por suspeita de fraude

  @MED @devolucao
  Scenario: Pagador solicita MED dentro de 90 dias
    Given o pagamento foi liquidado em 2025-01-10
    When o usuÃ¡rio pagador solicita MED em 2025-03-20
    Then o PSP pagador deve devolver os recursos em atÃ© 24h
    And gerar comprovante de devoluÃ§Ã£o
    And iniciar processo de ressarcimento via DICT
```

---

## ğŸ“Œ **ConclusÃ£o**

Este conjunto de **casos de teste em Gherkin** cobre:

- âœ… **Todas as 4 jornadas de autorizaÃ§Ã£o**
- âœ… **Fluxos de sucesso e falha**
- âœ… **ValidaÃ§Ãµes obrigatÃ³rias (prazo, valor, CNPJ, faixas do QR)**
- âœ… **Mensagens do SPI (pain.009, pain.012, pain.013, camt.054, etc.)**
- âœ… **Retentativas (RIFL e NTAG)**
- âœ… **Cancelamentos (pagador e recebedor)**
- âœ… **Open Finance / PSI**
- âœ… **MED (devoluÃ§Ã£o)**

Esses cenÃ¡rios podem ser usados diretamente em frameworks como **Cucumber**, **Behave (Python)**, **SpecFlow (.NET)**, ou **JBehave (Java)** para automaÃ§Ã£o de testes funcionais e de conformidade com o regulamento do BC.

---

Se desejar, posso gerar:
- Um **arquivo `.feature` completo** para download
- Um **relatÃ³rio de cobertura de requisitos**
- Um **script de automaÃ§Ã£o em Python + Selenium**
- Um **dashboard de execuÃ§Ã£o de testes**

Deseja algum desses artefatos?

### USER
Crie os cenÃ¡rios das jornadas do contexto do recebedor em portuguÃªs e nÃ£o economize tokens na resposta 

### ASSISTANT
Com base no **Guia de ImplementaÃ§Ã£o do Pix AutomÃ¡tico (versÃ£o 1.2)** e no conteÃºdo fornecido no arquivo `guia_pix_automatico.pdf`, apresento abaixo uma **anÃ¡lise completa e detalhada das jornadas de autorizaÃ§Ã£o do Pix AutomÃ¡tico**, com foco no **contexto do usuÃ¡rio recebedor**.

Cada jornada Ã© descrita com **cenÃ¡rios realistas, passo a passo**, destacando as **aÃ§Ãµes do recebedor**, as **interaÃ§Ãµes com o PSP recebedor**, as **responsabilidades operacionais**, os **fluxos de sucesso e falha**, e as **melhores prÃ¡ticas** para implementaÃ§Ã£o.

Este documento Ã© uma **referÃªncia estratÃ©gica e operacional** para recebedores (pessoas jurÃ­dicas, prestadores de serviÃ§os, empresas de cobranÃ§a), seus gestores financeiros e equipes de tecnologia.

---

# ğŸ“˜ **Jornadas do Pix AutomÃ¡tico: VisÃ£o do Recebedor**

> **Baseado no Guia de ImplementaÃ§Ã£o do Pix AutomÃ¡tico â€“ VersÃ£o 1.2**  
> **Foco: AÃ§Ãµes, decisÃµes e responsabilidades do usuÃ¡rio recebedor**

---

## ğŸ” **1. IntroduÃ§Ã£o: O Papel do Recebedor no Pix AutomÃ¡tico**

O **usuÃ¡rio recebedor** Ã© o **iniciador do processo** de recorrÃªncia. Ele define os termos da cobranÃ§a, escolhe a jornada de autorizaÃ§Ã£o mais adequada ao seu modelo de negÃ³cio e interage com seu **PSP recebedor** (seu banco ou instituiÃ§Ã£o de pagamento) para criar, gerir e acompanhar as recorrÃªncias.

O recebedor pode:
- Ofertar o Pix AutomÃ¡tico como forma de pagamento.
- Escolher entre **4 jornadas de autorizaÃ§Ã£o**.
- Gerir recorrÃªncias via **API Pix** ou **arquivo padronizado**.
- Reutilizar QR Codes.
- Oferecer autorizaÃ§Ã£o apÃ³s um pagamento inicial.
- Cancelar cobranÃ§as agendadas (com restriÃ§Ãµes).
- Receber notificaÃ§Ãµes de sucesso, falha e cancelamento.

Este guia detalha cada jornada sob a **perspectiva do recebedor**, com **cenÃ¡rios completos**, **fluxos operacionais** e **recomendaÃ§Ãµes prÃ¡ticas**.

---

## ğŸŸ¦ **Jornada 1: AutorizaÃ§Ã£o sem QR Code, com notificaÃ§Ã£o via app**

### **Contexto**
O usuÃ¡rio pagador entra em contato diretamente com o recebedor (por WhatsApp, ligaÃ§Ã£o, e-mail) e informa que deseja pagar por **Pix AutomÃ¡tico**.

Esta jornada Ã© ideal para:
- Relacionamentos B2B com poucos clientes.
- CobranÃ§as de alto valor.
- Empresas com atendimento personalizado.
- Casos em que o pagador jÃ¡ confia na empresa.

---

### **CenÃ¡rio 1.1: CriaÃ§Ã£o e envio da solicitaÃ§Ã£o de autorizaÃ§Ã£o**

**Como** recebedor de uma academia premium,  
**Quero** solicitar autorizaÃ§Ã£o de Pix AutomÃ¡tico a um novo aluno via notificaÃ§Ã£o no app,  
**Para que** ele possa confirmar a mensalidade recorrente sem precisar escanear QR Code.

#### **Passo a Passo:**

1. **Acesso ao sistema do PSP recebedor**
   - O responsÃ¡vel financeiro da academia acessa a plataforma do PSP (ex: internet banking corporativo ou painel de cobranÃ§a).

2. **CriaÃ§Ã£o da recorrÃªncia**
   - Informa os dados:
     - `idRecorrencia`: `RR123456782025030100001`
     - `formaDeIniciacao`: `AUTO`
     - `valor`: `299,90` (fixo)
     - `periodicidade`: `MENSAL`
     - `dataInicio`: `2025-04-15`
     - `dataFim`: `2026-04-15`
     - `descricao`: "Mensalidade Academia Premium"
     - `idObjetoCobranca`: `ACAD12345`
     - `politicaRetentativa`: `S` (permite retentativas pÃ³s-vencimento)
   - Define `dataExpiracaoSolicitacao`: `2025-04-10` (5 dias antes do primeiro pagamento).

3. **Envio da solicitaÃ§Ã£o**
   - Clica em â€œEnviar para autorizaÃ§Ã£oâ€.
   - O PSP recebedor valida os dados e envia uma mensagem `pain.009` ao **PSP pagador** do aluno.

4. **NotificaÃ§Ã£o ao pagador**
   - O PSP pagador recebe a `pain.009`.
   - Notifica o aluno no app:  
     > â€œVocÃª foi convidado a autorizar um pagamento recorrente de R$299,90/mÃªs para Academia Premium. Deseja confirmar?â€

5. **ConfirmaÃ§Ã£o pelo pagador**
   - O aluno abre o app, confirma com biometria e autoriza.

6. **Retorno ao recebedor**
   - O PSP pagador envia `pain.012` com `status = true`.
   - O PSP recebedor atualiza o status da recorrÃªncia para **â€œconfirmadaâ€**.
   - O sistema da academia Ã© notificado:  
     > â€œAutorizaÃ§Ã£o de Pix AutomÃ¡tico confirmada para o aluno ACAD12345.â€

7. **Agendamento**
   - Em `2025-04-05` (10 dias antes), o PSP recebedor envia `pain.013` com `idFimAFim = 20250415`.
   - O dÃ©bito serÃ¡ liquidado entre 0h e 8h do dia 15/04.

#### **Boas PrÃ¡ticas para o Recebedor:**
- Defina `dataExpiracaoSolicitacao` com antecedÃªncia suficiente.
- Monitore o status da recorrÃªncia (â€œpendenteâ€ â†’ â€œconfirmadaâ€).
- Se o pagador nÃ£o confirmar, vocÃª pode reenviar a solicitaÃ§Ã£o com nova `dataExpiracao`.

---

### **CenÃ¡rio 1.2: Falha na autorizaÃ§Ã£o**

**Como** recebedor,  
**Quero** saber o que fazer se o pagador nÃ£o confirmar a autorizaÃ§Ã£o,  
**Para que** eu possa tomar uma aÃ§Ã£o alternativa.

#### **Fluxo:**
- O PSP pagador **nÃ£o envia `pain.012`**.
- A recorrÃªncia permanece em **â€œpendente de confirmaÃ§Ã£oâ€**.
- ApÃ³s `2025-04-10`, a solicitaÃ§Ã£o expira.
- O sistema do PSP recebedor notifica:  
  > â€œSolicitaÃ§Ã£o de autorizaÃ§Ã£o expirada. RecorrÃªncia RR123456782025030100001 nÃ£o foi confirmada.â€

#### **AÃ§Ãµes do Recebedor:**
1. Contatar o pagador por outro canal.
2. Tentar novamente com nova `dataExpiracao`.
3. Oferecer outra jornada (ex: Jornada 4 apÃ³s prÃ³ximo pagamento).

---

## ğŸŸ¨ **Jornada 2: AutorizaÃ§Ã£o com QR Code contendo apenas os dados da recorrÃªncia**

### **Contexto**
O recebedor disponibiliza um **QR Code fixo** (impresso ou digital) que aponta apenas para os dados da recorrÃªncia.

Ideal para:
- Academias, clÃ­nicas, assinaturas fÃ­sicas.
- ReutilizaÃ§Ã£o de QR Codes.
- Ambientes com mÃºltiplos pagadores (ex: recepÃ§Ã£o).

---

### **CenÃ¡rio 2.1: ReutilizaÃ§Ã£o de QR Code em academia**

**Como** recebedor de uma academia com 500 alunos,  
**Quero** usar um Ãºnico QR Code impresso na recepÃ§Ã£o para todos os novos alunos,  
**Para que** cada um possa autorizar sua mensalidade recorrente.

#### **Passo a Passo:**

1. **CriaÃ§Ã£o da recorrÃªncia**
   - O PSP recebedor cria uma recorrÃªncia com:
     - `idRecorrencia`: `RR234567892025030100002`
     - `valor`: `299,90`
     - `periodicidade`: `MENSAL`
     - `dataInicio`: `2025-04-01`
     - `dataFim`: `2026-04-01`
     - `descricao`: "Mensalidade Academia"
     - `idObjetoCobranca`: `NOVO_ALUNO`
   - Gera um `location` (ex: `https://pix.bcb.gov.br/api/v2/rec/RR234567892025030100002`).

2. **GeraÃ§Ã£o do QR Code**
   - O sistema gera um QR Code com:
     - **Faixa 26-51**: preenchida (marcaÃ§Ã£o de ausÃªncia de cobranÃ§a imediata).
     - **Faixa 80-99**: `location` da recorrÃªncia.
   - Imprime o QR Code e o coloca na recepÃ§Ã£o.

3. **Aluno lÃª o QR Code**
   - O novo aluno abre o app do banco e lÃª o QR Code.
   - O app acessa `GET /pix/v2/rec/RR234567892025030100002`.
   - Exibe:  
     > â€œAutorizar pagamento recorrente de R$299,90/mÃªs para Academia XYZ?â€

4. **ConfirmaÃ§Ã£o**
   - O aluno confirma com senha.
   - O PSP pagador envia `pain.012` com `status = true`.

5. **AtualizaÃ§Ã£o no sistema do recebedor**
   - O PSP recebedor atualiza o status para **â€œconfirmadaâ€**.
   - O sistema da academia recebe a notificaÃ§Ã£o.
   - O funcionÃ¡rio altera o `idObjetoCobranca` para o cÃ³digo do aluno (ex: `ALUNO789`).

6. **ReutilizaÃ§Ã£o**
   - O **mesmo QR Code** continua vÃ¡lido.
   - O prÃ³ximo aluno lÃª, confirma, e o processo se repete.

#### **Boas PrÃ¡ticas para o Recebedor:**
- Use QR Codes com **faixa 26-51 preenchida** para compatibilidade.
- Atualize o `idObjetoCobranca` apÃ³s cada confirmaÃ§Ã£o.
- NÃ£o envie `pain.009` â€” a autorizaÃ§Ã£o Ã© iniciada pelo QR Code.

---

### **CenÃ¡rio 2.2: QR Code com dados invÃ¡lidos**

**Como** recebedor,  
**Quero** saber o que acontece se o QR Code estiver corrompido,  
**Para que** eu possa corrigir rapidamente.

#### **Fluxo:**
- O aluno lÃª o QR Code.
- O app tenta acessar `GET /rec/{txid}`.
- Retorna erro 404 (recorrÃªncia nÃ£o encontrada).
- O app exibe: â€œNÃ£o foi possÃ­vel carregar os dados da recorrÃªncia.â€
- **Nenhuma `pain.012` Ã© enviada.**
- O recebedor **nÃ£o Ã© notificado**.

#### **AÃ§Ã£o do Recebedor:**
- Verificar se a recorrÃªncia ainda estÃ¡ ativa.
- Regerar o `location` e o QR Code se necessÃ¡rio.

---

## ğŸŸ¥ **Jornada 3: AutorizaÃ§Ã£o com QR Code contendo pagamento imediato + recorrÃªncia**

### **Contexto**
O recebedor oferece um **QR Code composto** que inclui:
- Uma **cobranÃ§a imediata** (primeiro pagamento).
- Uma **recorrÃªncia** (pagamentos futuros).

A aceitaÃ§Ã£o do pagamento imediato **implica automaticamente** na autorizaÃ§Ã£o do Pix AutomÃ¡tico.

Ideal para:
- Assinaturas digitais.
- Vendas online.
- ServiÃ§os com entrada + mensalidades.

---

### **CenÃ¡rio 3.1: Assinatura de streaming com entrada**

**Como** recebedor de uma plataforma de streaming,  
**Quero** que o cliente pague a primeira mensalidade e autorize automaticamente as futuras,  
**Para que** o processo seja rÃ¡pido e seguro.

#### **Passo a Passo:**

1. **CriaÃ§Ã£o da cobranÃ§a imediata e recorrÃªncia**
   - Cria cobranÃ§a imediata:
     - `txid`: `TXID123`
     - `valor`: `29,90`
     - `location`: `https://pix.bcb.gov.br/api/v2/cobv/TXID123`
   - Cria recorrÃªncia:
     - `idRecorrencia`: `RR345678902025030100003`
     - `valor`: `29,90`
     - `periodicidade`: `MENSAL`
     - `dataInicio`: `2025-05-01`
     - `location`: `https://pix.bcb.gov.br/api/v2/rec/RR345678902025030100003`

2. **GeraÃ§Ã£o do QR Code composto**
   - QR Code com:
     - **Faixa 26-51**: `location` da cobranÃ§a imediata.
     - **Faixa 80-99**: `location` da recorrÃªncia.

3. **Cliente lÃª o QR Code**
   - App acessa ambos os `locations`.
   - Exibe:
     - Pagamento imediato: R$29,90
     - Checkbox: â€œAutorizar Pix AutomÃ¡tico para prÃ³ximas mensalidades? [âœ“]â€
   - **NÃ£o Ã© possÃ­vel desmarcar.**

4. **ConfirmaÃ§Ã£o**
   - Cliente confirma.
   - PSP pagador inicia o pagamento imediato (`pacs.008`).
   - ApÃ³s sucesso, envia `pain.012` com `status = true`.

5. **NotificaÃ§Ã£o ao recebedor**
   - Recebe confirmaÃ§Ã£o da autorizaÃ§Ã£o.
   - Ativa a assinatura.
   - AgendarÃ¡ o prÃ³ximo dÃ©bito em `2025-05-01`.

#### **Regras CrÃ­ticas:**
- **NÃ£o pode haver dissociaÃ§Ã£o** entre pagamento e autorizaÃ§Ã£o.
- Se o pagamento falhar, **nÃ£o hÃ¡ autorizaÃ§Ã£o**.
- O pagamento imediato aparece como **Pix normal** no extrato.

---

### **CenÃ¡rio 3.2: Falha no pagamento imediato**

**Como** recebedor,  
**Quero** entender o impacto de uma falha no pagamento inicial,  
**Para que** eu saiba que nÃ£o haverÃ¡ autorizaÃ§Ã£o.

#### **Fluxo:**
- Cliente confirma.
- Pagamento imediato falha por saldo insuficiente.
- PSP pagador **nÃ£o envia `pain.012`**.
- RecorrÃªncia permanece nÃ£o autorizada.
- Recebedor nÃ£o Ã© notificado de autorizaÃ§Ã£o.

#### **AÃ§Ã£o do Recebedor:**
- Oferecer outra forma de pagamento.
- Tentar novamente com novo QR Code.

---

## ğŸŸ§ **Jornada 4: AutorizaÃ§Ã£o apÃ³s pagamento/agendamento com vencimento**

### **Contexto**
O recebedor oferece o Pix AutomÃ¡tico **apÃ³s** o cliente pagar ou agendar uma cobranÃ§a com vencimento.

A autorizaÃ§Ã£o Ã© **opcional** e ocorre **apÃ³s o pagamento inicial**.

Ideal para:
- Faturas de energia, Ã¡gua, boletos.
- Clientes que jÃ¡ pagam manualmente.
- MigraÃ§Ã£o de pagadores para automÃ¡tico.

---

### **CenÃ¡rio 4.1: Oferta pÃ³s-pagamento de fatura de energia**

**Como** recebedor de uma concessionÃ¡ria de energia,  
**Quero** oferecer Pix AutomÃ¡tico apÃ³s o cliente pagar a fatura,  
**Para que** ele nÃ£o precise mais se preocupar com vencimentos.

#### **Passo a Passo:**

1. **GeraÃ§Ã£o do QR Code composto**
   - CobranÃ§a com vencimento:
     - `txid`: `FAT123`
     - `valor`: `150,00`
     - `dataDeVencimento`: `2025-04-10`
     - `location`: `https://pix.bcb.gov.br/api/v2/cobv/FAT123`
   - RecorrÃªncia:
     - `idRecorrencia`: `RR456789012025030100004`
     - `valor`: `150,00` (mÃ©dio)
     - `periodicidade`: `MENSAL`
     - `location`: `https://pix.bcb.gov.br/api/v2/rec/RR456789012025030100004`

2. **Cliente paga a fatura**
   - LÃª o QR Code.
   - Paga R$150,00 via Pix (com vencimento ou nÃ£o).

3. **Oferta de Pix AutomÃ¡tico**
   - ApÃ³s o pagamento, o app do PSP pagador exibe:
     > â€œQuer autorizar pagamentos automÃ¡ticos mensais de atÃ© R$150,00 para Energia S.A.? [Sim] [NÃ£o]â€

4. **AceitaÃ§Ã£o**
   - Cliente clica em â€œSimâ€.
   - PSP pagador envia `pain.012` com `status = true`.

5. **AtivaÃ§Ã£o**
   - PSP recebedor confirma.
   - PrÃ³xima fatura serÃ¡ debitada automaticamente em `2025-05-10`.

#### **Regras:**
- A oferta **sÃ³ Ã© feita apÃ³s o pagamento bem-sucedido**.
- Se o pagamento falhar, **nÃ£o hÃ¡ oferta**.
- O cliente pode **recusar** a autorizaÃ§Ã£o.

---

### **CenÃ¡rio 4.2: Cliente recusa a oferta**

**Como** recebedor,  
**Quero** saber o que acontece se o cliente recusar,  
**Para que** eu possa continuar ofertando manualmente.

#### **Fluxo:**
- Cliente clica em â€œNÃ£oâ€.
- PSP pagador **nÃ£o envia `pain.012`**.
- RecorrÃªncia **nÃ£o Ã© autorizada**.
- Recebedor **nÃ£o Ã© notificado**.

#### **AÃ§Ã£o do Recebedor:**
- Continuar ofertando via Jornada 1 ou 2.
- Enviar e-mail com QR Code da Jornada 2.

---

## ğŸ”„ **5. GestÃ£o ContÃ­nua da RecorrÃªncia (todas as jornadas)**

### **AlteraÃ§Ãµes na RecorrÃªncia**
- **Antes da confirmaÃ§Ã£o**: Pode alterar `valor`, `periodicidade`, `dataInicio`.
- **ApÃ³s a confirmaÃ§Ã£o**: **NÃ£o pode alterar**. Deve:
  1. Cancelar a recorrÃªncia.
  2. Criar uma nova.
  3. Solicitar nova autorizaÃ§Ã£o.

### **Cancelamento**
- **Pelo pagador**: A qualquer momento (atÃ© vÃ©spera da liquidaÃ§Ã£o).
- **Pelo recebedor**: Pode cancelar cobranÃ§a agendada, **mas nÃ£o apÃ³s 22h do dia anterior**.

### **Retentativas**
- **RIFL**: Nova tentativa intradiÃ¡ria (atÃ© 23h59).
- **NTAG**: Nova tentativa pÃ³s-vencimento (se `politicaRetentativa = S`).
  - **Pagador nÃ£o pode cancelar** agendamentos com `NTAG`.

---

## ğŸ“¢ **6. NotificaÃ§Ãµes ObrigatÃ³rias para o Recebedor**

O PSP recebedor **deve informar** o recebedor em:

| SituaÃ§Ã£o | NotificaÃ§Ã£o |
|--------|-------------|
| Sucesso do agendamento | â€œDÃ©bito agendado para 15/04â€ |
| Falha no agendamento | â€œValor divergente. DÃ©bito nÃ£o agendado.â€ |
| Cancelamento pelo pagador | â€œAutorizaÃ§Ã£o cancelada pelo pagadorâ€ |
| Sucesso no cancelamento da cobranÃ§a | â€œCobranÃ§a cancelada com sucessoâ€ |
| Falha no cancelamento da cobranÃ§a | â€œCancelamento nÃ£o permitido apÃ³s 22hâ€ |

---

## ğŸ“Œ **7. Boas PrÃ¡ticas para o Recebedor**

1. **Escolha a jornada certa**:
   - Jornada 1: Relacionamento direto.
   - Jornada 2: ReutilizaÃ§Ã£o de QR Code.
   - Jornada 3: Entrada + recorrÃªncia.
   - Jornada 4: MigraÃ§Ã£o de pagadores.

2. **Use API Pix ou arquivo padronizado** para escalar.

3. **Monitore o status** das recorrÃªncias: â€œcriadaâ€, â€œpendenteâ€, â€œconfirmadaâ€.

4. **Defina `dataFim` com margem** para retentativas.

5. **Ajuste para dia Ãºtil** com base no `codMunIBGE` do pagador.

6. **NÃ£o cobre tarifa do pagador** â€“ Ã© vedado.

7. **OfereÃ§a suporte** para cancelamento e dÃºvidas.

---

## ğŸ **ConclusÃ£o**

O **recebedor Ã© o protagonista** do Pix AutomÃ¡tico. Ele define o modelo de negÃ³cio, escolhe a jornada, cria as recorrÃªncias e gerencia o relacionamento com o pagador.

As **quatro jornadas** oferecem flexibilidade para diferentes cenÃ¡rios:
- **Jornada 1**: Relacionamento direto e personalizado.
- **Jornada 2**: Escalabilidade com QR Code reutilizÃ¡vel.
- **Jornada 3**: ConversÃ£o imediata com pagamento inicial.
- **Jornada 4**: MigraÃ§Ã£o suave de pagadores manuais.

Com as boas prÃ¡ticas acima, o recebedor pode **automatizar cobranÃ§as**, **reduzir inadimplÃªncia** e **melhorar a experiÃªncia do cliente**.

---

Se desejar, posso gerar:
- Um **modelo de checklist operacional** para recebedores
- Um **fluxograma em portuguÃªs** das jornadas
- Um **template de e-mail** para ofertar Pix AutomÃ¡tico
- Um **relatÃ³rio de impacto financeiro** por jornada

Deseja algum desses artefatos?
